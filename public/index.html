<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GYNEVA — Business Plan Interactif</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--p:#0f2b46;--pl:#1a4a7a;--acc:#00b894;--acc2:#00cec9;--warn:#fdcb6e;--danger:#d63031;--bg:#f0f3f8;--card:#fff;--txt:#2d3436;--txtL:#636e72;--brd:#dfe6e9;--sh:0 2px 16px rgba(0,0,0,.06);--r:14px;--trans:all .25s cubic-bezier(.4,0,.2,1)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--txt);line-height:1.6;-webkit-font-smoothing:antialiased}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

/* === SIDEBAR === */
.layout{display:flex;min-height:100vh}
.sidebar{width:260px;background:linear-gradient(180deg,var(--p) 0%,#0a1f33 100%);color:#fff;padding:0;position:fixed;top:0;left:0;bottom:0;z-index:200;display:flex;flex-direction:column;transition:var(--trans);overflow:hidden}
.sidebar.collapsed{width:64px}
.sidebar .logo{padding:1.5rem 1.2rem;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:.8rem}
.sidebar .logo h1{font-size:1.15rem;font-weight:700;letter-spacing:-.3px;white-space:nowrap}
.sidebar .logo .dot{width:10px;height:10px;border-radius:50%;background:var(--acc);flex-shrink:0}
.sidebar .logo-sub{font-size:.65rem;opacity:.5;margin-top:2px;white-space:nowrap}
.sidebar nav{flex:1;padding:.8rem 0}
.sidebar nav button{width:100%;background:none;border:none;color:rgba(255,255,255,.6);padding:.7rem 1.2rem;text-align:left;cursor:pointer;font-size:.82rem;font-weight:500;display:flex;align-items:center;gap:.7rem;transition:var(--trans);white-space:nowrap;border-left:3px solid transparent}
.sidebar nav button:hover{color:#fff;background:rgba(255,255,255,.06)}
.sidebar nav button.active{color:#fff;background:rgba(0,184,148,.1);border-left-color:var(--acc)}
.sidebar nav button .nav-icon{font-size:1.1rem;width:24px;text-align:center;flex-shrink:0}
.sidebar nav button .nav-label{overflow:hidden}
.sidebar .sidebar-footer{padding:1rem 1.2rem;border-top:1px solid rgba(255,255,255,.08);font-size:.7rem;opacity:.4;white-space:nowrap}
.toggle-btn{position:absolute;top:1.5rem;right:-14px;width:28px;height:28px;border-radius:50%;background:var(--pl);border:2px solid var(--bg);color:#fff;cursor:pointer;font-size:.75rem;display:flex;align-items:center;justify-content:center;z-index:201;transition:var(--trans)}
.toggle-btn:hover{background:var(--acc)}

/* === MAIN === */
.main-area{margin-left:260px;transition:var(--trans);flex:1;min-width:0}
.sidebar.collapsed ~ .main-area{margin-left:64px}

/* === TOP BAR === */
.topbar{background:var(--card);border-bottom:1px solid var(--brd);padding:.8rem 2rem;display:flex;align-items:center;gap:1rem;position:sticky;top:0;z-index:100;box-shadow:0 1px 8px rgba(0,0,0,.04)}
.topbar .page-title{font-size:1.05rem;font-weight:700;color:var(--p)}
.topbar .spacer{flex:1}
.status-pill{display:flex;align-items:center;gap:.4rem;font-size:.75rem;padding:.3rem .8rem;border-radius:20px;font-weight:500}
.status-pill.live{background:rgba(0,184,148,.1);color:#00b894}.status-pill.static{background:rgba(253,203,110,.15);color:#d68910}
.status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.status-dot.live{background:var(--acc);animation:pulse 2s infinite}.status-dot.static{background:var(--warn)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.btn{padding:.45rem 1rem;border-radius:8px;border:1px solid var(--brd);background:var(--card);color:var(--txt);font-size:.8rem;font-weight:500;cursor:pointer;transition:var(--trans);display:flex;align-items:center;gap:.4rem}
.btn:hover{border-color:var(--pl);color:var(--pl)}
.btn.primary{background:var(--pl);color:#fff;border-color:var(--pl)}.btn.primary:hover{background:var(--p)}

/* === CONTENT === */
.content{padding:1.8rem 2rem;max-width:1200px;margin:0 auto}
.section{display:none;animation:fadeIn .3s ease}.section.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* === CARDS === */
.card{background:var(--card);border-radius:var(--r);box-shadow:var(--sh);padding:1.5rem;margin-bottom:1.2rem;border:1px solid var(--brd);transition:var(--trans)}
.card:hover{box-shadow:0 4px 24px rgba(0,0,0,.08)}
.card h2{font-size:.95rem;color:var(--p);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;font-weight:700}
.card h2 .ic{font-size:1.15rem}
.card h3{font-size:.85rem;color:var(--p);margin-bottom:.6rem;font-weight:600}

/* === KPI === */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.9rem;margin-bottom:1.2rem}
.kpi{background:var(--card);border-radius:var(--r);padding:1.2rem;border:1px solid var(--brd);box-shadow:var(--sh);transition:var(--trans);position:relative;overflow:hidden}
.kpi:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.08)}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--r) var(--r) 0 0}
.kpi.green::before{background:var(--acc)}.kpi.orange::before{background:var(--warn)}.kpi.red::before{background:var(--danger)}.kpi.blue::before{background:var(--pl)}
.kpi .lb{font-size:.7rem;color:var(--txtL);text-transform:uppercase;letter-spacing:.6px;font-weight:600}
.kpi .vl{font-size:1.6rem;font-weight:800;color:var(--p);margin:.4rem 0 .1rem}
.kpi .sb{font-size:.73rem;color:var(--txtL)}
.kpi.green .vl{color:var(--acc)}.kpi.orange .vl{color:#e17055}.kpi.red .vl{color:var(--danger)}

/* === VERDICT === */
.verdict{border-radius:var(--r);padding:1.2rem 1.4rem;margin-bottom:1.2rem;display:flex;align-items:flex-start;gap:.9rem;font-size:.88rem;line-height:1.6}
.verdict .ic{font-size:1.6rem;flex-shrink:0}.verdict strong{font-weight:700}
.verdict.green{background:rgba(0,184,148,.08);border:1px solid rgba(0,184,148,.2);color:#00755a}
.verdict.orange{background:rgba(253,203,110,.12);border:1px solid rgba(253,203,110,.3);color:#7d5a12}
.verdict.red{background:rgba(214,48,49,.08);border:1px solid rgba(214,48,49,.2);color:#8b2020}

/* === CHARTS === */
.chart-box{position:relative;height:300px;margin:.5rem 0}.chart-box.sm{height:240px}

/* === REVENUE PROFILE FILTERS === */
.rev-profile-bar{display:flex;gap:.4rem;margin-bottom:1rem;flex-wrap:wrap}
.rev-prof{padding:.45rem .9rem;border-radius:20px;border:2px solid var(--brd);background:var(--card);font-size:.78rem;font-weight:600;cursor:pointer;transition:var(--trans);display:flex;align-items:center;gap:.4rem}
.rev-prof:hover{border-color:var(--pl);background:rgba(26,74,122,.04)}
.rev-prof .prof-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.rev-prof.active{color:#fff;border-color:transparent}
.rev-prof[data-prof="all"].active{background:var(--pl);color:#fff}
.rev-prof[data-prof="assoc"].active{background:#0f2b46}
.rev-prof[data-prof="indep"].active{background:#1a4a7a}
.rev-prof[data-prof="interne"].active{background:#5dade2;color:#0f2b46}
.rev-prof[data-prof="sage"].active{background:#aed6f1;color:#0f2b46}
.rev-detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.9rem;margin-bottom:1.2rem}
.rev-prof-card{background:var(--card);border-radius:var(--r);padding:1.2rem;border:1px solid var(--brd);box-shadow:var(--sh);border-left:4px solid var(--pl)}
.rev-prof-card.assoc{border-left-color:#0f2b46}
.rev-prof-card.indep{border-left-color:#1a4a7a}
.rev-prof-card.interne{border-left-color:#5dade2}
.rev-prof-card.sage{border-left-color:#aed6f1}
.rev-prof-card h4{font-size:.82rem;font-weight:700;color:var(--p);margin-bottom:.6rem}
.rev-prof-card .prof-kpis{display:flex;flex-direction:column;gap:.35rem}
.rev-prof-card .prof-kpi{display:flex;justify-content:space-between;font-size:.78rem}
.rev-prof-card .prof-kpi .pk-label{color:var(--txtL)}
.rev-prof-card .prof-kpi .pk-value{font-weight:700;color:var(--p)}
.rev-prof-card .prof-ramp{margin-top:.6rem;font-size:.72rem;color:var(--txtL);font-style:italic}

/* === TABLES === */
table.dt{width:100%;border-collapse:separate;border-spacing:0;font-size:.82rem}
table.dt th{background:#f8fafb;padding:.65rem .9rem;text-align:left;font-weight:600;color:var(--p);border-bottom:2px solid var(--brd);white-space:nowrap}
table.dt td{padding:.55rem .9rem;border-bottom:1px solid #f0f3f5}
table.dt tr:hover td{background:#f8fafb}
.num{text-align:right;font-variant-numeric:tabular-nums}

/* === BADGES === */
.badge{display:inline-block;padding:.15rem .6rem;border-radius:10px;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.badge.critique{background:#fdeaea;color:#c0392b}.badge.important{background:#fef5e7;color:#d68910}
.badge.moyen{background:#eaf2f8;color:#2e86c1}.badge.faible{background:#e8f8f0;color:#27ae60}
.badge.eleve{background:#fdeaea;color:#c0392b}.badge.tres-eleve{background:#c0392b;color:#fff}

/* === PILLS === */
.pills{display:flex;flex-wrap:wrap;gap:.4rem;margin:.5rem 0}
.pill{background:rgba(26,74,122,.06);border-radius:20px;padding:.35rem .85rem;font-size:.78rem;color:var(--p);font-weight:500;border:1px solid rgba(26,74,122,.1)}
.pill b{font-weight:700}

/* === EXPLAINER === */
.exp{background:#f8fafb;border-radius:10px;padding:.9rem 1.1rem;font-size:.84rem;line-height:1.6;color:#4a6785;margin:.8rem 0;border-left:3px solid var(--pl)}
.exp strong{color:var(--p)}

/* === SCENARIO CARDS === */
.sc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.9rem;margin:1rem 0}
.sc-card{border-radius:var(--r);padding:1.1rem;border:2px solid var(--brd);transition:var(--trans);background:var(--card)}
.sc-card:hover{border-color:var(--pl)}.sc-card.rec{border-color:var(--acc);background:rgba(0,184,148,.03)}
.sc-card h3{font-size:.82rem;margin-bottom:.4rem;display:flex;align-items:center;gap:.4rem}
.sc-card .bn{font-size:1.4rem;font-weight:800}.sc-card .dt{font-size:.76rem;color:var(--txtL);margin-top:.2rem}

/* === PROFIT TIMELINE === */
.profit-tl{display:flex;gap:0;margin:1rem 0;border-radius:var(--r);overflow:hidden;border:1px solid var(--brd)}
.profit-yr{flex:1;padding:1rem;text-align:center;border-right:1px solid var(--brd);background:var(--card)}
.profit-yr:last-child{border-right:none}
.profit-yr .yl{font-size:.7rem;color:var(--txtL);text-transform:uppercase;font-weight:600;letter-spacing:.5px}
.profit-yr .am{font-size:1.3rem;font-weight:800;color:var(--p);margin:.3rem 0}
.profit-yr .pa{font-size:.82rem;color:var(--acc);font-weight:600}
.profit-yr .nt{font-size:.72rem;color:var(--txtL)}

/* === DROPZONE === */
.dropzone{border:2px dashed var(--pl);border-radius:var(--r);padding:2rem;text-align:center;margin-bottom:1.2rem;background:rgba(26,74,122,.02);transition:var(--trans);cursor:pointer;position:relative}
.dropzone:hover,.dropzone.over{background:rgba(26,74,122,.06);border-color:var(--acc)}
.dropzone .dz-icon{font-size:2.2rem;margin-bottom:.4rem}.dropzone .dz-text{font-size:.9rem;color:var(--p);font-weight:600}
.dropzone .dz-sub{font-size:.78rem;color:var(--txtL);margin-top:.3rem}
.dropzone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.dropzone.loaded{border-color:var(--acc);background:rgba(0,184,148,.04);border-style:solid}

/* === IMPORT SUMMARY === */
.import-summary{background:var(--card);border:1px solid var(--brd);border-radius:var(--r);padding:1.2rem 1.4rem;margin-bottom:1.2rem;display:none;animation:fadeIn .3s ease}
.import-summary.show{display:block}
.import-summary h3{font-size:.85rem;color:var(--p);font-weight:700;margin-bottom:.8rem;display:flex;align-items:center;gap:.5rem}
.import-summary .no-change{font-size:.84rem;color:var(--txtL);padding:.5rem 0}
.diff-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.6rem}
.diff-item{display:flex;justify-content:space-between;align-items:center;padding:.5rem .7rem;border-radius:8px;background:#f8fafb;font-size:.8rem}
.diff-item .diff-label{color:var(--txtL);font-weight:500}
.diff-item .diff-values{display:flex;align-items:center;gap:.4rem;font-variant-numeric:tabular-nums}
.diff-item .diff-old{color:var(--txtL);text-decoration:line-through;font-size:.75rem}
.diff-item .diff-new{color:var(--p);font-weight:700}
.diff-item .diff-arrow{color:var(--txtL);font-size:.7rem}
.diff-pct{font-size:.68rem;font-weight:600;padding:.1rem .45rem;border-radius:10px;margin-left:.3rem}
.diff-pct.up{background:rgba(0,184,148,.1);color:#00b894}
.diff-pct.down{background:rgba(214,48,49,.1);color:var(--danger)}
.import-warnings{margin-top:.8rem;padding:.6rem .8rem;background:rgba(253,203,110,.1);border:1px solid rgba(253,203,110,.25);border-radius:8px;font-size:.78rem;color:#7d5a12}
.import-warnings li{margin:.2rem 0;list-style:none;padding-left:1rem;position:relative}
.import-warnings li::before{content:'\26A0';position:absolute;left:0}

/* === VERSION PANEL === */
.version-panel{position:fixed;top:0;right:-420px;width:400px;height:100vh;background:var(--card);border-left:1px solid var(--brd);box-shadow:-4px 0 24px rgba(0,0,0,.08);z-index:300;transition:right .3s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column}
.version-panel.open{right:0}
.version-panel .vp-header{padding:1.2rem 1.4rem;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between}
.version-panel .vp-header h3{font-size:.95rem;font-weight:700;color:var(--p)}
.version-panel .vp-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--txtL);padding:.3rem}
.version-panel .vp-close:hover{color:var(--p)}
.version-panel .vp-list{flex:1;overflow-y:auto;padding:.8rem}
.version-panel .vp-empty{text-align:center;color:var(--txtL);font-size:.84rem;padding:2rem 1rem}
.version-item{padding:.8rem 1rem;border:1px solid var(--brd);border-radius:10px;margin-bottom:.6rem;transition:var(--trans)}
.version-item:hover{border-color:var(--pl);background:#f8fafb}
.version-item .vi-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem}
.version-item .vi-num{font-size:.75rem;font-weight:700;color:var(--pl);background:rgba(26,74,122,.06);padding:.15rem .5rem;border-radius:8px}
.version-item .vi-date{font-size:.72rem;color:var(--txtL)}
.version-item .vi-label{font-size:.82rem;color:var(--p);font-weight:500}
.version-item .vi-restore{margin-top:.5rem;background:none;border:1px solid var(--pl);color:var(--pl);padding:.3rem .7rem;border-radius:8px;font-size:.73rem;font-weight:500;cursor:pointer;transition:var(--trans)}
.version-item .vi-restore:hover{background:var(--pl);color:#fff}
.version-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.2);z-index:299}
.version-overlay.show{display:block}

/* === PLAN SWITCHER === */
.plan-switcher{position:relative;display:flex;align-items:center;margin-left:.8rem}
.plan-name{background:none;border:1px solid var(--brd);color:var(--p);padding:.35rem .8rem;border-radius:8px;font-size:.82rem;font-weight:600;cursor:pointer;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;transition:var(--trans);display:flex;align-items:center;gap:.4rem}
.plan-name:hover{border-color:var(--pl);color:var(--pl)}
.plan-name::after{content:'\25BC';font-size:.55rem;opacity:.5}
.plan-dropdown{display:none;position:absolute;top:calc(100% + 6px);left:0;min-width:300px;max-height:400px;overflow-y:auto;background:var(--card);border:1px solid var(--brd);border-radius:var(--r);box-shadow:0 8px 32px rgba(0,0,0,.12);z-index:150;padding:.4rem 0}
.plan-dropdown.show{display:block}
.pd-item{display:flex;align-items:center;padding:.6rem 1rem;cursor:pointer;transition:var(--trans);border-left:3px solid transparent;gap:.6rem}
.pd-item:hover{background:#f8fafb}
.pd-item.active{border-left-color:var(--acc);background:rgba(0,184,148,.04)}
.pd-item .pd-info{flex:1;min-width:0}
.pd-item .pd-plan-name{font-size:.82rem;font-weight:600;color:var(--p);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pd-item .pd-date{font-size:.7rem;color:var(--txtL)}
.pd-item .pd-actions{display:flex;gap:.3rem;opacity:0;transition:opacity .2s}
.pd-item:hover .pd-actions{opacity:1}
.pd-item .pd-btn{background:none;border:none;cursor:pointer;font-size:.72rem;color:var(--txtL);padding:.2rem .4rem;border-radius:4px;transition:var(--trans)}
.pd-item .pd-btn:hover{background:rgba(26,74,122,.08);color:var(--pl)}
.pd-item .pd-btn.del:hover{color:var(--danger);background:rgba(214,48,49,.06)}
.pd-footer{padding:.5rem 1rem;border-top:1px solid var(--brd)}
.pd-footer button{width:100%;background:none;border:1px dashed var(--brd);color:var(--pl);padding:.5rem;border-radius:8px;font-size:.8rem;font-weight:500;cursor:pointer;transition:var(--trans)}
.pd-footer button:hover{background:rgba(26,74,122,.04);border-color:var(--pl)}

/* === OVERLAY CONTROL === */
.overlay-control{display:flex;align-items:center;gap:.7rem;padding:.7rem 1.2rem;background:var(--card);border:1px solid var(--brd);border-radius:var(--r);margin-bottom:1.2rem;font-size:.82rem}
.overlay-control label{display:flex;align-items:center;gap:.4rem;font-weight:500;color:var(--p);white-space:nowrap}
.overlay-indicator{width:8px;height:8px;border-radius:50%;background:#ccc;flex-shrink:0;transition:var(--trans)}
.overlay-indicator.active{background:var(--acc);animation:pulse 2s infinite}
.overlay-control select{flex:1;padding:.35rem .6rem;border:1px solid var(--brd);border-radius:8px;font-size:.8rem;background:var(--card);cursor:pointer;max-width:260px}
.overlay-control button{background:none;border:1px solid var(--brd);padding:.3rem .6rem;border-radius:6px;font-size:.72rem;cursor:pointer;color:var(--txtL);transition:var(--trans)}
.overlay-control button:hover{border-color:var(--pl);color:var(--pl)}

/* === COMPARE MODAL === */
.compare-modal{display:none;position:fixed;inset:0;z-index:400;background:var(--bg);overflow-y:auto;padding:2rem}
.compare-modal.open{display:block}
.compare-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem}
.compare-header h2{font-size:1.1rem;font-weight:700;color:var(--p);display:flex;align-items:center;gap:.5rem}
.compare-header .close-btn{background:none;border:1px solid var(--brd);padding:.4rem .8rem;border-radius:8px;cursor:pointer;font-size:.85rem;color:var(--txtL);transition:var(--trans)}
.compare-header .close-btn:hover{border-color:var(--pl);color:var(--pl)}
.compare-selectors{display:flex;align-items:center;gap:.8rem;flex-wrap:wrap;margin-bottom:1.5rem;padding:1rem 1.2rem;background:var(--card);border:1px solid var(--brd);border-radius:var(--r)}
.compare-selectors select{padding:.4rem .7rem;border:1px solid var(--brd);border-radius:8px;font-size:.82rem;background:var(--card);min-width:200px}
.compare-selectors .vs-label{font-size:.85rem;font-weight:700;color:var(--txtL)}
.compare-grid{display:grid;grid-template-columns:1fr repeat(3,auto);gap:0;background:var(--card);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;margin-bottom:1.5rem}
.compare-grid .cg-head{background:#f8fafb;padding:.6rem 1rem;font-size:.75rem;font-weight:600;color:var(--p);text-transform:uppercase;letter-spacing:.4px;border-bottom:2px solid var(--brd)}
.compare-grid .cg-cell{padding:.55rem 1rem;font-size:.82rem;border-bottom:1px solid #f0f3f5;display:flex;align-items:center}
.compare-grid .cg-cell.label{font-weight:500;color:var(--p)}
.compare-grid .cg-cell.num{justify-content:flex-end;font-variant-numeric:tabular-nums}
.compare-grid .cg-cell .delta-badge{font-size:.7rem;font-weight:600;padding:.1rem .45rem;border-radius:8px;margin-left:.4rem}
.compare-grid .cg-cell .delta-badge.pos{background:rgba(0,184,148,.1);color:#00b894}
.compare-grid .cg-cell .delta-badge.neg{background:rgba(214,48,49,.1);color:var(--danger)}
.compare-grid .cg-cell .delta-badge.zero{background:rgba(99,110,114,.08);color:var(--txtL)}
.compare-charts{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;margin-bottom:1.5rem}
@media(max-width:900px){.compare-charts{grid-template-columns:1fr}}
.compare-charts .card{margin-bottom:0}
.compare-charts .chart-box{height:250px}
@media print{
  .compare-modal{position:static;padding:1rem;overflow:visible}
  .compare-selectors,.compare-header .close-btn,.compare-header button{display:none!important}
  .compare-charts{grid-template-columns:1fr 1fr}
  .compare-charts .chart-box{height:200px}
}

/* ===== SIMULATOR ===== */
.sim-layout{display:grid;grid-template-columns:340px 1fr;gap:1.5rem}
@media(max-width:900px){.sim-layout{grid-template-columns:1fr}}
.sim-panel{background:var(--card);border-radius:var(--r);border:1px solid var(--brd);box-shadow:var(--sh);padding:1.4rem;position:sticky;top:70px;max-height:calc(100vh - 90px);overflow-y:auto}
.sim-panel h2{font-size:.9rem;color:var(--p);font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.sim-group{margin-bottom:1.3rem;padding-bottom:1rem;border-bottom:1px solid #f0f3f5}
.sim-group:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.sim-group h3{font-size:.72rem;text-transform:uppercase;letter-spacing:.8px;color:var(--txtL);font-weight:600;margin-bottom:.7rem}
.sim-row{margin-bottom:.8rem}
.sim-row label{display:flex;justify-content:space-between;font-size:.8rem;font-weight:500;margin-bottom:.25rem}
.sim-row label span{color:var(--pl);font-weight:700;font-variant-numeric:tabular-nums}
.sim-row input[type=range]{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:#e0e6ed;border-radius:3px;outline:none;cursor:pointer}
.sim-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--pl);cursor:pointer;border:3px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.sim-row select{width:100%;padding:.45rem .6rem;border:1px solid var(--brd);border-radius:8px;font-size:.82rem;background:var(--card);cursor:pointer}
.sim-row .toggle{display:flex;gap:.5rem;align-items:center}
.sim-row .toggle-sw{width:40px;height:22px;border-radius:11px;background:#ccc;cursor:pointer;position:relative;transition:var(--trans)}
.sim-row .toggle-sw.on{background:var(--acc)}
.sim-row .toggle-sw::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:var(--trans);box-shadow:0 1px 3px rgba(0,0,0,.15)}
.sim-row .toggle-sw.on::after{left:20px}
.sim-results{flex:1}
.sim-delta{display:inline-block;font-size:.7rem;font-weight:600;padding:.1rem .5rem;border-radius:10px;margin-left:.4rem}
.sim-delta.up{background:rgba(0,184,148,.1);color:#00b894}
.sim-delta.down{background:rgba(214,48,49,.1);color:var(--danger)}
.sim-delta.neutral{background:rgba(99,110,114,.1);color:var(--txtL)}

/* === SIMULATOR YEAR TABS === */
.sim-year-tabs{display:flex;gap:0;margin-bottom:1.2rem;border-radius:var(--r);overflow:hidden;border:1px solid var(--brd);background:#f8fafb}
.sim-tab{flex:1;padding:.65rem .5rem;border:none;background:none;font-size:.8rem;font-weight:600;color:var(--txtL);cursor:pointer;transition:var(--trans);border-right:1px solid var(--brd);text-align:center}
.sim-tab:last-child{border-right:none}
.sim-tab:hover{background:rgba(26,74,122,.04);color:var(--p)}
.sim-tab.active{background:var(--card);color:var(--pl);box-shadow:inset 0 -3px 0 var(--pl)}
.sim-tab .tab-sub{display:block;font-size:.68rem;font-weight:400;color:var(--txtL);margin-top:.15rem}
.sim-tab.active .tab-sub{color:var(--pl)}

/* === SIM YEAR OVERVIEW === */
.sim-year-overview{margin-bottom:1.2rem}
.sim-year-overview .profit-yr{cursor:pointer;transition:var(--trans)}
.sim-year-overview .profit-yr:hover{background:rgba(26,74,122,.03)}
.sim-year-overview .profit-yr.highlight{background:rgba(26,74,122,.06);box-shadow:inset 0 -3px 0 var(--pl)}

/* === SIM YEAR DETAIL === */
.sim-year-detail{animation:fadeIn .25s ease}
.sim-year-verdict{margin-bottom:1rem}
.sim-sensitivity{display:flex;flex-wrap:wrap;gap:.5rem;margin:.8rem 0 1.2rem}
.sens-tag{font-size:.72rem;padding:.3rem .7rem;border-radius:16px;font-weight:500;border:1px solid var(--brd);background:#f8fafb;color:var(--txtL)}
.sens-tag.high{border-color:var(--danger);color:var(--danger);background:rgba(214,48,49,.04)}
.sens-tag.medium{border-color:var(--warn);color:#d68910;background:rgba(253,203,110,.08)}
.sens-tag.low{border-color:var(--acc);color:#00755a;background:rgba(0,184,148,.04)}

/* === SIM STRUCTURED SUMMARY === */
.sim-summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:.8rem}
.sim-summary-yr{border-radius:10px;padding:.9rem 1rem;background:#f8fafb;border-left:3px solid var(--brd)}
.sim-summary-yr.y1{border-left-color:var(--pl)}
.sim-summary-yr.y2{border-left-color:var(--acc2)}
.sim-summary-yr.y3{border-left-color:var(--acc)}
.sim-summary-yr h4{font-size:.78rem;font-weight:700;color:var(--p);margin-bottom:.4rem}
.sim-summary-yr ul{list-style:none;font-size:.8rem;line-height:1.7;color:var(--txt)}
.sim-summary-yr ul li::before{content:'\2022';color:var(--txtL);margin-right:.4rem}

@media(max-width:768px){
  .sim-year-tabs{flex-wrap:nowrap;overflow-x:auto}
  .sim-tab{min-width:0;padding:.5rem .3rem;font-size:.72rem}
  .sim-summary-grid{grid-template-columns:1fr}
  .rev-profile-bar{overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch}
  .rev-detail-grid{grid-template-columns:1fr}
}

/* === RESET BUTTON === */
.btn-reset{background:none;border:1px solid var(--brd);color:var(--txtL);padding:.35rem .7rem;border-radius:8px;font-size:.72rem;cursor:pointer;transition:var(--trans)}
.btn-reset:hover{border-color:var(--danger);color:var(--danger)}

/* === SCENARIO SAVE/LOAD === */
.sim-actions{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}
.sim-actions .btn{font-size:.75rem;padding:.35rem .7rem}
.scenario-list{max-height:200px;overflow-y:auto;border:1px solid var(--brd);border-radius:8px;margin-bottom:1rem;display:none}
.scenario-list.show{display:block}
.scenario-item{padding:.5rem .8rem;font-size:.8rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #f0f3f5}
.scenario-item:hover{background:#f8fafb}
.scenario-item:last-child{border-bottom:none}
.scenario-item .del{color:var(--danger);cursor:pointer;font-size:.7rem;padding:.2rem .4rem;border:none;background:none}

/* === ADMIN PANEL === */
.admin-panel{display:none;margin-top:1.2rem}
.admin-panel.show{display:block}
.admin-emails{list-style:none;padding:0}
.admin-emails li{display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid #f0f3f5;font-size:.82rem}
.admin-add{display:flex;gap:.5rem;margin-top:.8rem}
.admin-add input{flex:1;padding:.4rem .6rem;border:1px solid var(--brd);border-radius:8px;font-size:.82rem}

/* === MOBILE === */
@media(max-width:768px){
  .sidebar{width:64px}.sidebar .nav-label,.sidebar .logo h1,.sidebar .logo-sub,.sidebar .sidebar-footer span{display:none}
  .main-area{margin-left:64px}.content{padding:1rem}.kpi-grid{grid-template-columns:1fr 1fr}
  .toggle-btn{display:none}
}

/* === PRINT/PDF === */
@media print{
  .sidebar,.topbar,.dropzone,.toggle-btn{display:none!important}
  .main-area{margin-left:0!important}
  .section{display:block!important;page-break-inside:avoid}
  .card{box-shadow:none;border:1px solid #ddd}
}
/* === AUTH GATE === */
#app-content{display:none}
#login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0f2b46 0%,#1a4a7a 50%,#00b894 100%);font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
.login-card{background:#fff;border-radius:20px;padding:2.5rem 2.5rem 2rem;max-width:420px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.login-card .logo-auth{display:flex;align-items:center;justify-content:center;gap:.6rem;margin-bottom:.5rem}
.login-card .logo-auth .dot{width:12px;height:12px;border-radius:50%;background:#00b894}
.login-card .logo-auth h1{font-size:1.6rem;font-weight:800;color:#0f2b46;letter-spacing:-.5px}
.login-card .subtitle{font-size:.85rem;color:#636e72;margin-bottom:2rem}
.login-card .divider{height:1px;background:#dfe6e9;margin:1.5rem 0}
.login-card .access-info{font-size:.75rem;color:#b2bec3;margin-top:1rem}
.login-card .error-msg{background:#fdeaea;color:#c0392b;padding:.6rem 1rem;border-radius:10px;font-size:.82rem;margin-top:1rem;display:none}
#g_id_onload,#google-btn{display:flex;justify-content:center}
.logout-btn{background:none;border:1px solid rgba(255,255,255,.3);color:rgba(255,255,255,.7);padding:.35rem .8rem;border-radius:8px;font-size:.75rem;cursor:pointer;transition:all .25s ease;margin-left:.5rem}
.logout-btn:hover{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.6)}
.user-info{display:flex;align-items:center;gap:.5rem;font-size:.8rem;color:rgba(255,255,255,.8)}
.user-info img{width:26px;height:26px;border-radius:50%;border:2px solid rgba(255,255,255,.3)}
</style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen">
  <div class="login-card">
    <div class="logo-auth">
      <div class="dot"></div>
      <h1>GYNEVA</h1>
    </div>
    <p class="subtitle">Business Plan Interactif &mdash; Acc&egrave;s restreint</p>
    <div id="google-btn"></div>
    <div class="divider"></div>
    <p class="access-info">Seuls les comptes autoris&eacute;s peuvent acc&eacute;der &agrave; cette application.</p>
    <div class="error-msg" id="auth-error"></div>
  </div>
</div>

<!-- ===== APP CONTENT (hidden until auth) ===== -->
<div id="app-content">

<!-- ===== SIDEBAR ===== -->
<div class="sidebar" id="sidebar">
  <button class="toggle-btn" onclick="toggleSidebar()" id="toggleBtn">&#9664;</button>
  <div class="logo">
    <div class="dot"></div>
    <div>
      <h1>GYNEVA</h1>
      <div class="logo-sub">Business Plan · Gen&egrave;ve</div>
    </div>
  </div>
  <nav>
    <button class="active" onclick="nav('overview',this)"><span class="nav-icon">&#128200;</span><span class="nav-label">Vue d'ensemble</span></button>
    <button onclick="nav('simulator',this)"><span class="nav-icon">&#9881;&#65039;</span><span class="nav-label">Simulateur</span></button>
    <button onclick="nav('revenue',this)"><span class="nav-icon">&#128176;</span><span class="nav-label">Revenus</span></button>
    <button onclick="nav('cashflow',this)"><span class="nav-icon">&#128202;</span><span class="nav-label">Tr&eacute;sorerie</span></button>
    <button onclick="nav('team',this)"><span class="nav-icon">&#128101;</span><span class="nav-label">&Eacute;quipe</span></button>
    <button onclick="nav('risks',this)"><span class="nav-icon">&#9888;&#65039;</span><span class="nav-label">Risques</span></button>
    <button onclick="nav('profit',this)"><span class="nav-icon">&#128181;</span><span class="nav-label">Profit associ&eacute;s</span></button>
    <button onclick="nav('optimize',this)"><span class="nav-icon">&#128161;</span><span class="nav-label">Optimisations</span></button>
    <button id="navAdmin" style="display:none" onclick="nav('admin',this)"><span class="nav-icon">&#128274;</span><span class="nav-label">Admin</span></button>
  </nav>
  <div class="sidebar-footer"><span>Analyse confidentielle &middot; 2025</span></div>
</div>

<!-- ===== MAIN ===== -->
<div class="main-area">
<div class="topbar">
  <div class="page-title" id="pageTitle">Vue d'ensemble</div>
  <div class="plan-switcher" id="planSwitcher">
    <span class="plan-name" onclick="togglePlanDropdown()" id="planNameDisplay">Plan initial</span>
    <div class="plan-dropdown" id="planDropdown">
      <div id="planListItems"></div>
      <div class="pd-footer"><button onclick="createNewPlan()">+ Nouveau plan</button></div>
    </div>
  </div>
  <div class="spacer"></div>
  <div class="status-pill static" id="statusPill"><div class="status-dot static" id="statusDot"></div><span id="statusLabel">Donn&eacute;es int&eacute;gr&eacute;es</span></div>
  <button class="btn" onclick="document.getElementById('fileInput').click()">&#128196; Importer Excel</button>
  <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="handleFile(this.files[0])">
  <button class="btn" onclick="openVersionPanel()">&#128338; Versions</button>
  <button class="btn" onclick="openCompare()">&#128200; Comparer</button>
  <button class="btn primary" onclick="exportPDF()">&#128424; Export PDF</button>
</div>

<div class="content">

<!-- DROPZONE -->
<div class="dropzone" id="dropzone">
  <div class="dz-icon">&#128196;</div>
  <div class="dz-text" id="dzText">Glissez votre fichier GYNEVA_Business_Plan.xlsx ici</div>
  <div class="dz-sub">ou cliquez pour s&eacute;lectionner &middot; Fichier envoy&eacute; au serveur pour traitement</div>
  <input type="file" accept=".xlsx,.xls" onchange="handleFile(this.files[0])">
</div>

<!-- IMPORT SUMMARY -->
<div class="import-summary" id="importSummary">
  <h3>&#128203; R&eacute;sum&eacute; de l'import</h3>
  <div id="importDiffContent"></div>
</div>

<!-- OVERLAY CONTROL -->
<div class="overlay-control" id="overlayControl" style="display:none">
  <label><span class="overlay-indicator" id="overlayDot"></span> Sc&eacute;nario overlay :</label>
  <select id="overlayScenarioSelect" onchange="applyScenarioOverlay()">
    <option value="">Aucun (d&eacute;sactiv&eacute;)</option>
  </select>
  <button onclick="refreshOverlayScenarios()">&#8635; Rafra&icirc;chir</button>
</div>

<!-- ====== OVERVIEW ====== -->
<div class="section active" id="overview">
  <div class="verdict green" id="verdictMain">
    <div class="ic">&#9989;</div>
    <div><strong>Projet &eacute;conomiquement viable.</strong> Le mod&egrave;le atteint la rentabilit&eacute; d&egrave;s le 5e mois d'activit&eacute; et d&eacute;gage un r&eacute;sultat cumul&eacute; de <span id="vTresoY3">CHF 2,3M</span> sur 3 ans. Les risques principaux sont ma&icirc;trisables avec les optimisations propos&eacute;es.</div>
  </div>
  <div class="kpi-grid">
    <div class="kpi blue"><div class="lb">Investissement total</div><div class="vl" id="kCapex">523k</div><div class="sb">CAPEX + &eacute;quipements</div></div>
    <div class="kpi green"><div class="lb">CA Ann&eacute;e 3</div><div class="vl" id="kCaY3">4,7M</div><div class="sb" id="kCaGrowth">Vitesse de croisi&egrave;re</div></div>
    <div class="kpi green"><div class="lb">R&eacute;sultat net Ann&eacute;e 3</div><div class="vl" id="kResY3">1,15M</div><div class="sb" id="kMargin">Marge ~24%</div></div>
    <div class="kpi blue"><div class="lb">Retour sur investissement</div><div class="vl" id="kPayback">11 mois</div><div class="sb">Payback period</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#128200;</span> &Eacute;volution sur 3 ans</h2>
    <div class="chart-box"><canvas id="cOverview"></canvas></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#9881;</span> Hypoth&egrave;ses cl&eacute;s du mod&egrave;le</h2>
    <div class="exp">Le mod&egrave;le repose sur les standards TARMED pour la gyn&eacute;cologie &agrave; Gen&egrave;ve. Chaque hypoth&egrave;se est modifiable via le <strong>Simulateur</strong> ou dans le fichier Excel.</div>
    <div class="pills" id="pillsAssumptions">
      <div class="pill"><b>16</b> consult./jour</div>
      <div class="pill"><b>CHF 225</b> /consultation</div>
      <div class="pill"><b>215</b> jours/an</div>
      <div class="pill"><b>60/40</b> partage associ&eacute;s</div>
    </div>
  </div>
</div>

<!-- ====== SIMULATOR ====== -->
<div class="section" id="simulator">
  <div class="verdict orange">
    <div class="ic">&#9881;&#65039;</div>
    <div><strong>Simulateur de sc&eacute;narios.</strong> Modifiez les hypoth&egrave;ses ci-dessous et observez l'impact en temps r&eacute;el sur le chiffre d'affaires, le r&eacute;sultat net et la tr&eacute;sorerie. Les valeurs de base du business plan sont pr&eacute;-remplies.</div>
  </div>
  <!-- Scenario save/load -->
  <div class="sim-actions">
    <button class="btn" onclick="saveScenario()">&#128190; Sauvegarder sc&eacute;nario</button>
    <button class="btn" onclick="toggleScenarioList()">&#128194; Charger sc&eacute;nario</button>
  </div>
  <div class="scenario-list" id="scenarioList"></div>
  <div class="sim-layout">
    <!-- CONTROLS PANEL -->
    <div class="sim-panel">
      <h2>&#9881;&#65039; Param&egrave;tres <button class="btn-reset" onclick="resetSim()" style="margin-left:auto">&#8635; R&eacute;initialiser</button></h2>

      <div class="sim-group">
        <h3>&#128137; Activit&eacute; m&eacute;dicale</h3>
        <div class="sim-row">
          <label>Consultations / jour <span id="sConsultVal">16</span></label>
          <input type="range" id="sConsult" min="8" max="24" step="1" value="16" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Honoraires moyens (CHF) <span id="sFeeVal">225</span></label>
          <input type="range" id="sFee" min="120" max="350" step="5" value="225" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Jours travaill&eacute;s / an <span id="sDaysVal">215</span></label>
          <input type="range" id="sDays" min="180" max="250" step="5" value="215" oninput="runSim()">
        </div>
      </div>

      <div class="sim-group">
        <h3>&#128101; &Eacute;quipe m&eacute;dicale</h3>
        <div class="sim-row">
          <label>Associ&eacute;s (sp&eacute;cialistes) <span id="sAssocVal">2</span></label>
          <input type="range" id="sAssoc" min="1" max="4" step="1" value="2" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>M&eacute;decins ind&eacute;pendants <span id="sIndepVal">3</span></label>
          <input type="range" id="sIndep" min="0" max="6" step="1" value="3" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>M&eacute;decins internes <span id="sInterneVal">2</span></label>
          <input type="range" id="sInterne" min="0" max="4" step="1" value="2" oninput="runSim()">
        </div>
      </div>

      <div class="sim-group">
        <h3>&#128176; Tr&eacute;sorerie &amp; paiements</h3>
        <div class="sim-row">
          <label>D&eacute;lai paiement LAMal</label>
          <select id="sDelay" onchange="runSim()">
            <option value="0">Sans d&eacute;lai (id&eacute;al)</option>
            <option value="1" selected>1 mois (r&eacute;aliste)</option>
            <option value="3">3 mois (prudent)</option>
          </select>
        </div>
        <div class="sim-row">
          <label>Patients OI/ONU (cash) <span id="sCashVal">15%</span></label>
          <input type="range" id="sCash" min="0" max="30" step="1" value="15" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Factoring Caisse M&eacute;decins
            <div class="toggle">
              <div class="toggle-sw on" id="sFactToggle" onclick="this.classList.toggle('on');runSim()"></div>
            </div>
          </label>
        </div>
      </div>

      <div class="sim-group">
        <h3>&#128178; Charges suppl&eacute;mentaires</h3>
        <div class="sim-row">
          <label>Charges non budg&eacute;t&eacute;es / an (CHF) <span id="sExtraVal">200k</span></label>
          <input type="range" id="sExtra" min="0" max="400000" step="10000" value="200000" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Co&ucirc;t RC obst&eacute;trique / an (CHF) <span id="sRCVal">60k</span></label>
          <input type="range" id="sRC" min="0" max="120000" step="5000" value="60000" oninput="runSim()">
        </div>
      </div>

      <div class="sim-group">
        <h3>&#128200; Mont&eacute;e en charge</h3>
        <div class="sim-row">
          <label>Mois d&eacute;but activit&eacute; <span id="sStartVal">4</span></label>
          <input type="range" id="sStart" min="1" max="12" step="1" value="4" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Taux occupation Y1 <span id="sOccupVal">60%</span></label>
          <input type="range" id="sOccup" min="30" max="100" step="5" value="60" oninput="runSim()">
        </div>
      </div>
    </div>

    <!-- RESULTS PANEL -->
    <div class="sim-results">
      <!-- YEAR TABS -->
      <div class="sim-year-tabs" id="simYearTabs">
        <button class="sim-tab active" data-year="all" onclick="switchSimYear('all',this)">Vue 3 ans<span class="tab-sub">Synth&egrave;se</span></button>
        <button class="sim-tab" data-year="1" onclick="switchSimYear('1',this)">Ann&eacute;e 1<span class="tab-sub">D&eacute;marrage</span></button>
        <button class="sim-tab" data-year="2" onclick="switchSimYear('2',this)">Ann&eacute;e 2<span class="tab-sub">Croissance</span></button>
        <button class="sim-tab" data-year="3" onclick="switchSimYear('3',this)">Ann&eacute;e 3<span class="tab-sub">Croisi&egrave;re</span></button>
      </div>
      <!-- YEAR OVERVIEW TIMELINE -->
      <div class="sim-year-overview">
        <div class="profit-tl">
          <div class="profit-yr" id="simYrCard1" onclick="switchSimYear('1',document.querySelector('[data-year=&quot;1&quot;]'))">
            <div class="yl">Ann&eacute;e 1</div>
            <div class="am" id="simOvCaY1">&mdash;</div>
            <div class="pa" id="simOvResY1">&mdash;</div>
            <div class="nt" id="simOvDeltaY1"></div>
          </div>
          <div class="profit-yr" id="simYrCard2" onclick="switchSimYear('2',document.querySelector('[data-year=&quot;2&quot;]'))">
            <div class="yl">Ann&eacute;e 2</div>
            <div class="am" id="simOvCaY2">&mdash;</div>
            <div class="pa" id="simOvResY2">&mdash;</div>
            <div class="nt" id="simOvDeltaY2"></div>
          </div>
          <div class="profit-yr" id="simYrCard3" onclick="switchSimYear('3',document.querySelector('[data-year=&quot;3&quot;]'))">
            <div class="yl">Ann&eacute;e 3</div>
            <div class="am" id="simOvCaY3">&mdash;</div>
            <div class="pa" id="simOvResY3">&mdash;</div>
            <div class="nt" id="simOvDeltaY3"></div>
          </div>
        </div>
      </div>
      <!-- YEAR DETAIL: VERDICT + KPIs + SENSITIVITY -->
      <div id="simYearDetail">
        <div id="simYearVerdict" class="verdict green" style="display:none"></div>
        <div class="kpi-grid" id="simYearKpis"></div>
        <div class="sim-sensitivity" id="simSensitivity"></div>
      </div>
      <!-- CHARTS -->
      <div class="card">
        <h2><span class="ic">&#128200;</span> Projection simul&eacute;e &mdash; CA &amp; R&eacute;sultat</h2>
        <div class="chart-box"><canvas id="cSim1"></canvas></div>
      </div>
      <div class="card">
        <h2><span class="ic">&#128202;</span> Tr&eacute;sorerie simul&eacute;e</h2>
        <div class="chart-box"><canvas id="cSim2"></canvas></div>
      </div>
      <!-- STRUCTURED SUMMARY -->
      <div class="card">
        <h2><span class="ic">&#128176;</span> Synth&egrave;se du sc&eacute;nario simul&eacute;</h2>
        <div class="sim-summary-grid" id="simSummary"></div>
      </div>
    </div>
  </div>
</div>

<!-- ====== REVENUE ====== -->
<div class="section" id="revenue">
  <div class="card">
    <h2><span class="ic">&#128176;</span> Chiffre d'affaires mensuel par source</h2>
    <div class="rev-profile-bar" id="revProfileBar">
      <button class="rev-prof active" data-prof="all" onclick="toggleRevProfile('all',this)">Tous</button>
      <button class="rev-prof active" data-prof="assoc" onclick="toggleRevProfile('assoc',this)"><span class="prof-dot" style="background:#0f2b46"></span> Associ&eacute;s</button>
      <button class="rev-prof active" data-prof="indep" onclick="toggleRevProfile('indep',this)"><span class="prof-dot" style="background:#1a4a7a"></span> Ind&eacute;pendants</button>
      <button class="rev-prof active" data-prof="interne" onclick="toggleRevProfile('interne',this)"><span class="prof-dot" style="background:#5dade2"></span> Internes</button>
      <button class="rev-prof active" data-prof="sage" onclick="toggleRevProfile('sage',this)"><span class="prof-dot" style="background:#aed6f1"></span> Sage-femme</button>
    </div>
    <div class="chart-box"><canvas id="cRevenue"></canvas></div>
  </div>
  <div class="rev-detail-grid" id="revDetailGrid"></div>
  <div class="kpi-grid">
    <div class="kpi blue"><div class="lb">Potentiel / sp&eacute;cialiste</div><div class="vl" id="kRevSpec">923k</div><div class="sb">CHF/an &agrave; 100%</div></div>
    <div class="kpi"><div class="lb">CA Ann&eacute;e 1</div><div class="vl" id="kCaY1">1,9M</div><div class="sb">D&eacute;marrage progressif</div></div>
    <div class="kpi"><div class="lb">CA Ann&eacute;e 2</div><div class="vl" id="kCaY2">3,6M</div><div class="sb" id="kCaY2g">Mont&eacute;e en puissance</div></div>
    <div class="kpi green"><div class="lb">CA Ann&eacute;e 3</div><div class="vl" id="kCaY3b">4,7M</div><div class="sb">Vitesse de croisi&egrave;re</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#128178;</span> Mod&egrave;le de partage du chiffre d'affaires</h2>
    <div class="exp"><strong>Associ&eacute;s :</strong> 60% de leurs honoraires pour eux, 40% pour GynEva.<br><strong>Ind&eacute;pendants :</strong> 60% pour eux, 40% pour GynEva.<br><strong>Internes :</strong> Salari&eacute;s &mdash; GynEva garde le CA et paye le salaire.<br><strong>Sage-femme :</strong> Contribution nette via les prestations maternit&eacute;.</div>
  </div>
</div>

<!-- ====== CASHFLOW ====== -->
<div class="section" id="cashflow">
  <div class="verdict orange" id="verdictCash">
    <div class="ic">&#9888;&#65039;</div>
    <div><strong>Point d'attention principal.</strong> Avec d&eacute;lai LAMal 3 mois sans optimisation, la tr&eacute;sorerie n&eacute;cessite un BFR de <strong id="vCashMin">273k CHF</strong>. Avec factoring + client&egrave;le OI, le besoin tombe &agrave; <strong id="vCashOpt">46k CHF</strong>.</div>
  </div>
  <div class="card">
    <h2><span class="ic">&#128202;</span> Tr&eacute;sorerie cumul&eacute;e &mdash; Sc&eacute;narios compar&eacute;s</h2>
    <div class="chart-box"><canvas id="cCashflow"></canvas></div>
  </div>
  <div class="sc-grid">
    <div class="sc-card"><h3>&#128308; 100% LAMal 3 mois</h3><div class="bn" style="color:var(--danger)" id="scWorst">-273k</div><div class="dt">Creux maximum &middot; FdR 250k = insuffisant</div></div>
    <div class="sc-card"><h3>&#128992; 15% cash + LAMal 3m</h3><div class="bn" style="color:#e17055" id="scCash3m">-155k</div><div class="dt">Creux r&eacute;duit &middot; FdR 250k = juste</div></div>
    <div class="sc-card"><h3>&#128993; 15% cash + LAMal 1m</h3><div class="bn" style="color:var(--warn)" id="scCash1m">-75k</div><div class="dt">D&eacute;lai r&eacute;aliste &middot; FdR 250k = confortable</div></div>
    <div class="sc-card rec"><h3>&#9989; 15% cash + Factoring</h3><div class="bn" style="color:var(--acc)" id="scFact">-46k</div><div class="dt">Avance imm&eacute;diate &middot; ~49k/an &middot; FdR largement OK</div></div>
  </div>
</div>

<!-- ====== TEAM ====== -->
<div class="section" id="team">
  <div class="card">
    <h2><span class="ic">&#128101;</span> Mont&eacute;e en charge de l'&eacute;quipe (ETP)</h2>
    <div class="exp">L'&eacute;quipe passe de <strong>0 &agrave; 17 ETP</strong> sur 36 mois. Chaque recrutement est align&eacute; sur la croissance du CA.</div>
    <div class="chart-box"><canvas id="cTeam"></canvas></div>
  </div>
  <div class="kpi-grid">
    <div class="kpi"><div class="lb">Mois 6</div><div class="vl" id="kFte6">8</div><div class="sb">ETP</div></div>
    <div class="kpi"><div class="lb">Mois 12</div><div class="vl" id="kFte12">11</div><div class="sb">ETP</div></div>
    <div class="kpi"><div class="lb">Mois 24</div><div class="vl" id="kFte24">14</div><div class="sb">ETP</div></div>
    <div class="kpi green"><div class="lb">Mois 36</div><div class="vl" id="kFte36">17</div><div class="sb">ETP &middot; croisi&egrave;re</div></div>
  </div>
</div>

<!-- ====== RISKS ====== -->
<div class="section" id="risks">
  <div class="card">
    <h2><span class="ic">&#9888;&#65039;</span> Matrice des risques</h2>
    <table class="dt"><thead><tr><th>Risque</th><th>Probabilit&eacute;</th><th>Impact</th><th>Mitigation</th></tr></thead>
    <tbody>
      <tr><td>Retard autorisation cantonale</td><td><span class="badge moyen">Moyen</span></td><td><span class="badge eleve">&Eacute;lev&eacute;</span></td><td>Anticiper d&eacute;p&ocirc;t 6 mois avant</td></tr>
      <tr><td>D&eacute;lais paiement LAMal &gt; 3 mois</td><td><span class="badge moyen">Moyen</span></td><td><span class="badge eleve">&Eacute;lev&eacute;</span></td><td>Factoring Caisse des M&eacute;decins</td></tr>
      <tr><td>Sous-occupation prolong&eacute;e Y1</td><td><span class="badge moyen">Moyen</span></td><td><span class="badge moyen">Moyen</span></td><td>Plan marketing, r&eacute;seau r&eacute;f&eacute;rents</td></tr>
      <tr><td>D&eacute;part m&eacute;decin ind&eacute;pendant</td><td><span class="badge moyen">Moyen</span></td><td><span class="badge eleve">&Eacute;lev&eacute;</span></td><td>Clause non-concurrence, conditions attractives</td></tr>
      <tr><td>&Eacute;volution tarifaire TARMED/TARDOC</td><td><span class="badge moyen">Moyen</span></td><td><span class="badge eleve">&Eacute;lev&eacute;</span></td><td>Diversification anti-&acirc;ge, actes priv&eacute;s</td></tr>
      <tr><td>Litige obst&eacute;trique (RC pro)</td><td><span class="badge faible">Faible</span></td><td><span class="badge tres-eleve">Tr&egrave;s &eacute;lev&eacute;</span></td><td>RC pro adapt&eacute;e, protocoles stricts</td></tr>
      <tr><td>Sous-estimation CAPEX</td><td><span class="badge moyen">Moyen</span></td><td><span class="badge faible">Faible</span></td><td>R&eacute;serve CHF 20k, leasing possible</td></tr>
    </tbody></table>
  </div>
  <div class="card">
    <h2><span class="ic">&#128680;</span> Charges non budg&eacute;t&eacute;es identifi&eacute;es (~CHF 150-270k/an)</h2>
    <table class="dt"><thead><tr><th>Poste</th><th>Estimation</th><th>Criticit&eacute;</th></tr></thead>
    <tbody>
      <tr><td>RC professionnelle (obst&eacute;trique)</td><td class="num">CHF 40-80k</td><td><span class="badge critique">critique</span></td></tr>
      <tr><td>Provision litiges</td><td class="num">CHF 20-50k</td><td><span class="badge critique">critique</span></td></tr>
      <tr><td>Entretien &eacute;quipements</td><td class="num">CHF 15-25k</td><td><span class="badge important">important</span></td></tr>
      <tr><td>Logiciels / licences</td><td class="num">CHF 10-20k</td><td><span class="badge important">important</span></td></tr>
      <tr><td>D&eacute;chets m&eacute;dicaux</td><td class="num">CHF 8-15k</td><td><span class="badge important">important</span></td></tr>
      <tr><td>Formation continue</td><td class="num">CHF 5-10k</td><td><span class="badge moyen">moyen</span></td></tr>
      <tr><td>Cotisations FMH</td><td class="num">CHF 5-8k</td><td><span class="badge moyen">moyen</span></td></tr>
      <tr><td>Autorisations cantonales</td><td class="num">CHF 3-5k</td><td><span class="badge moyen">moyen</span></td></tr>
    </tbody></table>
  </div>
  <div class="card">
    <h2><span class="ic">&#127919;</span> Stress test &mdash; Seuils critiques</h2>
    <div class="exp">En dessous du <strong>seuil critique</strong>, le projet n'est plus viable. Comparez avec la valeur de base pour &eacute;valuer votre marge de s&eacute;curit&eacute;.</div>
    <table class="dt"><thead><tr><th>Variable</th><th style="color:var(--danger)">Pessimiste</th><th><strong>Base</strong></th><th style="color:var(--acc)">Optimiste</th><th style="color:var(--danger)">Seuil critique</th></tr></thead>
    <tbody>
      <tr><td><strong>Consultations/jour</strong></td><td>12 (-25%)</td><td><strong id="stConsult">16</strong></td><td>20 (+25%)</td><td style="color:var(--danger);font-weight:600">10</td></tr>
      <tr><td><strong>Honoraires moyens</strong></td><td>CHF 180</td><td><strong id="stFee">CHF 225</strong></td><td>CHF 270</td><td style="color:var(--danger);font-weight:600">CHF 160</td></tr>
      <tr><td><strong>Taux occupation Y1</strong></td><td>40%</td><td><strong>60%</strong></td><td>80%</td><td style="color:var(--danger);font-weight:600">35%</td></tr>
      <tr><td><strong>D&eacute;lai mont&eacute;e charge</strong></td><td>8 mois</td><td><strong>5 mois</strong></td><td>3 mois</td><td style="color:var(--danger);font-weight:600">12 mois</td></tr>
      <tr><td><strong>D&eacute;lai paiement LAMal</strong></td><td>3 mois</td><td><strong>1 mois</strong></td><td>&lt; 1 mois</td><td style="color:var(--danger);font-weight:600">4 mois</td></tr>
    </tbody></table>
  </div>
</div>

<!-- ====== PROFIT ====== -->
<div class="section" id="profit">
  <div class="verdict green">
    <div class="ic">&#128176;</div>
    <div><strong>ROI attractif.</strong> Pour ~CHF 80k par associ&eacute;, le retour cumul&eacute; sur 3 ans atteint <strong>CHF 700-900k</strong> par personne apr&egrave;s charges manquantes.</div>
  </div>
  <div class="card">
    <h2><span class="ic">&#128181;</span> R&eacute;sultat net &mdash; Part par associ&eacute;</h2>
    <div class="profit-tl">
      <div class="profit-yr"><div class="yl">Ann&eacute;e 1</div><div class="am" id="pResY1">CHF 347k</div><div class="pa" id="pPerY1">~173k / associ&eacute;</div><div class="nt" id="pAdjY1">Apr&egrave;s charges manquantes: ~73k</div></div>
      <div class="profit-yr"><div class="yl">Ann&eacute;e 2</div><div class="am" id="pResY2">CHF 767k</div><div class="pa" id="pPerY2">~384k / associ&eacute;</div><div class="nt" id="pAdjY2">Apr&egrave;s charges manquantes: ~284k</div></div>
      <div class="profit-yr"><div class="yl">Ann&eacute;e 3</div><div class="am" id="pResY3">CHF 1,15M</div><div class="pa" id="pPerY3">~576k / associ&eacute;</div><div class="nt" id="pAdjY3">Apr&egrave;s charges manquantes: ~476k</div></div>
    </div>
    <div class="exp"><strong>L'associ&eacute; m&eacute;decin</strong> touche en plus 60% de son propre CA (~CHF 554k/an &agrave; plein r&eacute;gime). <strong>L'associ&eacute; non-m&eacute;decin</strong> d&eacute;pend du r&eacute;sultat du cabinet.</div>
  </div>
  <div class="card">
    <h2><span class="ic">&#128200;</span> R&eacute;sultat par associ&eacute; (graphique)</h2>
    <div class="chart-box sm"><canvas id="cProfit"></canvas></div>
  </div>
</div>

<!-- ====== OPTIMIZE ====== -->
<div class="section" id="optimize">
  <div class="verdict green">
    <div class="ic">&#128161;</div>
    <div><strong>Deux leviers puissants</strong> qui r&eacute;duisent le besoin en fonds de roulement de <strong>80%</strong> et s&eacute;curisent le d&eacute;marrage.</div>
  </div>
  <div class="card">
    <h2><span class="ic">&#127975;</span> Caisse des M&eacute;decins &mdash; Factoring</h2>
    <div class="exp">Avance imm&eacute;diate sur honoraires LAMal. Au lieu d'attendre 1-3 mois, vous encaissez d&egrave;s la facturation. Co&ucirc;t : ~<strong>1,5% du CA factur&eacute;</strong> (~CHF 49k/an &agrave; plein r&eacute;gime).</div>
    <div class="kpi-grid">
      <div class="kpi red"><div class="lb">BFR sans factoring</div><div class="vl" id="kBfrSans">233k</div><div class="sb">FdR 250k = tout juste</div></div>
      <div class="kpi green"><div class="lb">BFR avec factoring</div><div class="vl" id="kBfrAvec">46k</div><div class="sb">FdR 250k = largement OK</div></div>
      <div class="kpi blue"><div class="lb">Co&ucirc;t annuel factoring</div><div class="vl">~49k</div><div class="sb">~4% du r&eacute;sultat net</div></div>
    </div>
  </div>
  <div class="card">
    <h2><span class="ic">&#127760;</span> Client&egrave;le OI/ONU (15%)</h2>
    <div class="exp">~15% des patients genevois sont des fonctionnaires internationaux couverts par l'<strong>UNSMIS</strong>. Ils payent comptant &mdash; cash imm&eacute;diat, aucun d&eacute;lai LAMal. Ce levier r&eacute;duit naturellement le BFR sans co&ucirc;t suppl&eacute;mentaire.</div>
  </div>
  <div class="card">
    <h2><span class="ic">&#128200;</span> Impact combin&eacute; sur la tr&eacute;sorerie</h2>
    <div class="chart-box"><canvas id="cOptimize"></canvas></div>
  </div>
</div>

<!-- ====== ADMIN ====== -->
<div class="section" id="admin">
  <div class="card">
    <h2><span class="ic">&#128274;</span> Gestion des utilisateurs autoris&eacute;s</h2>
    <div class="exp">Ajoutez ou supprimez des adresses email autoris&eacute;es &agrave; acc&eacute;der &agrave; l'application.</div>
    <ul class="admin-emails" id="adminEmailList"></ul>
    <div class="admin-add">
      <input type="email" id="adminNewEmail" placeholder="nouvel.email@example.com">
      <button class="btn primary" onclick="addAllowedEmail()">Ajouter</button>
    </div>
  </div>
</div>

</div><!-- /content -->
</div><!-- /main-area -->

<script>
// ===== API HELPER =====
const API_BASE = '/api';
async function api(path, opts = {}) {
  const res = await fetch(API_BASE + path, {
    credentials: 'include',
    headers: { 'Content-Type': 'application/json', ...opts.headers },
    ...opts,
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw { status: res.status, ...data };
  return data;
}

// ===== GLOBALS =====
const CASH_SHARE_BASE = 0.15, FACT_COST = 0.015;
let charts = {};
let D = null;
let SIM = null;
let currentUser = null;
let currentPlanId = null;
let allPlans = [];
let OVERLAY = null;
let overlayScenarioId = null;
let simActiveYear = 'all';

// ===== NAV =====
const pageTitles = {overview:"Vue d'ensemble",simulator:"Simulateur",revenue:"Revenus",cashflow:"Tr\u00e9sorerie",team:"\u00c9quipe",risks:"Risques",profit:"Profit associ\u00e9s",optimize:"Optimisations",admin:"Administration"};
function nav(id, btn) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.sidebar nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('pageTitle').textContent = pageTitles[id]||id;
  if (id === 'admin') loadAdminData();
}

// ===== FORMAT =====
function fmt(n){if(n==null||isNaN(n))return'\u2014';const a=Math.abs(n);if(a>=1e6)return(n/1e6).toFixed(1)+'M';if(a>=1e3)return Math.round(n/1e3)+'k';return Math.round(n).toString()}
function fmtCHF(n){return'CHF '+fmt(n)}
function fmtN(n){if(n==null||isNaN(n))return'\u2014';return n.toLocaleString('fr-CH',{maximumFractionDigits:0})}
function pct(a,b){return b?Math.round((a/b-1)*100)+'%':'\u2014'}

// ===== SIDEBAR TOGGLE =====
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  sb.classList.toggle('collapsed');
  document.getElementById('toggleBtn').innerHTML=sb.classList.contains('collapsed')?'&#9654;':'&#9664;';
}

// ===== DROPZONE =====
const dz=document.getElementById('dropzone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over')});
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');if(e.dataTransfer.files.length)handleFile(e.dataTransfer.files[0])});

// ===== EXCEL IMPORT (via API) =====
async function handleFile(file){
  if(!file)return;
  try {
    // Deep copy current data for diff
    const oldData = D ? JSON.parse(JSON.stringify(D)) : null;

    const buffer = await file.arrayBuffer();
    const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
    const result = await api('/import/excel', {
      method: 'POST',
      body: JSON.stringify({ file: base64, filename: file.name }),
    });
    D = result.data;
    computeDerived();
    updateUI();
    // Save imported data to current plan
    if (currentPlanId) {
      await api('/plans/' + currentPlanId, {
        method: 'PUT',
        body: JSON.stringify({
          data: {
            ca:D.ca, caAssoc:D.caAssoc, caIndep:D.caIndep, caInterne:D.caInterne, caSage:D.caSage,
            result:D.result, cashflow:D.cashflow, treso1m:D.treso1m, treso3m:D.treso3m,
            admin:D.admin, opex:D.opex, lab:D.lab,
            fteAssoc:D.fteAssoc, fteIndep:D.fteIndep, fteInterne:D.fteInterne, fteAdmin:D.fteAdmin, fteTotal:D.fteTotal,
          },
          consultDay: D.consultDay, fee: D.fee, daysYear: D.daysYear,
          revSpec: D.revSpec, capex: D.capex,
          versionLabel: 'Import Excel: ' + file.name,
        }),
      });
    }
    dz.classList.add('loaded');
    document.getElementById('dzText').textContent='\u2713 '+file.name+' \u2014 donn\u00e9es synchronis\u00e9es';
    document.getElementById('statusLabel').textContent='Donn\u00e9es en direct \u00b7 '+file.name;
    document.getElementById('statusPill').className='status-pill live';
    document.getElementById('statusDot').className='status-dot live';

    // Show import diff summary
    buildImportDiff(oldData, D, result.warnings || []);
  } catch(err) {
    console.error('Import error:', err);
    const msg = err.error || err.message || 'Erreur inconnue';
    document.getElementById('dzText').textContent='\u2717 Erreur: ' + msg;
    document.getElementById('importSummary').classList.remove('show');
  }
}

// ===== IMPORT DIFF =====
function buildImportDiff(oldData, newData, warnings) {
  const container = document.getElementById('importSummary');
  const content = document.getElementById('importDiffContent');

  const sumArr = (arr, start, end) => arr.slice(start, end).reduce((a,b) => a+b, 0);
  const metrics = [
    { label: 'CA Ann\u00e9e 1', fn: d => sumArr(d.ca, 0, 12) },
    { label: 'CA Ann\u00e9e 2', fn: d => sumArr(d.ca, 12, 24) },
    { label: 'CA Ann\u00e9e 3', fn: d => sumArr(d.ca, 24, 36) },
    { label: 'R\u00e9sultat Ann\u00e9e 1', fn: d => sumArr(d.result, 0, 12) },
    { label: 'R\u00e9sultat Ann\u00e9e 2', fn: d => sumArr(d.result, 12, 24) },
    { label: 'R\u00e9sultat Ann\u00e9e 3', fn: d => sumArr(d.result, 24, 36) },
    { label: 'CAPEX', fn: d => d.capex },
    { label: 'Honoraires / consult.', fn: d => d.fee },
    { label: 'Consult. / jour', fn: d => d.consultDay },
    { label: 'ETP max', fn: d => Math.max(...d.fteTotal) },
  ];

  let diffs = [];
  if (oldData) {
    for (const m of metrics) {
      const ov = m.fn(oldData);
      const nv = m.fn(newData);
      if (ov !== nv) diffs.push({ label: m.label, old: ov, new: nv });
    }
  }

  let html = '';
  if (!oldData) {
    html = '<div class="no-change">Premi\u00e8re importation — donn\u00e9es charg\u00e9es.</div>';
  } else if (diffs.length === 0) {
    html = '<div class="no-change">Aucun changement d\u00e9tect\u00e9 par rapport aux donn\u00e9es pr\u00e9c\u00e9dentes.</div>';
  } else {
    html = '<div class="diff-grid">';
    for (const d of diffs) {
      const pct = d.old !== 0 ? ((d.new - d.old) / Math.abs(d.old) * 100) : 0;
      const pctClass = pct > 0 ? 'up' : pct < 0 ? 'down' : '';
      const pctStr = pct !== 0 ? '<span class="diff-pct ' + pctClass + '">' + (pct > 0 ? '+' : '') + pct.toFixed(1) + '%</span>' : '';
      html += '<div class="diff-item"><span class="diff-label">' + d.label + '</span>'
        + '<span class="diff-values"><span class="diff-old">' + fmt(d.old) + '</span>'
        + '<span class="diff-arrow">\u2192</span>'
        + '<span class="diff-new">' + fmt(d.new) + '</span>'
        + pctStr + '</span></div>';
    }
    html += '</div>';
  }

  // Show warnings from parser
  if (warnings && warnings.length > 0) {
    html += '<ul class="import-warnings">';
    for (const w of warnings) html += '<li>' + w + '</li>';
    html += '</ul>';
  }

  content.innerHTML = html;
  container.classList.add('show');
}

// ===== VERSION PANEL =====
function openVersionPanel() {
  document.getElementById('versionPanel').classList.add('open');
  document.getElementById('versionOverlay').classList.add('show');
  loadVersions();
}

function closeVersionPanel() {
  document.getElementById('versionPanel').classList.remove('open');
  document.getElementById('versionOverlay').classList.remove('show');
}

async function loadVersions() {
  const list = document.getElementById('versionList');
  if (!currentPlanId) {
    list.innerHTML = '<div class="vp-empty">Aucun plan actif. Importez d\'abord des donn\u00e9es.</div>';
    return;
  }
  try {
    const result = await api('/plans/' + currentPlanId + '/versions');
    const versions = result.versions || [];
    if (versions.length === 0) {
      list.innerHTML = '<div class="vp-empty">Aucune version enregistr\u00e9e pour ce plan.</div>';
      return;
    }
    list.innerHTML = versions.map(function(v) {
      const d = new Date(v.createdAt);
      const dateStr = d.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short', year: 'numeric' })
        + ' \u00e0 ' + d.toLocaleTimeString('fr-CH', { hour: '2-digit', minute: '2-digit' });
      return '<div class="version-item">'
        + '<div class="vi-top"><span class="vi-num">v' + v.versionNumber + '</span><span class="vi-date">' + dateStr + '</span></div>'
        + '<div class="vi-label">' + (v.label || 'Version ' + v.versionNumber) + '</div>'
        + '<button class="vi-restore" onclick="restoreVersion(\'' + v.id + '\')">Restaurer cette version</button>'
        + '</div>';
    }).join('');
  } catch(err) {
    list.innerHTML = '<div class="vp-empty">Erreur: ' + (err.error || err.message || 'Impossible de charger les versions') + '</div>';
  }
}

async function restoreVersion(versionId) {
  if (!currentPlanId) return;
  try {
    // Fetch full version data
    const result = await api('/plans/' + currentPlanId + '/versions/' + versionId);
    const vData = result.version;
    if (!vData || !vData.data) throw new Error('Donn\u00e9es de version incompl\u00e8tes');

    const oldData = D ? JSON.parse(JSON.stringify(D)) : null;

    // Save restored version to plan (creates auto-snapshot of current state)
    const restored = vData.data;
    const constants = vData.constants || {};
    await api('/plans/' + currentPlanId, {
      method: 'PUT',
      body: JSON.stringify({
        data: restored,
        consultDay: constants.consultDay, fee: constants.fee, daysYear: constants.daysYear,
        revSpec: constants.revSpec, capex: constants.capex,
        versionLabel: 'Restauration v' + (vData.versionNumber || '?'),
      }),
    });

    // Update local state
    D = restored;
    D.consultDay = constants.consultDay || D.consultDay;
    D.fee = constants.fee || D.fee;
    D.daysYear = constants.daysYear || D.daysYear;
    D.revSpec = constants.revSpec || D.revSpec;
    D.capex = constants.capex || D.capex;
    computeDerived();
    updateUI();

    buildImportDiff(oldData, D, []);
    document.getElementById('statusLabel').textContent = 'Restaur\u00e9 \u00b7 v' + (vData.versionNumber || '?');
    document.getElementById('statusPill').className = 'status-pill live';
    document.getElementById('statusDot').className = 'status-dot live';

    closeVersionPanel();
  } catch(err) {
    console.error('Restore error:', err);
    alert('Erreur lors de la restauration: ' + (err.error || err.message || 'Erreur inconnue'));
  }
}

function computeDerived(){
  D.caY1=D.ca.slice(0,12).reduce((a,b)=>a+b,0);D.caY2=D.ca.slice(12,24).reduce((a,b)=>a+b,0);D.caY3=D.ca.slice(24,36).reduce((a,b)=>a+b,0);
  D.resY1=D.result.slice(0,12).reduce((a,b)=>a+b,0);D.resY2=D.result.slice(12,24).reduce((a,b)=>a+b,0);D.resY3=D.result.slice(24,36).reduce((a,b)=>a+b,0);
  const scenarios = computeScenarios(D.ca, D.admin, D.opex, D.lab, CASH_SHARE_BASE);
  D.tresoFact=scenarios.fact; D.tresoCash3m=scenarios.cash3m; D.tresoCash1m=scenarios.cash1m;
  D.bfrWorst=Math.min(...D.treso3m); D.bfrFact=Math.min(...D.tresoFact);
  D.bfrCash3m=Math.min(...D.tresoCash3m); D.bfrCash1m=Math.min(...D.tresoCash1m);
}

function computeScenarios(ca,admin,opex,lab,cashShare){
  let fact=[],cash3m=[],cash1m=[];
  let c1=0,c2=0,c3=0;
  for(let m=0;m<36;m++){
    c1+=ca[m]*cashShare+ca[m]*(1-cashShare)*(1-FACT_COST)+admin[m]+opex[m]+lab[m]; fact.push(c1);
    c2+=ca[m]*cashShare+(m>=3?ca[m-3]*(1-cashShare):0)+admin[m]+opex[m]+lab[m]; cash3m.push(c2);
    c3+=ca[m]*cashShare+(m>=1?ca[m-1]*(1-cashShare):0)+admin[m]+opex[m]+lab[m]; cash1m.push(c3);
  }
  return {fact,cash3m,cash1m};
}

// ===== UPDATE UI =====
function updateUI(){
  if(!D)return;
  const el=id=>document.getElementById(id);
  el('kCapex').textContent=fmt(D.capex); el('kCaY3').textContent=fmt(D.caY3); el('kCaY3b').textContent=fmt(D.caY3);
  el('kCaGrowth').textContent='Vitesse de croisi\u00e8re'; el('kResY3').textContent=fmt(D.resY3);
  el('kMargin').textContent='Marge ~'+Math.round(D.resY3/D.caY3*100)+'%';
  el('kRevSpec').textContent=fmt(D.revSpec); el('kCaY1').textContent=fmt(D.caY1); el('kCaY2').textContent=fmt(D.caY2);
  el('vTresoY3').textContent=fmtCHF(D.cashflow[35]);
  el('vCashMin').textContent=fmt(Math.abs(D.bfrWorst))+' CHF'; el('vCashOpt').textContent=fmt(Math.abs(D.bfrFact))+' CHF';
  el('scWorst').textContent=fmt(D.bfrWorst); el('scCash3m').textContent=fmt(D.bfrCash3m);
  el('scCash1m').textContent=fmt(D.bfrCash1m); el('scFact').textContent=fmt(D.bfrFact);
  el('kBfrSans').textContent=fmt(Math.abs(D.bfrWorst)); el('kBfrAvec').textContent=fmt(Math.abs(D.bfrFact));
  el('kFte6').textContent=D.fteTotal[5]||0; el('kFte12').textContent=D.fteTotal[11]||0;
  el('kFte24').textContent=D.fteTotal[23]||0; el('kFte36').textContent=D.fteTotal[35]||0;
  const adj=200000;
  el('pResY1').textContent=fmtCHF(D.resY1); el('pResY2').textContent=fmtCHF(D.resY2); el('pResY3').textContent=fmtCHF(D.resY3);
  el('pPerY1').textContent='~'+fmt(D.resY1/2)+' / associ\u00e9'; el('pPerY2').textContent='~'+fmt(D.resY2/2)+' / associ\u00e9'; el('pPerY3').textContent='~'+fmt(D.resY3/2)+' / associ\u00e9';
  el('pAdjY1').textContent='Apr\u00e8s charges manquantes: ~'+fmt(Math.max(0,D.resY1/2-adj/2)); el('pAdjY2').textContent='Apr\u00e8s charges manquantes: ~'+fmt(D.resY2/2-adj/2); el('pAdjY3').textContent='Apr\u00e8s charges manquantes: ~'+fmt(D.resY3/2-adj/2);
  el('stConsult').textContent=D.consultDay; el('stFee').textContent='CHF '+D.fee;
  el('pillsAssumptions').innerHTML='<div class="pill"><b>'+D.consultDay+'</b> consult./jour</div><div class="pill"><b>CHF '+D.fee+'</b> /consultation</div><div class="pill"><b>'+D.daysYear+'</b> jours/an</div><div class="pill"><b>60/40</b> partage associ\u00e9s</div>';
  let pb=36,cumR=0;for(let m=0;m<36;m++){cumR+=D.result[m];if(cumR>0&&D.result[m]>0){pb=m+1;break;}}
  el('kPayback').textContent=pb+' mois';
  updateCharts();
}

// ===== REVENUE PROFILE FILTERS =====
let revActiveProfiles = new Set(['assoc','indep','interne','sage']);

const REV_PROFILES = {
  assoc: {key:'caAssoc',fte:'fteAssoc',color:'#0f2b46',label:'Associ\u00e9s',share:'40% pour GynEva',css:'assoc'},
  indep: {key:'caIndep',fte:'fteIndep',color:'#1a4a7a',label:'Ind\u00e9pendants',share:'40% pour GynEva',css:'indep'},
  interne:{key:'caInterne',fte:'fteInterne',color:'#5dade2',label:'Internes',share:'100% pour GynEva',css:'interne'},
  sage:  {key:'caSage',fte:null,color:'#aed6f1',label:'Sage-femme',share:'Contribution nette',css:'sage'},
};

function toggleRevProfile(prof, btn){
  if(prof==='all'){
    revActiveProfiles=new Set(['assoc','indep','interne','sage']);
    document.querySelectorAll('.rev-prof').forEach(b=>b.classList.add('active'));
  } else {
    if(revActiveProfiles.has(prof)) revActiveProfiles.delete(prof); else revActiveProfiles.add(prof);
    btn.classList.toggle('active');
    if(revActiveProfiles.size===0){
      revActiveProfiles=new Set(['assoc','indep','interne','sage']);
      document.querySelectorAll('.rev-prof').forEach(b=>b.classList.add('active'));
    }
    const allBtn=document.querySelector('.rev-prof[data-prof="all"]');
    if(allBtn){if(revActiveProfiles.size===4) allBtn.classList.add('active'); else allBtn.classList.remove('active');}
  }
  updateRevenueChart();
  updateRevDetail();
}

function updateRevenueChart(){
  if(!D)return;
  if(charts.revenue){try{charts.revenue.destroy()}catch(e){}}
  const revDs=[];
  const profOrder=['assoc','indep','interne','sage'];
  profOrder.forEach(p=>{
    if(revActiveProfiles.has(p)){
      const pr=REV_PROFILES[p];
      revDs.push({label:pr.label,data:D[pr.key],backgroundColor:pr.color,borderRadius:1});
    }
  });
  if(OVERLAY){revDs.push({type:'line',label:'CA sc\u00e9nario',data:OVERLAY.ca,borderColor:'#d63031',borderWidth:2.5,borderDash:[6,3],pointRadius:0,tension:.3,fill:false,stack:false});}
  const single=revActiveProfiles.size===1;
  charts.revenue=new Chart(document.getElementById('cRevenue'),{
    type:'bar',
    data:{labels:labelsQ,datasets:revDs},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},
      scales:{x:{stacked:!single,grid:{display:false}},y:{stacked:!single,grid:gridOpts,ticks:{callback:v=>fmt(v)}}}
    },
    plugins:[yearPlugin]
  });
}

function updateRevDetail(){
  if(!D)return;
  const el=document.getElementById('revDetailGrid');
  if(!el)return;
  const sum12=(arr,s)=>arr.slice(s,s+12).reduce((a,b)=>a+b,0);
  const profOrder=['assoc','indep','interne','sage'];
  let html='';
  profOrder.forEach(p=>{
    if(!revActiveProfiles.has(p))return;
    const pr=REV_PROFILES[p];
    const arr=D[pr.key];
    const y1=sum12(arr,0),y2=sum12(arr,12),y3=sum12(arr,24);
    const totY1=D.caY1||1,totY2=D.caY2||1,totY3=D.caY3||1;
    const pctY1=Math.round(y1/totY1*100),pctY2=Math.round(y2/totY2*100),pctY3=Math.round(y3/totY3*100);
    let ramp='';
    if(pr.fte&&D[pr.fte]){
      const fteArr=D[pr.fte];
      let startM=0,maxM=0,maxV=Math.max(...fteArr);
      for(let i=0;i<36;i++){if(fteArr[i]>0){startM=i+1;break;}}
      for(let i=0;i<36;i++){if(fteArr[i]>=maxV&&maxV>0){maxM=i+1;break;}}
      if(startM>0) ramp='D\u00e9but mois '+startM+(maxM>startM?' \u2192 capacit\u00e9 max mois '+maxM:'');
    } else {
      let startM=0,stableM=0;
      for(let i=0;i<36;i++){if(arr[i]>0){startM=i+1;break;}}
      const maxV=Math.max(...arr);
      for(let i=0;i<36;i++){if(arr[i]>=maxV&&maxV>0){stableM=i+1;break;}}
      if(startM>0) ramp='D\u00e9but mois '+startM+(stableM>startM?' \u2192 stable mois '+stableM:'');
    }
    html+='<div class="rev-prof-card '+pr.css+'">';
    html+='<h4>'+pr.label+'</h4>';
    html+='<div class="prof-kpis">';
    html+='<div class="prof-kpi"><span class="pk-label">CA Ann\u00e9e 1</span><span class="pk-value">'+fmt(y1)+' ('+pctY1+'%)</span></div>';
    html+='<div class="prof-kpi"><span class="pk-label">CA Ann\u00e9e 2</span><span class="pk-value">'+fmt(y2)+' ('+pctY2+'%)</span></div>';
    html+='<div class="prof-kpi"><span class="pk-label">CA Ann\u00e9e 3</span><span class="pk-value">'+fmt(y3)+' ('+pctY3+'%)</span></div>';
    html+='<div class="prof-kpi"><span class="pk-label">Part GynEva</span><span class="pk-value">'+pr.share+'</span></div>';
    html+='</div>';
    if(ramp) html+='<div class="prof-ramp">\u2191 '+ramp+'</div>';
    html+='</div>';
  });
  el.innerHTML=html;
  // Update KPIs based on active filter
  const elId=id=>document.getElementById(id);
  if(revActiveProfiles.size===4){
    elId('kCaY1').textContent=fmt(D.caY1);
    elId('kCaY2').textContent=fmt(D.caY2);
    elId('kCaY3b').textContent=fmt(D.caY3);
  } else {
    let fY1=0,fY2=0,fY3=0;
    revActiveProfiles.forEach(p=>{
      const arr=D[REV_PROFILES[p].key];
      fY1+=sum12(arr,0); fY2+=sum12(arr,12); fY3+=sum12(arr,24);
    });
    elId('kCaY1').textContent=fmt(fY1);
    elId('kCaY2').textContent=fmt(fY2);
    elId('kCaY3b').textContent=fmt(fY3);
  }
}

// ===== CHARTS =====
const labels=Array.from({length:36},(_,i)=>'M'+(i+1));
const labelsQ=['','','M3','','','M6','','','M9','','','M12','','','M15','','','M18','','','M21','','','M24','','','M27','','','M30','','','M33','','','M36'];
const gridOpts={color:'rgba(0,0,0,.04)',drawBorder:false};
Chart.defaults.font.family="Inter,-apple-system,sans-serif";Chart.defaults.font.size=11;Chart.defaults.color='#636e72';
const yearPlugin={id:'yl',beforeDraw(c){const ctx=c.ctx,x=c.scales.x,y=c.scales.y;ctx.save();[11,23].forEach(i=>{if(i>=x.min&&i<=x.max){const px=x.getPixelForValue(i);ctx.strokeStyle='rgba(0,0,0,.08)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(px,y.top);ctx.lineTo(px,y.bottom);ctx.stroke()}});ctx.restore()}};

function updateCharts(){
  if(!D)return;
  Object.entries(charts).forEach(([k,c])=>{if(k!=='sim1'&&k!=='sim2'){try{c.destroy()}catch(e){}}});
  // Overview chart — with optional overlay
  const ovDs=[{label:"Chiffre d'affaires",data:[D.caY1,D.caY2,D.caY3],backgroundColor:'rgba(26,74,122,.8)',borderRadius:8,barPercentage:.6},{label:'R\u00e9sultat net',data:[D.resY1,D.resY2,D.resY3],backgroundColor:'rgba(0,184,148,.8)',borderRadius:8,barPercentage:.6}];
  if(OVERLAY){ovDs.push({label:'CA sc\u00e9nario',data:[OVERLAY.caY1,OVERLAY.caY2,OVERLAY.caY3],backgroundColor:'rgba(26,74,122,.25)',borderRadius:8,barPercentage:.6,borderWidth:2,borderColor:'rgba(26,74,122,.6)',borderDash:[4,4]});ovDs.push({label:'R\u00e9sultat sc\u00e9nario',data:[OVERLAY.resY1,OVERLAY.resY2,OVERLAY.resY3],backgroundColor:'rgba(0,184,148,.25)',borderRadius:8,barPercentage:.6,borderWidth:2,borderColor:'rgba(0,184,148,.6)',borderDash:[4,4]});}
  charts.overview=new Chart(document.getElementById('cOverview'),{type:'bar',data:{labels:['Ann\u00e9e 1','Ann\u00e9e 2','Ann\u00e9e 3'],datasets:ovDs},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:16}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}}});
  // Revenue chart — delegated to updateRevenueChart() for profile filter support
  updateRevenueChart();
  updateRevDetail();
  // Cashflow chart — with optional overlay line
  const cfDs=[{label:'Sans d\u00e9lai',data:D.cashflow,borderColor:'#00b894',backgroundColor:'rgba(0,184,148,.05)',fill:true,tension:.3,pointRadius:0,borderWidth:2},{label:'100% LAMal 3m',data:D.treso3m,borderColor:'#d63031',backgroundColor:'rgba(214,48,49,.03)',fill:true,tension:.3,pointRadius:0,borderWidth:2,borderDash:[6,3]},{label:'15% cash + Factoring',data:D.tresoFact,borderColor:'#1a4a7a',backgroundColor:'rgba(26,74,122,.05)',fill:true,tension:.3,pointRadius:0,borderWidth:2.5}];
  if(OVERLAY){cfDs.push({label:'Cashflow sc\u00e9nario',data:OVERLAY.cashflow,borderColor:'#e17055',borderWidth:2.5,borderDash:[6,3],pointRadius:0,tension:.3,fill:false});}
  charts.cashflow=new Chart(document.getElementById('cCashflow'),{type:'line',data:{labels:labelsQ,datasets:cfDs},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}},plugins:[yearPlugin]});
  charts.team=new Chart(document.getElementById('cTeam'),{type:'bar',data:{labels:labelsQ,datasets:[{label:'Associ\u00e9s',data:D.fteAssoc,backgroundColor:'#0f2b46',borderRadius:1},{label:'Ind\u00e9pendants',data:D.fteIndep,backgroundColor:'#1a4a7a',borderRadius:1},{label:'Internes',data:D.fteInterne,backgroundColor:'#5dade2',borderRadius:1},{label:'Personnel admin',data:D.fteAdmin,backgroundColor:'#aed6f1',borderRadius:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true,grid:gridOpts,title:{display:true,text:'ETP'}}}},plugins:[yearPlugin]});
  charts.profit=new Chart(document.getElementById('cProfit'),{type:'bar',data:{labels:['Ann\u00e9e 1','Ann\u00e9e 2','Ann\u00e9e 3'],datasets:[{label:'R\u00e9sultat brut / associ\u00e9',data:[D.resY1/2,D.resY2/2,D.resY3/2],backgroundColor:'rgba(26,74,122,.8)',borderRadius:8,barPercentage:.5},{label:'Apr\u00e8s charges manquantes',data:[Math.max(0,D.resY1/2-100000),D.resY2/2-100000,D.resY3/2-100000],backgroundColor:'rgba(0,184,148,.8)',borderRadius:8,barPercentage:.5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:16}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)+' CHF'}},x:{grid:{display:false}}}}});
  charts.optimize=new Chart(document.getElementById('cOptimize'),{type:'line',data:{labels:labelsQ,datasets:[{label:'100% LAMal 3m (pire)',data:D.treso3m,borderColor:'#d63031',tension:.3,pointRadius:0,borderWidth:2,borderDash:[6,3]},{label:'15% cash + LAMal 3m',data:D.tresoCash3m,borderColor:'#e17055',tension:.3,pointRadius:0,borderWidth:2},{label:'15% cash + Factoring',data:D.tresoFact,borderColor:'#00b894',tension:.3,pointRadius:0,borderWidth:2.5},{label:'Sans d\u00e9lai',data:D.cashflow,borderColor:'#b2bec3',tension:.3,pointRadius:0,borderWidth:1.5,borderDash:[3,3]}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}},plugins:[yearPlugin]});
}

// ===== SIMULATOR ENGINE =====
const BASE = {consult:16, fee:225, days:215, assoc:2, indep:3, interne:2, start:4, occup:60, cashPct:15, delay:1, factoring:true, extra:200000, rc:60000};

// Pure simulation function (no DOM side effects)
function computeSimulation(params){
  const V={
    consult:params.consult, fee:params.fee, days:params.days,
    assoc:params.assoc, indep:params.indep, interne:params.interne,
    start:params.start, occup:params.occup/100, cashPct:params.cashPct/100,
    delay:params.delay, factoring:params.factoring,
    extra:params.extra, rc:params.rc
  };
  const annualCA_per_spec = V.consult * V.fee * V.days;
  const monthlyCA_per_spec = annualCA_per_spec/12;
  const simCA=[], simResult=[], simCashflow=[];
  let cumCash=0;
  for(let m=0;m<36;m++){
    const year=m<12?1:m<24?2:3;
    let occ=0;
    if(m >= V.start-1){
      const monthsSinceStart = m - (V.start-1);
      if(year===1) occ = Math.min(V.occup, V.occup * Math.min(1, (monthsSinceStart+1)/8));
      else if(year===2) occ = Math.min(1, V.occup + (1-V.occup)*0.6);
      else occ = 1;
    }
    const caAssoc = monthlyCA_per_spec * V.assoc * occ * 0.4;
    const caIndep = monthlyCA_per_spec * V.indep * occ * 0.4;
    const caInterne = monthlyCA_per_spec * V.interne * occ;
    const caSage = occ > 0 ? 13333 : 0;
    const totalCA = caAssoc + caIndep + caInterne + caSage;
    const baseMonthlyAdmin = 52650 * (1 + (V.assoc+V.indep+V.interne-7)*0.08);
    const baseMonthlyOpex = 45584 * (1 + (V.assoc+V.indep+V.interne-7)*0.05);
    const totalCosts = -(Math.abs(baseMonthlyAdmin) + Math.abs(baseMonthlyOpex)) * occ - (V.extra+V.rc)/12;
    const salInterne = monthlyCA_per_spec * V.interne * occ * 0.55;
    const netResult = totalCA + totalCosts - salInterne*(occ>0?1:0);
    simCA.push(totalCA);
    simResult.push(netResult);
    let cashIn = 0;
    if(V.factoring){
      cashIn = totalCA * V.cashPct + totalCA * (1-V.cashPct) * (1-FACT_COST);
    } else {
      cashIn = totalCA * V.cashPct;
      if(m >= V.delay) cashIn += simCA[m-V.delay] * (1-V.cashPct);
    }
    cumCash += cashIn + totalCosts - salInterne*(occ>0?1:0);
    simCashflow.push(cumCash);
  }
  const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
  return {
    ca:simCA, result:simResult, cashflow:simCashflow,
    caY1:sum(simCA,0,12), caY2:sum(simCA,12,24), caY3:sum(simCA,24,36),
    resY1:sum(simResult,0,12), resY2:sum(simResult,12,24), resY3:sum(simResult,24,36),
    resAdj:sum(simResult,24,36) - params.extra - params.rc,
    perAssoc:(sum(simResult,24,36) - params.extra - params.rc)/params.assoc,
    bfrMin:Math.min(...simCashflow), tresoFinal:simCashflow[35]
  };
}

function resetSim(){
  document.getElementById('sConsult').value=BASE.consult;
  document.getElementById('sFee').value=BASE.fee;
  document.getElementById('sDays').value=BASE.days;
  document.getElementById('sAssoc').value=BASE.assoc;
  document.getElementById('sIndep').value=BASE.indep;
  document.getElementById('sInterne').value=BASE.interne;
  document.getElementById('sStart').value=BASE.start;
  document.getElementById('sOccup').value=BASE.occup;
  document.getElementById('sCash').value=BASE.cashPct;
  document.getElementById('sDelay').value=BASE.delay;
  document.getElementById('sExtra').value=BASE.extra;
  document.getElementById('sRC').value=BASE.rc;
  const ft=document.getElementById('sFactToggle');if(!ft.classList.contains('on'))ft.classList.add('on');
  runSim();
}

function getSimParams() {
  const el=id=>document.getElementById(id);
  return {
    consult:+el('sConsult').value, fee:+el('sFee').value, days:+el('sDays').value,
    assoc:+el('sAssoc').value, indep:+el('sIndep').value, interne:+el('sInterne').value,
    start:+el('sStart').value, occup:+el('sOccup').value, cashPct:+el('sCash').value,
    delay:+el('sDelay').value, factoring:el('sFactToggle').classList.contains('on'),
    extra:+el('sExtra').value, rc:+el('sRC').value
  };
}

function setSimParams(p) {
  const el=id=>document.getElementById(id);
  el('sConsult').value=p.consult; el('sFee').value=p.fee; el('sDays').value=p.days;
  el('sAssoc').value=p.assoc; el('sIndep').value=p.indep; el('sInterne').value=p.interne;
  el('sStart').value=p.start; el('sOccup').value=p.occup;
  el('sCash').value=p.cashPct; el('sDelay').value=p.delay;
  el('sExtra').value=p.extra; el('sRC').value=p.rc;
  const ft=el('sFactToggle');
  if(p.factoring && !ft.classList.contains('on')) ft.classList.add('on');
  if(!p.factoring && ft.classList.contains('on')) ft.classList.remove('on');
  runSim();
}

// Shared delta helper (sim vs base comparison badge)
function simDelta(simVal, baseVal){
  if(!baseVal||!D)return '';
  const d=((simVal/baseVal-1)*100);
  if(Math.abs(d)<1) return '<span class="sim-delta neutral">= base</span>';
  return '<span class="sim-delta '+(d>0?'up':'down')+'">'+(d>0?'+':'')+d.toFixed(0)+'%</span>';
}

function runSim(){
  const el=id=>document.getElementById(id);
  const params = getSimParams();

  el('sConsultVal').textContent=params.consult; el('sFeeVal').textContent=params.fee; el('sDaysVal').textContent=params.days;
  el('sAssocVal').textContent=params.assoc; el('sIndepVal').textContent=params.indep; el('sInterneVal').textContent=params.interne;
  el('sStartVal').textContent=params.start; el('sOccupVal').textContent=params.occup+'%';
  el('sCashVal').textContent=params.cashPct+'%';
  el('sExtraVal').textContent=fmt(params.extra); el('sRCVal').textContent=fmt(params.rc);

  const sim = computeSimulation(params);
  const simCA=sim.ca, simResult=sim.result, simCashflow=sim.cashflow;
  const simCaY1=sim.caY1, simCaY2=sim.caY2, simCaY3=sim.caY3;
  const simResY1=sim.resY1, simResY2=sim.resY2, simResY3=sim.resY3;
  const simResAdj=sim.resAdj, simPerAssoc=sim.perAssoc;

  SIM={ca:simCA,result:simResult,cashflow:simCashflow,caY1:simCaY1,caY2:simCaY2,caY3:simCaY3,resY1:simResY1,resY2:simResY2,resY3:simResY3};

  // Populate year overview timeline
  el('simOvCaY1').textContent='CA '+fmt(simCaY1);
  el('simOvResY1').innerHTML='R\u00e9s. '+fmt(simResY1);
  el('simOvDeltaY1').innerHTML=simDelta(simCaY1,D?D.caY1:1);
  el('simOvCaY2').textContent='CA '+fmt(simCaY2);
  el('simOvResY2').innerHTML='R\u00e9s. '+fmt(simResY2);
  el('simOvDeltaY2').innerHTML=simDelta(simCaY2,D?D.caY2:1);
  el('simOvCaY3').textContent='CA '+fmt(simCaY3);
  el('simOvResY3').innerHTML='R\u00e9s. '+fmt(simResY3);
  el('simOvDeltaY3').innerHTML=simDelta(simCaY3,D?D.caY3:1);

  // Structured per-year summary
  const summaryData = [
    {year:'1',cls:'y1',ca:simCaY1,res:simResY1,notes:[
      'D\u00e9but activit\u00e9 mois '+params.start+', occupation '+params.occup+'%',
      params.delay>=3?'<strong style="color:var(--danger)">\u26a0 D\u00e9lai '+params.delay+'m impacte la tr\u00e9so Y1</strong>':'D\u00e9lai paiement '+params.delay+' mois',
      params.factoring?'Factoring actif \u2014 BFR s\u00e9curis\u00e9':'Sans factoring',
      'Tr\u00e9so min : '+fmtCHF(Math.min(...simCashflow.slice(0,12)))]},
    {year:'2',cls:'y2',ca:simCaY2,res:simResY2,notes:[
      'Mont\u00e9e en puissance \u2014 occupation ~'+Math.round(Math.min(100,params.occup+(100-params.occup)*0.6))+'%',
      'CA : '+fmtCHF(simCaY2)+(simCaY1>0?' (+'+Math.round((simCaY2/simCaY1-1)*100)+'% vs Y1)':''),
      'R\u00e9sultat : '+fmtCHF(simResY2)]},
    {year:'3',cls:'y3',ca:simCaY3,res:simResY3,notes:[
      'Vitesse de croisi\u00e8re \u2014 pleine capacit\u00e9',
      'CA : '+fmtCHF(simCaY3),
      'R\u00e9sultat ajust\u00e9 : '+fmtCHF(simResAdj)+' (apr\u00e8s '+fmt(params.extra)+' charges + '+fmt(params.rc)+' RC)',
      'Par associ\u00e9 : '+fmtCHF(simPerAssoc),
      'Tr\u00e9so finale : '+fmtCHF(simCashflow[35])]}
  ];
  el('simSummary').innerHTML=summaryData.map(s=>
    '<div class="sim-summary-yr '+s.cls+'"><h4>Ann\u00e9e '+s.year+' \u2014 CA '+fmt(s.ca)+' | R\u00e9s. '+fmt(s.res)+'</h4><ul>'+
    s.notes.map(n=>'<li>'+n+'</li>').join('')+'</ul></div>'
  ).join('');

  updateSimYearDetail();
  updateSimCharts();
}

// ===== YEAR TAB SWITCHING =====
function switchSimYear(year, btn) {
  simActiveYear = year;
  document.querySelectorAll('.sim-tab').forEach(t=>t.classList.remove('active'));
  if(btn) btn.classList.add('active');
  document.querySelectorAll('.sim-year-overview .profit-yr').forEach(c=>c.classList.remove('highlight'));
  if(year!=='all'){
    const card=document.getElementById('simYrCard'+year);
    if(card) card.classList.add('highlight');
  }
  updateSimYearDetail();
  updateSimCharts();
}

function updateSimYearDetail() {
  if(!SIM) return;
  const el=id=>document.getElementById(id);
  const params=getSimParams();
  const year=simActiveYear;
  const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);

  const perYear={
    '1':{ca:SIM.caY1,res:SIM.resY1,s:0,e:12},
    '2':{ca:SIM.caY2,res:SIM.resY2,s:12,e:24},
    '3':{ca:SIM.caY3,res:SIM.resY3,s:24,e:36}
  };
  for(const k of['1','2','3']){
    const y=perYear[k];
    y.resAdj=y.res-(params.extra+params.rc)/3;
    y.perAssoc=y.resAdj/params.assoc;
    y.tresoMin=Math.min(...SIM.cashflow.slice(y.s,y.e));
    y.tresoEnd=SIM.cashflow[y.e-1];
    y.baseCa=D?(k==='1'?D.caY1:k==='2'?D.caY2:D.caY3):0;
    y.baseRes=D?(k==='1'?D.resY1:k==='2'?D.resY2:D.resY3):0;
  }

  // Verdict
  const verdictEl=el('simYearVerdict');
  if(year==='all'){
    verdictEl.style.display='none';
  } else {
    verdictEl.style.display='';
    const y=perYear[year];
    let cls,icon,text;
    if(year==='1'){
      const isBfrRisk=y.tresoMin<-100000;
      cls=isBfrRisk?'red':y.res<0?'orange':'green';
      icon=isBfrRisk?'\u26a0\ufe0f':'\u2699\ufe0f';
      text='<strong>Ann\u00e9e 1 \u2014 D\u00e9marrage.</strong> Phase de mont\u00e9e en charge'
        +(params.start>1?' (d\u00e9but mois '+params.start+')':'')+', occupation \u00e0 '+params.occup+'%.'
        +(params.delay>=3?' <strong>Le d\u00e9lai de paiement de '+params.delay+' mois impacte fortement la tr\u00e9sorerie Y1.</strong>':'')
        +(isBfrRisk?' <span style="color:var(--danger)">Risque BFR : tr\u00e9sorerie min '+fmtCHF(y.tresoMin)+'</span>':'')
        +' R\u00e9sultat attendu : '+fmtCHF(y.res)+'.';
    } else if(year==='2'){
      cls=y.res>0?'green':'orange';
      icon='\ud83d\udcc8';
      text='<strong>Ann\u00e9e 2 \u2014 Croissance.</strong> Occupation en hausse vers ~'
        +Math.round(Math.min(100,params.occup+(100-params.occup)*0.6))+'%. '
        +'Le d\u00e9lai de paiement n\'impacte plus la tr\u00e9sorerie. '
        +'R\u00e9sultat attendu : '+fmtCHF(y.res)+'.';
    } else {
      cls=y.resAdj>0?'green':y.res>0?'orange':'red';
      icon='\u2705';
      text='<strong>Ann\u00e9e 3 \u2014 Vitesse de croisi\u00e8re.</strong> Pleine capacit\u00e9, '
        +params.assoc+' associ\u00e9'+(params.assoc>1?'s':'')+'. R\u00e9sultat ajust\u00e9 : '+fmtCHF(y.resAdj)
        +', soit '+fmtCHF(y.perAssoc)+' par associ\u00e9.';
    }
    verdictEl.className='verdict '+cls;
    verdictEl.innerHTML='<div class="ic">'+icon+'</div><div>'+text+'</div>';
  }

  // KPIs
  const kpiC=el('simYearKpis');
  if(year==='all'){
    let html='';
    for(const k of['1','2','3']){
      const y=perYear[k];
      const caC=y.ca>y.baseCa*0.9?'green':'orange';
      const resC=y.res>0?'green':y.res>-50000?'orange':'red';
      html+='<div class="kpi '+caC+'"><div class="lb">CA Ann\u00e9e '+k+'</div><div class="vl">'+fmt(y.ca)+'</div><div class="sb">vs base '+fmt(y.baseCa)+' '+simDelta(y.ca,y.baseCa)+'</div></div>';
      html+='<div class="kpi '+resC+'"><div class="lb">R\u00e9sultat Y'+k+'</div><div class="vl">'+fmt(y.res)+'</div><div class="sb">vs base '+fmt(y.baseRes)+' '+simDelta(y.res,y.baseRes)+'</div></div>';
    }
    kpiC.innerHTML=html;
  } else {
    const y=perYear[year];
    const caC=y.ca>y.baseCa*0.9?'green':'orange';
    const resC=y.res>0?'green':y.res>-50000?'orange':'red';
    const adjC=y.resAdj>0?'green':'orange';
    const tresoC=y.tresoMin>=0?'green':y.tresoMin>-250000?'orange':'red';
    kpiC.innerHTML=
      '<div class="kpi '+caC+'"><div class="lb">CA Ann\u00e9e '+year+'</div><div class="vl">'+fmt(y.ca)+'</div><div class="sb">vs base '+fmt(y.baseCa)+' '+simDelta(y.ca,y.baseCa)+'</div></div>'+
      '<div class="kpi '+resC+'"><div class="lb">R\u00e9sultat brut Y'+year+'</div><div class="vl">'+fmt(y.res)+'</div><div class="sb">vs base '+fmt(y.baseRes)+' '+simDelta(y.res,y.baseRes)+'</div></div>'+
      '<div class="kpi '+adjC+'"><div class="lb">R\u00e9sultat ajust\u00e9 Y'+year+'</div><div class="vl">'+fmt(y.resAdj)+'</div><div class="sb">Apr\u00e8s charges + RC (prorata)</div></div>'+
      '<div class="kpi blue"><div class="lb">Par associ\u00e9 Y'+year+'</div><div class="vl">'+fmt(y.perAssoc)+'</div><div class="sb">'+params.assoc+' associ\u00e9'+(params.assoc>1?'s':'')+'</div></div>'+
      '<div class="kpi '+tresoC+'"><div class="lb">Tr\u00e9so min Y'+year+'</div><div class="vl">'+fmt(y.tresoMin)+'</div><div class="sb">Point le plus bas</div></div>'+
      '<div class="kpi blue"><div class="lb">Tr\u00e9so fin Y'+year+'</div><div class="vl">'+fmt(y.tresoEnd)+'</div><div class="sb">Cumul fin de p\u00e9riode</div></div>';
  }

  // Sensitivity tags
  const sensEl=el('simSensitivity');
  if(year==='all'){sensEl.innerHTML='';return;}
  sensEl.innerHTML=getYearSensitivity(year,params).map(t=>
    '<span class="sens-tag '+t.level+'">'+t.label+'</span>'
  ).join('');
}

function getYearSensitivity(year, params) {
  const tags=[];
  if(year==='1'){
    tags.push({label:'\u26a0 D\u00e9lai paiement : impact '+(params.delay>=3?'FORT':'mod\u00e9r\u00e9'),level:params.delay>=3?'high':params.delay>=1?'medium':'low'});
    tags.push({label:'\ud83d\ude80 Mois d\u00e9but ('+params.start+') : impact '+(params.start>6?'FORT':params.start>3?'mod\u00e9r\u00e9':'faible'),level:params.start>6?'high':params.start>3?'medium':'low'});
    tags.push({label:'\ud83d\udcca Occupation '+params.occup+'% : impact FORT',level:params.occup<50?'high':params.occup<70?'medium':'low'});
    tags.push(params.factoring?{label:'\u2705 Factoring actif : s\u00e9curise BFR',level:'low'}:{label:'\u26a0 Sans factoring : risque BFR',level:'high'});
    tags.push({label:'\ud83c\udfe5 Cash OI '+params.cashPct+'% : impact moyen',level:params.cashPct>20?'low':'medium'});
  } else if(year==='2'){
    tags.push({label:'\ud83d\udcc8 Volume (consult/honor.) : levier principal',level:'medium'});
    tags.push({label:'\ud83d\udc65 \u00c9quipe ('+(params.assoc+params.indep+params.interne)+' m\u00e9d.) : impact croissant',level:'medium'});
    tags.push({label:'\u23f0 D\u00e9lai paiement : faible impact',level:'low'});
    tags.push({label:'\ud83d\udcb0 Charges extra : impact '+(params.extra>200000?'mod\u00e9r\u00e9':'faible'),level:params.extra>200000?'medium':'low'});
  } else {
    tags.push({label:'\ud83d\udcc8 Volume (consult/honor.) : levier principal',level:'medium'});
    tags.push({label:'\ud83d\udc65 \u00c9quipe ('+(params.assoc+params.indep+params.interne)+' m\u00e9d.) : levier principal',level:'medium'});
    tags.push({label:'\ud83d\udcb0 Charges extra '+fmt(params.extra)+' : impact direct',level:params.extra>300000?'high':'medium'});
    tags.push({label:'\u23f0 D\u00e9lai paiement : aucun impact',level:'low'});
  }
  return tags;
}

// ===== SIM CHARTS =====
const yearHighlightPlugin={id:'yearHL',beforeDraw(chart){
  if(simActiveYear==='all')return;
  const ctx=chart.ctx,x=chart.scales.x,y=chart.scales.y;
  const yi=parseInt(simActiveYear);
  const s=(yi-1)*12, e=yi*12-1;
  if(s>x.max||e<x.min)return;
  const xS=x.getPixelForValue(Math.max(s,x.min)), xE=x.getPixelForValue(Math.min(e,x.max));
  ctx.save();
  ctx.fillStyle='rgba(26,74,122,.04)';
  ctx.fillRect(xS,y.top,xE-xS,y.bottom-y.top);
  ctx.fillStyle='rgba(26,74,122,.5)';
  ctx.font='bold 11px Inter,sans-serif';
  ctx.fillText('Ann\u00e9e '+simActiveYear,xS+4,y.top+14);
  ctx.restore();
}};

function updateSimCharts(){
  if(!SIM)return;
  try{charts.sim1?.destroy()}catch(e){}
  try{charts.sim2?.destroy()}catch(e){}

  const bA=simActiveYear==='all'?[.7,.7,.7]:['1','2','3'].map(y=>y===simActiveYear?.9:.15);
  const bB=simActiveYear==='all'?[.2,.2,.2]:['1','2','3'].map(y=>y===simActiveYear?.3:.06);

  charts.sim1=new Chart(document.getElementById('cSim1'),{type:'bar',data:{labels:['Ann\u00e9e 1','Ann\u00e9e 2','Ann\u00e9e 3'],datasets:[
    {label:"CA simul\u00e9",data:[SIM.caY1,SIM.caY2,SIM.caY3],backgroundColor:bA.map(a=>'rgba(26,74,122,'+a+')'),borderRadius:8,barPercentage:.5},
    {label:'CA base',data:[D.caY1,D.caY2,D.caY3],backgroundColor:bB.map(a=>'rgba(26,74,122,'+a+')'),borderRadius:8,barPercentage:.5,borderWidth:1,borderColor:'rgba(26,74,122,.4)',borderDash:[4,4]},
    {label:'R\u00e9sultat simul\u00e9',data:[SIM.resY1,SIM.resY2,SIM.resY3],backgroundColor:bA.map(a=>'rgba(0,184,148,'+a+')'),borderRadius:8,barPercentage:.5},
    {label:'R\u00e9sultat base',data:[D.resY1,D.resY2,D.resY3],backgroundColor:bB.map(a=>'rgba(0,184,148,'+a+')'),borderRadius:8,barPercentage:.5,borderWidth:1,borderColor:'rgba(0,184,148,.4)'}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}}});

  charts.sim2=new Chart(document.getElementById('cSim2'),{type:'line',data:{labels:labelsQ,datasets:[
    {label:'Tr\u00e9sorerie simul\u00e9e',data:SIM.cashflow,borderColor:'#1a4a7a',backgroundColor:'rgba(26,74,122,.06)',fill:true,tension:.3,pointRadius:0,borderWidth:2.5},
    {label:'Tr\u00e9sorerie base',data:D.cashflow,borderColor:'#b2bec3',tension:.3,pointRadius:0,borderWidth:1.5,borderDash:[4,4]},
    {label:'Seuil 0',data:Array(36).fill(0),borderColor:'rgba(214,48,49,.3)',borderWidth:1,pointRadius:0,borderDash:[2,2]}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}},plugins:[yearPlugin,yearHighlightPlugin]});
}

// ===== SCENARIO SAVE/LOAD =====
async function saveScenario() {
  const name = prompt('Nom du sc\u00e9nario :');
  if (!name) return;
  try {
    await api('/scenarios', {
      method: 'POST',
      body: JSON.stringify({
        name,
        params: getSimParams(),
        businessPlanId: currentPlanId || undefined,
      }),
    });
    refreshOverlayScenarios();
  } catch(err) {
    console.error('Save scenario error:', err);
  }
}

async function toggleScenarioList() {
  const list = document.getElementById('scenarioList');
  if (list.classList.contains('show')) {
    list.classList.remove('show');
    return;
  }
  try {
    const result = await api('/scenarios');
    list.innerHTML = result.scenarios.map(s =>
      '<div class="scenario-item" onclick="loadScenario(\''+s.id+'\')">'+
        '<span>'+s.name+'</span>'+
        '<button class="del" onclick="event.stopPropagation();deleteScenario(\''+s.id+'\')">\u2717</button>'+
      '</div>'
    ).join('') || '<div class="scenario-item">Aucun sc\u00e9nario sauvegard\u00e9</div>';
    list.classList.add('show');
  } catch(err) {
    console.error('Load scenarios error:', err);
  }
}

async function loadScenario(id) {
  try {
    const result = await api('/scenarios/' + id);
    setSimParams(result.scenario.params);
    document.getElementById('scenarioList').classList.remove('show');
  } catch(err) {
    console.error('Load scenario error:', err);
  }
}

async function deleteScenario(id) {
  try {
    await api('/scenarios/' + id, { method: 'DELETE' });
    toggleScenarioList(); // refresh
    toggleScenarioList();
  } catch(err) {
    console.error('Delete scenario error:', err);
  }
}

// ===== ADMIN =====
async function loadAdminData() {
  try {
    const result = await api('/admin/users');
    const list = document.getElementById('adminEmailList');
    list.innerHTML = result.allowedEmails.map(e =>
      '<li><span>'+e.email+'</span>' +
      (e.email !== currentUser?.email ?
        '<button class="btn-reset" onclick="removeAllowedEmail(\''+e.email+'\')">\u2717 Retirer</button>' :
        '<span style="font-size:.7rem;color:var(--txtL)">(vous)</span>') +
      '</li>'
    ).join('');
  } catch(err) {
    console.error('Admin load error:', err);
  }
}

async function addAllowedEmail() {
  const input = document.getElementById('adminNewEmail');
  const email = input.value.trim();
  if (!email) return;
  try {
    await api('/admin/users', {
      method: 'POST',
      body: JSON.stringify({ email }),
    });
    input.value = '';
    loadAdminData();
  } catch(err) {
    console.error('Add email error:', err);
  }
}

async function removeAllowedEmail(email) {
  try {
    await api('/admin/users?email=' + encodeURIComponent(email), { method: 'DELETE' });
    loadAdminData();
  } catch(err) {
    console.error('Remove email error:', err);
  }
}

// ===== SCENARIO OVERLAY =====
async function refreshOverlayScenarios() {
  try {
    const result = await api('/scenarios');
    const select = document.getElementById('overlayScenarioSelect');
    const current = select.value;
    select.innerHTML = '<option value="">Aucun (d\u00e9sactiv\u00e9)</option>';
    (result.scenarios || []).forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.name;
      select.appendChild(opt);
    });
    if (current) select.value = current;
    document.getElementById('overlayControl').style.display = (result.scenarios && result.scenarios.length > 0) ? 'flex' : 'none';
  } catch(err) {
    console.error('Load overlay scenarios error:', err);
  }
}

async function applyScenarioOverlay() {
  const scenarioId = document.getElementById('overlayScenarioSelect').value;
  const dot = document.getElementById('overlayDot');
  if (!scenarioId) {
    OVERLAY = null;
    overlayScenarioId = null;
    dot.classList.remove('active');
    updateCharts();
    return;
  }
  try {
    const result = await api('/scenarios/' + scenarioId);
    const sim = computeSimulation(result.scenario.params);
    OVERLAY = sim;
    overlayScenarioId = scenarioId;
    dot.classList.add('active');
    updateCharts();
  } catch(err) {
    console.error('Apply overlay error:', err);
  }
}

// ===== VERSION COMPARISON =====
let compareCharts = {};

async function openCompare() {
  const modal = document.getElementById('compareModal');
  modal.classList.add('open');
  document.getElementById('compareContent').innerHTML = '';
  // Destroy old compare charts
  Object.values(compareCharts).forEach(c => { try{c.destroy()}catch(e){} });
  compareCharts = {};
  // Populate selects
  try {
    const result = await api('/plans/' + currentPlanId + '/versions');
    const versions = result.versions || [];
    const leftSel = document.getElementById('compareLeft');
    const rightSel = document.getElementById('compareRight');
    const currentOpt = '<option value="current">Donn\u00e9es actuelles</option>';
    const versionOpts = versions.map(v => {
      const d = new Date(v.createdAt).toLocaleDateString('fr-CH',{day:'numeric',month:'short'});
      return '<option value="'+v.id+'">v'+v.versionNumber+' \u2014 '+escHTML(v.label||'Sans label')+' ('+d+')</option>';
    }).join('');
    leftSel.innerHTML = currentOpt + versionOpts;
    rightSel.innerHTML = currentOpt + versionOpts;
    if (versions.length > 0) rightSel.value = versions[0].id;
  } catch(err) {
    console.error('Open compare error:', err);
  }
}

function closeCompare() {
  document.getElementById('compareModal').classList.remove('open');
  Object.values(compareCharts).forEach(c => { try{c.destroy()}catch(e){} });
  compareCharts = {};
}

async function fetchVersionData(val) {
  if (val === 'current') {
    const d = JSON.parse(JSON.stringify(D));
    const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
    d.caY1=sum(d.ca,0,12);d.caY2=sum(d.ca,12,24);d.caY3=sum(d.ca,24,36);
    d.resY1=sum(d.result,0,12);d.resY2=sum(d.result,12,24);d.resY3=sum(d.result,24,36);
    return d;
  }
  const result = await api('/plans/' + currentPlanId + '/versions/' + val);
  const v = result.version;
  const d = { ...v.data, ...(v.constants || {}) };
  const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
  d.caY1=sum(d.ca,0,12);d.caY2=sum(d.ca,12,24);d.caY3=sum(d.ca,24,36);
  d.resY1=sum(d.result,0,12);d.resY2=sum(d.result,12,24);d.resY3=sum(d.result,24,36);
  return d;
}

async function runCompare() {
  try {
    const leftVal = document.getElementById('compareLeft').value;
    const rightVal = document.getElementById('compareRight').value;
    const left = await fetchVersionData(leftVal);
    const right = await fetchVersionData(rightVal);

    // Build comparison grid
    const metrics = [
      {label:'CA Ann\u00e9e 1',l:left.caY1,r:right.caY1},
      {label:'CA Ann\u00e9e 2',l:left.caY2,r:right.caY2},
      {label:'CA Ann\u00e9e 3',l:left.caY3,r:right.caY3},
      {label:'R\u00e9sultat Ann\u00e9e 1',l:left.resY1,r:right.resY1},
      {label:'R\u00e9sultat Ann\u00e9e 2',l:left.resY2,r:right.resY2},
      {label:'R\u00e9sultat Ann\u00e9e 3',l:left.resY3,r:right.resY3},
      {label:'CAPEX',l:left.capex||0,r:right.capex||0},
      {label:'Honoraires (CHF)',l:left.fee||0,r:right.fee||0},
      {label:'Consult./jour',l:left.consultDay||0,r:right.consultDay||0},
      {label:'ETP max',l:Math.max(...(left.fteTotal||[0])),r:Math.max(...(right.fteTotal||[0]))},
    ];

    function deltaHTML(l,r) {
      if (!l && !r) return '<span class="delta-badge zero">=</span>';
      const d = l ? ((r/l-1)*100) : (r ? 100 : 0);
      if (Math.abs(d) < 0.5) return '<span class="delta-badge zero">=</span>';
      return '<span class="delta-badge '+(d>0?'pos':'neg')+'">'+(d>0?'+':'')+d.toFixed(0)+'%</span>';
    }

    let html = '<div class="compare-grid">';
    html += '<div class="cg-head">M\u00e9trique</div><div class="cg-head">Gauche</div><div class="cg-head">Droite</div><div class="cg-head">Delta</div>';
    metrics.forEach(m => {
      html += '<div class="cg-cell label">'+m.label+'</div>';
      html += '<div class="cg-cell num">'+fmtCHF(m.l)+'</div>';
      html += '<div class="cg-cell num">'+fmtCHF(m.r)+'</div>';
      html += '<div class="cg-cell num">'+deltaHTML(m.l,m.r)+'</div>';
    });
    html += '</div>';
    document.getElementById('compareContent').innerHTML = html;

    // Charts
    Object.values(compareCharts).forEach(c => { try{c.destroy()}catch(e){} });

    compareCharts.overview = new Chart(document.getElementById('cCompareOverview'),{type:'bar',data:{labels:['Ann\u00e9e 1','Ann\u00e9e 2','Ann\u00e9e 3'],datasets:[
      {label:'CA gauche',data:[left.caY1,left.caY2,left.caY3],backgroundColor:'rgba(26,74,122,.8)',borderRadius:6,barPercentage:.5},
      {label:'CA droite',data:[right.caY1,right.caY2,right.caY3],backgroundColor:'rgba(26,74,122,.3)',borderRadius:6,barPercentage:.5,borderWidth:2,borderColor:'rgba(26,74,122,.6)',borderDash:[4,4]},
      {label:'R\u00e9s. gauche',data:[left.resY1,left.resY2,left.resY3],backgroundColor:'rgba(0,184,148,.8)',borderRadius:6,barPercentage:.5},
      {label:'R\u00e9s. droite',data:[right.resY1,right.resY2,right.resY3],backgroundColor:'rgba(0,184,148,.3)',borderRadius:6,barPercentage:.5,borderWidth:2,borderColor:'rgba(0,184,148,.6)',borderDash:[4,4]}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:10,font:{size:11}}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}}});

    compareCharts.cashflow = new Chart(document.getElementById('cCompareCashflow'),{type:'line',data:{labels:labelsQ,datasets:[
      {label:'Cashflow gauche',data:left.cashflow,borderColor:'#1a4a7a',tension:.3,pointRadius:0,borderWidth:2.5,fill:false},
      {label:'Cashflow droite',data:right.cashflow,borderColor:'#d63031',tension:.3,pointRadius:0,borderWidth:2.5,borderDash:[6,3],fill:false},
      {label:'Seuil 0',data:Array(36).fill(0),borderColor:'rgba(99,110,114,.2)',borderWidth:1,pointRadius:0,borderDash:[2,2]}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:10,font:{size:11}}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}},plugins:[yearPlugin]});

  } catch(err) {
    console.error('Run compare error:', err);
    document.getElementById('compareContent').innerHTML = '<div style="color:var(--danger);padding:1rem">Erreur lors de la comparaison : '+escHTML(err.message || 'Erreur inconnue')+'</div>';
  }
}

function printCompare() {
  const app = document.getElementById('app-content');
  const modal = document.getElementById('compareModal');
  const sidebar = document.getElementById('sidebar');
  // Hide everything except compare modal
  app.style.display = 'none';
  sidebar.style.display = 'none';
  modal.style.position = 'static';
  document.body.appendChild(modal);
  window.print();
  // Restore
  document.getElementById('app-content').insertBefore(modal, document.querySelector('#app-content > :last-child'));
  app.style.display = '';
  sidebar.style.display = '';
  modal.style.position = '';
}

// ===== PLAN SWITCHER =====
async function loadPlanList() {
  try {
    const result = await api('/plans');
    allPlans = result.plans || [];
    renderPlanDropdown();
    updatePlanNameDisplay();
  } catch(err) {
    console.error('Load plan list error:', err);
  }
}

function renderPlanDropdown() {
  const container = document.getElementById('planListItems');
  if (!container) return;
  container.innerHTML = allPlans.map(p => {
    const isActive = p.id === currentPlanId;
    const date = new Date(p.updatedAt || p.createdAt).toLocaleDateString('fr-CH', {day:'numeric',month:'short',year:'numeric'});
    return '<div class="pd-item'+(isActive?' active':'')+'" onclick="switchPlan(\''+p.id+'\')">'+
      '<div class="pd-info">'+
        '<div class="pd-plan-name">'+escHTML(p.name)+'</div>'+
        '<div class="pd-date">Modifi\u00e9 le '+date+'</div>'+
      '</div>'+
      '<div class="pd-actions">'+
        '<button class="pd-btn" onclick="event.stopPropagation();renamePlan(\''+p.id+'\',\''+escHTML(p.name)+'\')" title="Renommer">\u270F</button>'+
        (allPlans.length > 1 ? '<button class="pd-btn del" onclick="event.stopPropagation();deletePlan(\''+p.id+'\')" title="Supprimer">\u2717</button>' : '')+
      '</div>'+
    '</div>';
  }).join('');
}

function escHTML(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function updatePlanNameDisplay() {
  const el = document.getElementById('planNameDisplay');
  if (!el) return;
  const plan = allPlans.find(p => p.id === currentPlanId);
  el.textContent = plan ? plan.name : 'Plan';
}

function togglePlanDropdown() {
  const dd = document.getElementById('planDropdown');
  dd.classList.toggle('show');
  if (dd.classList.contains('show')) {
    loadPlanList();
    const close = function(e) {
      if (!document.getElementById('planSwitcher').contains(e.target)) {
        dd.classList.remove('show');
        document.removeEventListener('click', close);
      }
    };
    setTimeout(() => document.addEventListener('click', close), 0);
  }
}

async function switchPlan(planId) {
  if (planId === currentPlanId) {
    document.getElementById('planDropdown').classList.remove('show');
    return;
  }
  try {
    const fullPlan = await api('/plans/' + planId);
    currentPlanId = planId;
    D = { ...fullPlan.plan.data, consultDay: fullPlan.plan.consultDay, fee: fullPlan.plan.fee, daysYear: fullPlan.plan.daysYear, revSpec: fullPlan.plan.revSpec, capex: fullPlan.plan.capex };
    computeDerived();
    updateUI();
    runSim();
    updatePlanNameDisplay();
    renderPlanDropdown();
    // Reset import summary and overlay
    document.getElementById('importSummary').classList.remove('show');
    document.getElementById('planDropdown').classList.remove('show');
    OVERLAY = null;
    overlayScenarioId = null;
    const ovSelect = document.getElementById('overlayScenarioSelect');
    if (ovSelect) ovSelect.value = '';
    document.getElementById('overlayDot').classList.remove('active');
    refreshOverlayScenarios();
    // Update status bar
    const plan = allPlans.find(p => p.id === planId);
    document.getElementById('statusLabel').textContent = 'Plan : ' + (plan ? plan.name : 'Charg\u00e9');
  } catch(err) {
    console.error('Switch plan error:', err);
  }
}

async function createNewPlan() {
  const name = prompt('Nom du nouveau plan :');
  if (!name || !name.trim()) return;
  try {
    const result = await api('/plans', {
      method: 'POST',
      body: JSON.stringify({ name: name.trim() }),
    });
    await loadPlanList();
    await switchPlan(result.plan.id);
  } catch(err) {
    console.error('Create plan error:', err);
  }
}

async function renamePlan(planId, currentName) {
  const name = prompt('Nouveau nom :', currentName);
  if (!name || !name.trim() || name.trim() === currentName) return;
  try {
    await api('/plans/' + planId, {
      method: 'PUT',
      body: JSON.stringify({ name: name.trim() }),
    });
    await loadPlanList();
  } catch(err) {
    console.error('Rename plan error:', err);
  }
}

async function deletePlan(planId) {
  if (allPlans.length <= 1) return;
  if (!confirm('Supprimer ce plan ? Cette action est irr\u00e9versible.')) return;
  try {
    await api('/plans/' + planId, { method: 'DELETE' });
    if (planId === currentPlanId) {
      await loadPlanList();
      if (allPlans.length > 0) {
        await switchPlan(allPlans[0].id);
      }
    } else {
      await loadPlanList();
    }
  } catch(err) {
    console.error('Delete plan error:', err);
  }
}

// ===== EXPORT PDF =====
function exportPDF(){window.print()}

// ===== AUTH LOGIC (server-side sessions) =====
async function checkSession() {
  try {
    const result = await api('/auth/me');
    if (result.user) {
      grantAccess(result.user);
      return true;
    }
  } catch(e) {}
  return false;
}

async function grantAccess(user) {
  currentUser = user;
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app-content').style.display = 'block';

  // Show admin nav if admin
  if (user.role === 'ADMIN') {
    document.getElementById('navAdmin').style.display = '';
  }

  // Add user badge in topbar
  const topbar = document.querySelector('.topbar .spacer');
  if (topbar && !document.getElementById('user-badge')) {
    const badge = document.createElement('div');
    badge.id = 'user-badge';
    badge.className = 'user-info';
    badge.innerHTML = (user.picture ? '<img src="'+user.picture+'" alt="">' : '') +
      '<span>'+user.name+'</span>' +
      '<button class="logout-btn" onclick="logout()">D\u00e9connexion</button>';
    topbar.parentNode.insertBefore(badge, topbar.nextSibling);
  }

  // Load plans from API
  try {
    const result = await api('/plans');
    if (result.plans && result.plans.length > 0) {
      const plan = result.plans[0];
      currentPlanId = plan.id;
      // Load full plan data
      const fullPlan = await api('/plans/' + plan.id);
      D = { ...fullPlan.plan.data, consultDay: fullPlan.plan.consultDay, fee: fullPlan.plan.fee, daysYear: fullPlan.plan.daysYear, revSpec: fullPlan.plan.revSpec, capex: fullPlan.plan.capex };
    } else {
      // Create default plan
      const newPlan = await api('/plans', {
        method: 'POST',
        body: JSON.stringify({ name: 'GYNEVA \u2014 Business Plan Initial' }),
      });
      currentPlanId = newPlan.plan.id;
      const fullPlan = await api('/plans/' + newPlan.plan.id);
      D = { ...fullPlan.plan.data, consultDay: fullPlan.plan.consultDay, fee: fullPlan.plan.fee, daysYear: fullPlan.plan.daysYear, revSpec: fullPlan.plan.revSpec, capex: fullPlan.plan.capex };
    }
  } catch(e) {
    console.error('Failed to load plans, using defaults:', e);
    // Fallback to inline defaults if API fails
    D = getDefaultData();
  }

  computeDerived();
  updateUI();
  runSim();
  loadPlanList();
  refreshOverlayScenarios();
}

function getDefaultData() {
  return {
    ca:[0,0,0,38313,108554,200617,249316,255982,255982,255982,267157,278332,289506,300681,300681,300681,300681,300681,300681,300681,300681,300681,311855,323030,359747,396463,396463,396463,396463,396463,396463,396463,396463,396463,396463,396463],
    caAssoc:[0,0,0,25542,63855,102168,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710],
    caIndep:[0,0,0,12771,44699,95783,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,140481,166023,166023,166023,166023,166023,166023,166023,166023,166023,166023,166023],
    caInterne:[0,0,0,0,0,0,0,0,0,0,11175,22349,33524,44699,44699,44699,44699,44699,44699,44699,44699,44699,55873,67048,78222,89397,89397,89397,89397,89397,89397,89397,89397,89397,89397,89397],
    caSage:[0,0,0,0,0,2667,6667,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333],
    result:[0,-17000,-28942,-13755,11069,30233,50341,55758,58758,58758,66724,74691,64057,72023,71023,71023,71023,71023,70857,70440,70440,70440,78406,-13627,87675,106127,106127,106127,106127,106127,105794,105794,105794,105794,105794,5794],
    cashflow:[0,-17000,-45942,-59697,-48627,-18395,31947,87705,146463,205221,271945,346636,410692,482716,553739,624762,695785,766808,837666,908106,978546,1048986,1127393,1113765,1201440,1307568,1413695,1519822,1625949,1732077,1837871,1943665,2049460,2155254,2261048,2266842],
    treso1m:[0,0,0,0,0,-15098,10335,63676,122434,181192,239950,306675,1199115,1263172,1334195,1405218,1476242,1547265,1618122,1688562,1759002,1829442,1899883,1878289,3727941,3815616,3921743,4027870,4133998,4240125,4345919,4451714,4557508,4663302,4769096,4774891],
    treso3m:[0,-17000,-45942,-80534,-126801,-199235,-255632,-272529,-241097,-184755,-125997,-67239,-19115,36976,928416,991473,1062496,1133519,1204376,1274817,1345257,1415697,1486137,1456577,1517834,1587057,3436708,3524383,3630511,3736638,3842432,3948227,4054021,4159815,4265609,4271404],
    admin:[0,0,-8775,-22425,-35100,-44850,-52650,-52650,-52650,-52650,-52650,-52650,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900],
    opex:[0,-17000,-20167,-24167,-26167,-45584,-45584,-45584,-45584,-45584,-45584,-45584,-48584,-48584,-49584,-49584,-49584,-49584,-49750,-50167,-50167,-50167,-50167,-150167,-53667,-53667,-53667,-53667,-53667,-53667,-54000,-54000,-54000,-54000,-54000,-154000],
    lab:[0,0,0,12000,15000,18000,21000,24000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000],
    fteAssoc:[0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
    fteIndep:[0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3],
    fteInterne:[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2],
    fteAdmin:[0,0,2,3,4,5,6,6,6,6,6,6,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9],
    fteTotal:[0,0,1,3,6,8,10,11,11,11,11,11,13,13,13,13,13,13,13,13,13,13,14,14,16,17,17,17,17,17,17,17,17,17,17,17],
    consultDay:16,fee:225,daysYear:215,revSpec:923432,capex:523000
  };
}

async function logout() {
  try { await api('/auth/logout', { method: 'POST' }); } catch(e) {}
  currentUser = null;
  currentPlanId = null;
  allPlans = [];
  OVERLAY = null;
  overlayScenarioId = null;
  const badge = document.getElementById('user-badge');
  if (badge) badge.remove();
  document.getElementById('app-content').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  if (window.google && google.accounts) {
    google.accounts.id.renderButton(document.getElementById('google-btn'), {
      theme:'outline', size:'large', text:'signin_with', width:300, locale:'fr'
    });
  }
}

async function handleGoogleResponse(response) {
  try {
    const result = await api('/auth/google', {
      method: 'POST',
      body: JSON.stringify({ credential: response.credential }),
    });
    grantAccess(result.user);
  } catch(e) {
    console.error('Auth error:', e);
    const errEl = document.getElementById('auth-error');
    errEl.textContent = e.error || 'Erreur d\'authentification. Veuillez r\u00e9essayer.';
    errEl.style.display = 'block';
  }
}

// Init auth on page load
window.addEventListener('load', async function() {
  // Try existing session first
  if (await checkSession()) return;

  // Wait for Google Identity Services to load
  const initGoogle = setInterval(function() {
    if (window.google && google.accounts && google.accounts.id) {
      clearInterval(initGoogle);
      google.accounts.id.initialize({
        client_id: '219370646588-44317duqpi9ot2faf89vcc0k8lgs58f2.apps.googleusercontent.com',
        callback: handleGoogleResponse
      });
      google.accounts.id.renderButton(document.getElementById('google-btn'), {
        theme: 'outline',
        size: 'large',
        text: 'signin_with',
        width: 300,
        locale: 'fr'
      });
    }
  }, 100);
});
</script>

<!-- VERSION PANEL -->
<div class="version-overlay" id="versionOverlay" onclick="closeVersionPanel()"></div>
<div class="version-panel" id="versionPanel">
  <div class="vp-header">
    <h3>&#128338; Historique des versions</h3>
    <button class="vp-close" onclick="closeVersionPanel()">&times;</button>
  </div>
  <div class="vp-list" id="versionList">
    <div class="vp-empty">Chargement...</div>
  </div>
</div>

<!-- COMPARE MODAL -->
<div class="compare-modal" id="compareModal">
  <div class="compare-header">
    <h2>&#128200; Comparaison de versions</h2>
    <div style="display:flex;gap:.5rem">
      <button class="btn primary" onclick="printCompare()">&#128424; Exporter PDF</button>
      <button class="close-btn" onclick="closeCompare()">&times; Fermer</button>
    </div>
  </div>
  <div class="compare-selectors">
    <select id="compareLeft"></select>
    <span class="vs-label">vs.</span>
    <select id="compareRight"></select>
    <button class="btn primary" onclick="runCompare()">Comparer</button>
  </div>
  <div id="compareContent"></div>
  <div class="compare-charts">
    <div class="card"><h3>CA &amp; R&eacute;sultat par ann&eacute;e</h3><div class="chart-box"><canvas id="cCompareOverview"></canvas></div></div>
    <div class="card"><h3>Tr&eacute;sorerie 36 mois</h3><div class="chart-box"><canvas id="cCompareCashflow"></canvas></div></div>
  </div>
</div>

</div><!-- end #app-content -->

</body>
</html>
