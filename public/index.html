<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GYNEVA — Business Plan Interactif</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.2/jspdf.umd.min.js"></script>
<style>
:root{--p:#0f2b46;--pl:#1a4a7a;--acc:#00b894;--acc2:#00cec9;--warn:#fdcb6e;--danger:#d63031;--bg:#f0f3f8;--card:#fff;--txt:#2d3436;--txtL:#636e72;--brd:#dfe6e9;--sh:0 2px 16px rgba(0,0,0,.06);--r:14px;--trans:all .25s cubic-bezier(.4,0,.2,1)}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--txt);line-height:1.6;-webkit-font-smoothing:antialiased}
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

/* === SIDEBAR === */
.layout{display:flex;min-height:100vh}
.sidebar{width:260px;background:linear-gradient(180deg,var(--p) 0%,#0a1f33 100%);color:#fff;padding:0;position:fixed;top:0;left:0;bottom:0;z-index:200;display:flex;flex-direction:column;transition:var(--trans);overflow:hidden}
.sidebar.collapsed{width:64px}
.sidebar .logo{padding:1.5rem 1.2rem;border-bottom:1px solid rgba(255,255,255,.08);display:flex;align-items:center;gap:.8rem}
.sidebar .logo h1{font-size:1.15rem;font-weight:700;letter-spacing:-.3px;white-space:nowrap}
.sidebar .logo .dot{width:10px;height:10px;border-radius:50%;background:var(--acc);flex-shrink:0}
.sidebar .logo-sub{font-size:.65rem;opacity:.5;margin-top:2px;white-space:nowrap}
.sidebar nav{flex:1;padding:.8rem 0}
.sidebar nav button{width:100%;background:none;border:none;color:rgba(255,255,255,.6);padding:.7rem 1.2rem;text-align:left;cursor:pointer;font-size:.82rem;font-weight:500;display:flex;align-items:center;gap:.7rem;transition:var(--trans);white-space:nowrap;border-left:3px solid transparent}
.sidebar nav button:hover{color:#fff;background:rgba(255,255,255,.06)}
.sidebar nav button.active{color:#fff;background:rgba(0,184,148,.1);border-left-color:var(--acc)}
.sidebar nav button .nav-icon{font-size:1.1rem;width:24px;text-align:center;flex-shrink:0}
.sidebar nav button .nav-label{overflow:hidden}
.sidebar .sidebar-footer{padding:1rem 1.2rem;border-top:1px solid rgba(255,255,255,.08);font-size:.7rem;opacity:.4;white-space:nowrap}
.toggle-btn{position:absolute;top:1.5rem;right:-14px;width:28px;height:28px;border-radius:50%;background:var(--pl);border:2px solid var(--bg);color:#fff;cursor:pointer;font-size:.75rem;display:flex;align-items:center;justify-content:center;z-index:201;transition:var(--trans)}
.toggle-btn:hover{background:var(--acc)}

/* === MAIN === */
.main-area{margin-left:260px;transition:var(--trans);flex:1;min-width:0}
.sidebar.collapsed ~ .main-area{margin-left:64px}

/* === TOP BAR === */
.topbar{background:var(--card);border-bottom:1px solid var(--brd);padding:.8rem 2rem;display:flex;align-items:center;gap:1rem;position:sticky;top:0;z-index:100;box-shadow:0 1px 8px rgba(0,0,0,.04)}
.topbar .page-title{font-size:1.05rem;font-weight:700;color:var(--p)}
.topbar .spacer{flex:1}
.status-pill{display:flex;align-items:center;gap:.4rem;font-size:.75rem;padding:.3rem .8rem;border-radius:20px;font-weight:500}
.status-pill.live{background:rgba(0,184,148,.1);color:#00b894}.status-pill.static{background:rgba(253,203,110,.15);color:#d68910}
.status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.status-dot.live{background:var(--acc);animation:pulse 2s infinite}.status-dot.static{background:var(--warn)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.btn{padding:.45rem 1rem;border-radius:8px;border:1px solid var(--brd);background:var(--card);color:var(--txt);font-size:.8rem;font-weight:500;cursor:pointer;transition:var(--trans);display:flex;align-items:center;gap:.4rem}
.btn:hover{border-color:var(--pl);color:var(--pl)}
.btn.primary{background:var(--pl);color:#fff;border-color:var(--pl)}.btn.primary:hover{background:var(--p)}

/* === CONTENT === */
.content{padding:1.8rem 2rem;max-width:1200px;margin:0 auto}
.section{display:none;animation:fadeIn .3s ease}.section.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* === CARDS === */
.card{background:var(--card);border-radius:var(--r);box-shadow:var(--sh);padding:1.5rem;margin-bottom:1.2rem;border:1px solid var(--brd);transition:var(--trans)}
.card:hover{box-shadow:0 4px 24px rgba(0,0,0,.08)}
.card h2{font-size:.95rem;color:var(--p);margin-bottom:1rem;display:flex;align-items:center;gap:.5rem;font-weight:700}
.card h2 .ic{font-size:1.15rem}
.card h3{font-size:.85rem;color:var(--p);margin-bottom:.6rem;font-weight:600}

/* === KPI === */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.9rem;margin-bottom:1.2rem}
.kpi{background:var(--card);border-radius:var(--r);padding:1.2rem;border:1px solid var(--brd);box-shadow:var(--sh);transition:var(--trans);position:relative;overflow:hidden}
.kpi:hover{transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.08)}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--r) var(--r) 0 0}
.kpi.green::before{background:var(--acc)}.kpi.orange::before{background:var(--warn)}.kpi.red::before{background:var(--danger)}.kpi.blue::before{background:var(--pl)}
.kpi .lb{font-size:.7rem;color:var(--txtL);text-transform:uppercase;letter-spacing:.6px;font-weight:600}
.kpi .vl{font-size:1.6rem;font-weight:800;color:var(--p);margin:.4rem 0 .1rem}
.kpi .sb{font-size:.73rem;color:var(--txtL)}
.kpi.green .vl{color:var(--acc)}.kpi.orange .vl{color:#e17055}.kpi.red .vl{color:var(--danger)}

/* === VERDICT === */
.verdict{border-radius:var(--r);padding:1.2rem 1.4rem;margin-bottom:1.2rem;display:flex;align-items:flex-start;gap:.9rem;font-size:.88rem;line-height:1.6}
.verdict .ic{font-size:1.6rem;flex-shrink:0}.verdict strong{font-weight:700}
.verdict.green{background:rgba(0,184,148,.08);border:1px solid rgba(0,184,148,.2);color:#00755a}
.verdict.orange{background:rgba(253,203,110,.12);border:1px solid rgba(253,203,110,.3);color:#7d5a12}
.verdict.red{background:rgba(214,48,49,.08);border:1px solid rgba(214,48,49,.2);color:#8b2020}

/* === OVERVIEW TAB === */
.ov-year-tl{display:grid;grid-template-columns:repeat(3,1fr);gap:.9rem;margin-bottom:1.2rem}
.ov-year{background:var(--card);border-radius:var(--r);padding:1rem;border:1px solid var(--brd);box-shadow:var(--sh);position:relative;overflow:hidden}
.ov-year::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.ov-year.y1::before{background:linear-gradient(90deg,#e17055,#fdcb6e)}
.ov-year.y2::before{background:linear-gradient(90deg,#fdcb6e,#00b894)}
.ov-year.y3::before{background:#00b894}
.ov-year h4{font-size:.82rem;font-weight:700;color:var(--p);margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center}
.ov-phase{font-size:.65rem;font-weight:600;padding:.15rem .45rem;border-radius:10px}
.ov-phase.start{background:rgba(225,112,85,.1);color:#e17055}
.ov-phase.grow{background:rgba(253,203,110,.15);color:#7d5a12}
.ov-phase.cruise{background:rgba(0,184,148,.1);color:var(--acc)}
.ov-year .ov-metric{display:flex;justify-content:space-between;font-size:.78rem;padding:.25rem 0;border-bottom:1px solid rgba(0,0,0,.03)}
.ov-year .ov-metric:last-child{border-bottom:none}
.ov-year .ov-metric .ov-ml{color:var(--txtL)}
.ov-year .ov-metric .ov-mv{font-weight:700;color:var(--txt)}
.ov-summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.9rem;margin-bottom:1.2rem}
.ov-summary{background:var(--card);border-radius:var(--r);padding:1rem;border:1px solid var(--brd);box-shadow:var(--sh);text-align:center}
.ov-summary .ov-sic{font-size:1.4rem;margin-bottom:.3rem}
.ov-summary h4{font-size:.78rem;font-weight:700;color:var(--p);margin-bottom:.3rem}
.ov-summary .ov-sv{font-size:1.1rem;font-weight:800;margin:.2rem 0}
.ov-summary .ov-sv.green{color:var(--acc)}.ov-summary .ov-sv.orange{color:#e17055}.ov-summary .ov-sv.red{color:var(--danger)}
.ov-summary .ov-sd{font-size:.7rem;color:var(--txtL)}
.ov-summary .ov-tag{display:inline-block;font-size:.63rem;font-weight:600;padding:.12rem .4rem;border-radius:10px;margin-top:.3rem}
.ov-summary .ov-tag.green{background:rgba(0,184,148,.1);color:var(--acc)}
.ov-summary .ov-tag.orange{background:rgba(225,112,85,.1);color:#e17055}
.ov-summary .ov-tag.red{background:rgba(214,48,49,.1);color:var(--danger)}
@media(max-width:768px){.ov-year-tl{grid-template-columns:1fr}.ov-summary-grid{grid-template-columns:1fr 1fr}}

/* === CHARTS === */
.chart-box{position:relative;height:300px;margin:.5rem 0}.chart-box.sm{height:240px}

/* === REVENUE PROFILE FILTERS === */
.rev-profile-bar{display:flex;gap:.4rem;margin-bottom:1rem;flex-wrap:wrap}
.rev-prof{padding:.45rem .9rem;border-radius:20px;border:2px solid var(--brd);background:var(--card);font-size:.78rem;font-weight:600;cursor:pointer;transition:var(--trans);display:flex;align-items:center;gap:.4rem}
.rev-prof:hover{border-color:var(--pl);background:rgba(26,74,122,.04)}
.rev-prof .prof-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.rev-prof.active{color:#fff;border-color:transparent}
.rev-prof[data-prof="all"].active{background:var(--pl);color:#fff}
.rev-prof[data-prof="assoc"].active{background:#0f2b46}
.rev-prof[data-prof="indep"].active{background:#1a4a7a}
.rev-prof[data-prof="interne"].active{background:#5dade2;color:#0f2b46}
.rev-prof[data-prof="sage"].active{background:#aed6f1;color:#0f2b46}
.rev-detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.9rem;margin-bottom:1.2rem}
.rev-prof-card{background:var(--card);border-radius:var(--r);padding:1.2rem;border:1px solid var(--brd);box-shadow:var(--sh);border-left:4px solid var(--pl)}
.rev-prof-card.assoc{border-left-color:#0f2b46}
.rev-prof-card.indep{border-left-color:#1a4a7a}
.rev-prof-card.interne{border-left-color:#5dade2}
.rev-prof-card.sage{border-left-color:#aed6f1}
.rev-prof-card h4{font-size:.82rem;font-weight:700;color:var(--p);margin-bottom:.6rem}
.rev-prof-card .prof-kpis{display:flex;flex-direction:column;gap:.35rem}
.rev-prof-card .prof-kpi{display:flex;justify-content:space-between;font-size:.78rem}
.rev-prof-card .prof-kpi .pk-label{color:var(--txtL)}
.rev-prof-card .prof-kpi .pk-value{font-weight:700;color:var(--p)}
.rev-prof-card .prof-ramp{margin-top:.6rem;font-size:.72rem;color:var(--txtL);font-style:italic}

/* === REVENUE CONTROLS === */
.rev-controls{display:flex;gap:1.2rem;flex-wrap:wrap;align-items:center;padding:1rem 1.2rem;background:#f8fafb;border-radius:var(--r);border:1px solid var(--brd);margin-bottom:1.2rem}
.rev-ctrl{display:flex;align-items:center;gap:.5rem;font-size:.8rem;font-weight:600;color:var(--p)}
.rev-ctrl label{white-space:nowrap}
.rev-year-btns{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--brd)}
.rev-year-btn{padding:.4rem .8rem;border:none;background:var(--card);font-size:.78rem;font-weight:600;color:var(--txtL);cursor:pointer;transition:var(--trans);border-right:1px solid var(--brd)}
.rev-year-btn:last-child{border-right:none}
.rev-year-btn:hover{background:rgba(26,74,122,.04);color:var(--p)}
.rev-year-btn.active{background:var(--pl);color:#fff}
.rev-controls .rev-profile-bar{margin-bottom:0}

/* === EXEC DASHBOARD === */
.exec-dash{background:linear-gradient(135deg,#0f2b46 0%,#1a4a7a 100%);color:#fff;padding:.8rem 1.2rem;display:flex;align-items:center;gap:1.2rem;position:relative;border-bottom:3px solid var(--acc)}
.exec-dash.collapsed .exec-body{display:none}
.exec-body{display:flex;align-items:center;gap:1.2rem;flex:1;min-width:0}
.exec-toggle{position:absolute;right:12px;top:8px;background:none;border:none;color:rgba(255,255,255,.6);cursor:pointer;font-size:.9rem;padding:4px 8px;border-radius:6px;transition:var(--trans)}
.exec-toggle:hover{color:#fff;background:rgba(255,255,255,.1)}
.exec-gauge-wrap{flex-shrink:0;text-align:center;width:80px}
.exec-gauge-wrap svg{width:70px;height:70px}
.exec-gauge-label{font-size:.65rem;color:rgba(255,255,255,.7);margin-top:2px}
.exec-kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:.3rem .5rem;flex:1;min-width:0}
.exec-kpi{padding:.25rem .4rem;border-radius:6px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.1)}
.exec-kpi .ek-label{font-size:.55rem;color:rgba(255,255,255,.6);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.exec-kpi .ek-value{font-size:.82rem;font-weight:800;white-space:nowrap}
.exec-spark{flex-shrink:0;width:180px;height:50px}
.exec-spark canvas{width:100%!important;height:100%!important}
.nav-badge{display:inline-block;width:8px;height:8px;border-radius:50%;margin-left:6px;vertical-align:middle}
.nav-badge.green{background:var(--acc)}
.nav-badge.orange{background:var(--warn)}
.nav-badge.red{background:var(--danger)}
.nav-badge.none{display:none}

/* === OPTIMIZE CONTROLS === */
.opt-controls{display:flex;gap:1.2rem;flex-wrap:wrap;align-items:center;padding:1rem 1.2rem;background:#f8fafb;border-radius:var(--r);border:1px solid var(--brd);margin-bottom:1.2rem}
.opt-ctrl{display:flex;align-items:center;gap:.5rem;font-size:.8rem;font-weight:600;color:var(--p)}
.opt-ctrl label{white-space:nowrap}
.opt-ctrl select{padding:.3rem .5rem;border-radius:6px;border:1px solid var(--brd);font-size:.78rem}
.opt-ctrl input[type="range"]{width:100px}
.opt-ctrl .toggle{display:inline-flex}
.opt-ctrl .toggle-sw{width:40px;height:22px;border-radius:11px;background:#ccc;cursor:pointer;position:relative;transition:var(--trans)}
.opt-ctrl .toggle-sw.on{background:var(--acc)}
.opt-ctrl .toggle-sw::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:var(--trans);box-shadow:0 1px 3px rgba(0,0,0,.15)}
.opt-ctrl .toggle-sw.on::after{left:20px}
.opt-reco{border-radius:var(--r);padding:1rem 1.2rem;margin-bottom:1.2rem;font-size:.85rem;line-height:1.6;display:flex;align-items:flex-start;gap:.7rem}
.opt-reco.positive{background:rgba(0,184,148,.08);border:1px solid rgba(0,184,148,.2);color:#00755a}
.opt-reco.warning{background:rgba(225,112,85,.08);border:1px solid rgba(225,112,85,.2);color:#c0392b}
.opt-reco .reco-icon{font-size:1.2rem;flex-shrink:0}
.opt-compare-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.7rem;margin-bottom:1.2rem}
.opt-scenario{background:var(--card);border-radius:var(--r);padding:1rem;border:1px solid var(--brd);box-shadow:var(--sh);text-align:center;transition:var(--trans)}
.opt-scenario.active{border-color:var(--acc);box-shadow:0 0 0 2px rgba(0,184,148,.2)}
.opt-scenario.worst{border-left:3px solid var(--danger)}
.opt-scenario.best{border-left:3px solid var(--acc)}
.opt-scenario h4{font-size:.75rem;font-weight:700;color:var(--p);margin-bottom:.5rem}
.opt-scenario .sc-val{font-size:1.3rem;font-weight:800;margin:.3rem 0}
.opt-scenario .sc-val.neg{color:var(--danger)}
.opt-scenario .sc-val.pos{color:var(--acc)}
.opt-scenario .sc-detail{font-size:.7rem;color:var(--txtL);line-height:1.4}
.opt-scenario .sc-tag{display:inline-block;font-size:.65rem;font-weight:600;padding:.15rem .4rem;border-radius:10px;margin-top:.4rem}
.opt-scenario .sc-tag.red{background:rgba(214,48,49,.1);color:var(--danger)}
.opt-scenario .sc-tag.orange{background:rgba(225,112,85,.1);color:#e17055}
.opt-scenario .sc-tag.green{background:rgba(0,184,148,.1);color:var(--acc)}

/* === RISK TAB === */
.risk-gauge{display:flex;align-items:center;gap:1.2rem;padding:1.2rem 1.4rem;background:var(--card);border-radius:var(--r);border:1px solid var(--brd);box-shadow:var(--sh);margin-bottom:1.2rem}
.risk-gauge-ring{width:80px;height:80px;border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.risk-gauge-ring svg{position:absolute;top:0;left:0;transform:rotate(-90deg)}
.risk-gauge-score{font-size:1.6rem;font-weight:800;z-index:1}
.risk-gauge-info{flex:1}
.risk-gauge-label{font-size:.95rem;font-weight:700;color:var(--p);margin-bottom:.2rem}
.risk-gauge-sub{font-size:.8rem;color:var(--txtL);line-height:1.5}
.risk-gauge.low .risk-gauge-score{color:var(--acc)}
.risk-gauge.medium .risk-gauge-score{color:#e17055}
.risk-gauge.high .risk-gauge-score{color:var(--danger)}
.risk-controls{display:flex;gap:1.2rem;flex-wrap:wrap;align-items:center;padding:1rem 1.2rem;background:#f8fafb;border-radius:var(--r);border:1px solid var(--brd);margin-bottom:1.2rem}
.risk-ctrl{display:flex;align-items:center;gap:.5rem;font-size:.8rem;font-weight:600;color:var(--p)}
.risk-ctrl label{white-space:nowrap}
.risk-ctrl input[type="range"]{width:110px;accent-color:var(--pl)}
.risk-ctrl .risk-val{font-weight:700;min-width:3.5rem;text-align:right}
.risk-scenario-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.7rem;margin-bottom:1.2rem}
.risk-scenario{background:var(--card);border-radius:var(--r);padding:1rem;border:1px solid var(--brd);box-shadow:var(--sh);text-align:center;transition:var(--trans)}
.risk-scenario.pessimiste{border-left:3px solid var(--danger)}
.risk-scenario.base{border-left:3px solid var(--pl)}
.risk-scenario.optimiste{border-left:3px solid var(--acc)}
.risk-scenario h4{font-size:.75rem;font-weight:700;color:var(--p);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:.3px}
.risk-scenario .rs-val{font-size:1.15rem;font-weight:800;margin:.2rem 0}
.risk-scenario .rs-val.neg{color:var(--danger)}
.risk-scenario .rs-val.pos{color:var(--acc)}
.risk-scenario .rs-detail{font-size:.7rem;color:var(--txtL);line-height:1.4}
.risk-sensitivity{margin-bottom:1.2rem}
.risk-sens-row{display:flex;align-items:center;gap:.7rem;margin-bottom:.6rem;font-size:.8rem}
.risk-sens-label{width:160px;font-weight:600;color:var(--p);flex-shrink:0}
.risk-sens-bar-ct{flex:1;position:relative;height:22px;background:#f0f3f5;border-radius:11px;overflow:hidden}
.risk-sens-bar{height:100%;border-radius:11px;transition:width .4s ease}
.risk-sens-bar.low{background:var(--acc)}
.risk-sens-bar.medium{background:var(--warn)}
.risk-sens-bar.high{background:var(--danger)}
.risk-sens-pct{width:50px;text-align:right;font-weight:700;font-variant-numeric:tabular-nums}
.risk-matrix-interactive table.dt th.sortable{cursor:pointer;user-select:none}
.risk-matrix-interactive table.dt th.sortable:hover{color:var(--acc)}
.risk-matrix-interactive table.dt th.sortable::after{content:' \25B4';font-size:.6rem;opacity:.4}
.risk-matrix-interactive table.dt th.sorted-desc::after{content:' \25BE';opacity:1}
.risk-matrix-interactive table.dt th.sorted-asc::after{content:' \25B4';opacity:1}
.risk-score-cell{font-weight:800;font-size:.9rem;font-variant-numeric:tabular-nums}
.risk-exposure{display:flex;align-items:center;gap:.7rem;margin-top:.8rem;padding:.6rem .9rem;background:#f8fafb;border-radius:8px;font-size:.82rem}
.risk-exposure .re-label{color:var(--txtL);font-weight:500}
.risk-exposure .re-value{font-weight:800;color:var(--p)}
.badge.clickable{cursor:pointer;transition:var(--trans)}
.badge.clickable:hover{filter:brightness(1.1);transform:scale(1.05)}
.charges-summary{display:flex;gap:1.2rem;align-items:center;margin-bottom:.8rem}
.charges-chart-box{width:160px;height:160px;flex-shrink:0}
.charges-total{font-size:.82rem;color:var(--txtL);line-height:1.6}
.charges-total strong{color:var(--p);font-size:1.1rem;display:block;margin-bottom:.2rem}
@media(max-width:768px){
  .risk-controls{flex-direction:column;align-items:stretch}
  .risk-scenario-grid{grid-template-columns:1fr}
  .risk-sens-label{width:100px;font-size:.72rem}
  .risk-gauge{flex-direction:column;text-align:center}
  .charges-summary{flex-direction:column}
}

/* === TABLES === */
table.dt{width:100%;border-collapse:separate;border-spacing:0;font-size:.82rem}
table.dt th{background:#f8fafb;padding:.65rem .9rem;text-align:left;font-weight:600;color:var(--p);border-bottom:2px solid var(--brd);white-space:nowrap}
table.dt td{padding:.55rem .9rem;border-bottom:1px solid #f0f3f5}
table.dt tr:hover td{background:#f8fafb}
.num{text-align:right;font-variant-numeric:tabular-nums}

/* === BADGES === */
.badge{display:inline-block;padding:.15rem .6rem;border-radius:10px;font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.3px}
.badge.critique{background:#fdeaea;color:#c0392b}.badge.important{background:#fef5e7;color:#d68910}
.badge.moyen{background:#eaf2f8;color:#2e86c1}.badge.faible{background:#e8f8f0;color:#27ae60}
.badge.eleve{background:#fdeaea;color:#c0392b}.badge.tres-eleve{background:#c0392b;color:#fff}

/* === PILLS === */
.pills{display:flex;flex-wrap:wrap;gap:.4rem;margin:.5rem 0}
.pill{background:rgba(26,74,122,.06);border-radius:20px;padding:.35rem .85rem;font-size:.78rem;color:var(--p);font-weight:500;border:1px solid rgba(26,74,122,.1)}
.pill b{font-weight:700}

/* === EXPLAINER === */
.exp{background:#f8fafb;border-radius:10px;padding:.9rem 1.1rem;font-size:.84rem;line-height:1.6;color:#4a6785;margin:.8rem 0;border-left:3px solid var(--pl)}
.exp strong{color:var(--p)}

/* === SCENARIO CARDS === */
.sc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.9rem;margin:1rem 0}
.sc-card{border-radius:var(--r);padding:1.1rem;border:2px solid var(--brd);transition:var(--trans);background:var(--card)}
.sc-card:hover{border-color:var(--pl)}.sc-card.rec{border-color:var(--acc);background:rgba(0,184,148,.03)}
.sc-card h3{font-size:.82rem;margin-bottom:.4rem;display:flex;align-items:center;gap:.4rem}
.sc-card .bn{font-size:1.4rem;font-weight:800}.sc-card .dt{font-size:.76rem;color:var(--txtL);margin-top:.2rem}
/* === CASHFLOW TAB === */
.cf-controls{display:flex;gap:1.2rem;flex-wrap:wrap;align-items:center;padding:1rem 1.2rem;background:#f8fafb;border-radius:var(--r);border:1px solid var(--brd);margin-bottom:1.2rem}
.cf-ctrl{display:flex;align-items:center;gap:.5rem;font-size:.8rem;font-weight:600;color:var(--p)}
.cf-ctrl label{white-space:nowrap}
.cf-year-btns{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--brd)}
.cf-year-btn{padding:.4rem .8rem;border:none;background:var(--card);font-size:.78rem;font-weight:600;color:var(--txtL);cursor:pointer;transition:var(--trans);border-right:1px solid var(--brd)}
.cf-year-btn:last-child{border-right:none}
.cf-year-btn:hover{background:rgba(26,74,122,.04);color:var(--p)}
.cf-year-btn.active{background:var(--pl);color:#fff}
.cf-scenario-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.9rem;margin:1rem 0}
.cf-scenario{background:var(--card);border-radius:var(--r);padding:1rem;border:1px solid var(--brd);box-shadow:var(--sh);transition:var(--trans)}
.cf-scenario:hover{border-color:var(--pl);box-shadow:0 4px 20px rgba(0,0,0,.08)}
.cf-scenario.worst{border-left:3px solid var(--danger)}
.cf-scenario.best{border-left:3px solid var(--acc)}
.cf-scenario h4{font-size:.78rem;font-weight:700;color:var(--p);margin-bottom:.4rem;display:flex;align-items:center;gap:.4rem}
.cf-scenario .cf-val{font-size:1.3rem;font-weight:800;margin:.3rem 0}
.cf-scenario .cf-val.neg{color:var(--danger)}
.cf-scenario .cf-val.pos{color:var(--acc)}
.cf-scenario .cf-detail{font-size:.72rem;color:var(--txtL);line-height:1.4}
.cf-scenario .cf-tag{display:inline-block;font-size:.65rem;font-weight:600;padding:.15rem .4rem;border-radius:10px;margin-top:.4rem}
.cf-scenario .cf-tag.red{background:rgba(214,48,49,.1);color:var(--danger)}
.cf-scenario .cf-tag.orange{background:rgba(225,112,85,.1);color:#e17055}
.cf-scenario .cf-tag.green{background:rgba(0,184,148,.1);color:var(--acc)}
@media(max-width:768px){.cf-controls{flex-direction:column;align-items:stretch}.cf-scenario-grid{grid-template-columns:1fr}}
@media(max-width:768px){.rev-controls{flex-direction:column;align-items:stretch}}

/* === PROFIT TIMELINE === */
.profit-tl{display:flex;gap:0;margin:1rem 0;border-radius:var(--r);overflow:hidden;border:1px solid var(--brd)}
.profit-yr{flex:1;padding:1rem;text-align:center;border-right:1px solid var(--brd);background:var(--card)}
.profit-yr:last-child{border-right:none}
.profit-yr .yl{font-size:.7rem;color:var(--txtL);text-transform:uppercase;font-weight:600;letter-spacing:.5px}
.profit-yr .am{font-size:1.3rem;font-weight:800;color:var(--p);margin:.3rem 0}
.profit-yr .pa{font-size:.82rem;color:var(--acc);font-weight:600}
.profit-yr .nt{font-size:.72rem;color:var(--txtL)}
.profit-controls{display:flex;gap:1.2rem;flex-wrap:wrap;align-items:center;padding:1rem 1.2rem;background:#f8fafb;border-radius:var(--r);border:1px solid var(--brd);margin-bottom:1.2rem}
.profit-ctrl{display:flex;align-items:center;gap:.5rem;font-size:.8rem;font-weight:600;color:var(--p)}
.profit-ctrl label{white-space:nowrap}
.profit-ctrl input[type="range"]{width:110px;accent-color:var(--pl)}
.profit-ctrl .profit-val{font-weight:700;min-width:3rem;text-align:right}
.profit-breakdown{display:grid;grid-template-columns:1fr 1fr;gap:.8rem;margin-bottom:1.2rem}
.profit-type{background:var(--card);border-radius:var(--r);padding:1rem 1.2rem;border:1px solid var(--brd);box-shadow:var(--sh)}
.profit-type h4{font-size:.8rem;font-weight:700;color:var(--p);margin-bottom:.5rem;display:flex;align-items:center;gap:.4rem}
.profit-type .pt-row{display:flex;justify-content:space-between;font-size:.78rem;padding:.25rem 0;border-bottom:1px solid #f0f3f5}
.profit-type .pt-row:last-child{border-bottom:none}
.profit-type .pt-label{color:var(--txtL)}
.profit-type .pt-value{font-weight:700;color:var(--p)}
.profit-type .pt-total{font-size:.9rem;font-weight:800;margin-top:.5rem;padding-top:.5rem;border-top:2px solid var(--brd);display:flex;justify-content:space-between}
.profit-type .pt-total .pt-value{color:var(--acc)}
@media(max-width:768px){.profit-controls{flex-direction:column;align-items:stretch}.profit-breakdown{grid-template-columns:1fr}}
/* === TEAM TAB === */
.team-controls{display:flex;gap:1.2rem;flex-wrap:wrap;align-items:center;padding:1rem 1.2rem;background:#f8fafb;border-radius:var(--r);border:1px solid var(--brd);margin-bottom:1.2rem}
.team-ctrl{display:flex;align-items:center;gap:.5rem;font-size:.8rem;font-weight:600;color:var(--p)}
.team-ctrl label{white-space:nowrap}
.team-ctrl .toggle-sw{width:40px;height:22px;border-radius:11px;background:#ccc;cursor:pointer;position:relative;transition:var(--trans)}
.team-ctrl .toggle-sw.on{background:var(--acc)}
.team-ctrl .toggle-sw::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:var(--trans);box-shadow:0 1px 3px rgba(0,0,0,.15)}
.team-ctrl .toggle-sw.on::after{left:20px}
.team-year-btns{display:flex;gap:0;border-radius:8px;overflow:hidden;border:1px solid var(--brd)}
.team-year-btn{padding:.4rem .8rem;border:none;background:var(--card);font-size:.78rem;font-weight:600;color:var(--txtL);cursor:pointer;transition:var(--trans);border-right:1px solid var(--brd)}
.team-year-btn:last-child{border-right:none}
.team-year-btn:hover{background:rgba(26,74,122,.04);color:var(--p)}
.team-year-btn.active{background:var(--pl);color:#fff}
.team-profiles{display:grid;grid-template-columns:repeat(4,1fr);gap:.7rem;margin-bottom:1.2rem}
.team-profile{background:var(--card);border-radius:var(--r);padding:1rem;border:1px solid var(--brd);box-shadow:var(--sh);transition:var(--trans)}
.team-profile:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(0,0,0,.08)}
.team-profile h4{font-size:.75rem;font-weight:700;color:var(--p);margin-bottom:.5rem;display:flex;align-items:center;gap:.4rem}
.team-profile .tp-fte{font-size:1.3rem;font-weight:800;color:var(--pl);margin:.2rem 0}
.team-profile .tp-row{display:flex;justify-content:space-between;font-size:.72rem;padding:.2rem 0;border-bottom:1px solid #f0f3f5}
.team-profile .tp-row:last-child{border-bottom:none}
.team-profile .tp-label{color:var(--txtL)}
.team-profile .tp-value{font-weight:700;color:var(--p)}
.team-profile .tp-bar{height:4px;border-radius:2px;background:#f0f3f5;margin-top:.4rem;overflow:hidden}
.team-profile .tp-bar-fill{height:100%;border-radius:2px;transition:width .4s ease}
.team-profile.assoc .tp-bar-fill{background:#0f2b46}
.team-profile.indep .tp-bar-fill{background:#1a4a7a}
.team-profile.interne .tp-bar-fill{background:#5dade2}
.team-profile.admin .tp-bar-fill{background:#aed6f1}
@media(max-width:768px){.team-controls{flex-direction:column;align-items:stretch}.team-profiles{grid-template-columns:1fr 1fr}}

/* === DROPZONE === */
.dropzone{border:2px dashed var(--pl);border-radius:var(--r);padding:2rem;text-align:center;margin-bottom:1.2rem;background:rgba(26,74,122,.02);transition:var(--trans);cursor:pointer;position:relative}
.dropzone:hover,.dropzone.over{background:rgba(26,74,122,.06);border-color:var(--acc)}
.dropzone .dz-icon{font-size:2.2rem;margin-bottom:.4rem}.dropzone .dz-text{font-size:.9rem;color:var(--p);font-weight:600}
.dropzone .dz-sub{font-size:.78rem;color:var(--txtL);margin-top:.3rem}
.dropzone input{position:absolute;inset:0;opacity:0;cursor:pointer}
.dropzone.loaded{border-color:var(--acc);background:rgba(0,184,148,.04);border-style:solid}

/* === IMPORT SUMMARY === */
.import-summary{background:var(--card);border:1px solid var(--brd);border-radius:var(--r);padding:1.2rem 1.4rem;margin-bottom:1.2rem;display:none;animation:fadeIn .3s ease}
.import-summary.show{display:block}
.import-summary h3{font-size:.85rem;color:var(--p);font-weight:700;margin-bottom:.8rem;display:flex;align-items:center;gap:.5rem}
.import-summary .no-change{font-size:.84rem;color:var(--txtL);padding:.5rem 0}
.diff-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.6rem}
.diff-item{display:flex;justify-content:space-between;align-items:center;padding:.5rem .7rem;border-radius:8px;background:#f8fafb;font-size:.8rem}
.diff-item .diff-label{color:var(--txtL);font-weight:500}
.diff-item .diff-values{display:flex;align-items:center;gap:.4rem;font-variant-numeric:tabular-nums}
.diff-item .diff-old{color:var(--txtL);text-decoration:line-through;font-size:.75rem}
.diff-item .diff-new{color:var(--p);font-weight:700}
.diff-item .diff-arrow{color:var(--txtL);font-size:.7rem}
.diff-pct{font-size:.68rem;font-weight:600;padding:.1rem .45rem;border-radius:10px;margin-left:.3rem}
.diff-pct.up{background:rgba(0,184,148,.1);color:#00b894}
.diff-pct.down{background:rgba(214,48,49,.1);color:var(--danger)}
.import-warnings{margin-top:.8rem;padding:.6rem .8rem;background:rgba(253,203,110,.1);border:1px solid rgba(253,203,110,.25);border-radius:8px;font-size:.78rem;color:#7d5a12}
.import-warnings li{margin:.2rem 0;list-style:none;padding-left:1rem;position:relative}
.import-warnings li::before{content:'\26A0';position:absolute;left:0}

/* === VERSION PANEL === */
.version-panel{position:fixed;top:0;right:-420px;width:400px;height:100vh;background:var(--card);border-left:1px solid var(--brd);box-shadow:-4px 0 24px rgba(0,0,0,.08);z-index:300;transition:right .3s cubic-bezier(.4,0,.2,1);display:flex;flex-direction:column}
.version-panel.open{right:0}
.version-panel .vp-header{padding:1.2rem 1.4rem;border-bottom:1px solid var(--brd);display:flex;align-items:center;justify-content:space-between}
.version-panel .vp-header h3{font-size:.95rem;font-weight:700;color:var(--p)}
.version-panel .vp-close{background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--txtL);padding:.3rem}
.version-panel .vp-close:hover{color:var(--p)}
.version-panel .vp-list{flex:1;overflow-y:auto;padding:.8rem}
.version-panel .vp-empty{text-align:center;color:var(--txtL);font-size:.84rem;padding:2rem 1rem}
.version-item{padding:.8rem 1rem;border:1px solid var(--brd);border-radius:10px;margin-bottom:.6rem;transition:var(--trans)}
.version-item:hover{border-color:var(--pl);background:#f8fafb}
.version-item .vi-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:.3rem}
.version-item .vi-num{font-size:.75rem;font-weight:700;color:var(--pl);background:rgba(26,74,122,.06);padding:.15rem .5rem;border-radius:8px}
.version-item .vi-date{font-size:.72rem;color:var(--txtL)}
.version-item .vi-label{font-size:.82rem;color:var(--p);font-weight:500}
.version-item .vi-restore{margin-top:.5rem;background:none;border:1px solid var(--pl);color:var(--pl);padding:.3rem .7rem;border-radius:8px;font-size:.73rem;font-weight:500;cursor:pointer;transition:var(--trans)}
.version-item .vi-restore:hover{background:var(--pl);color:#fff}
.version-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.2);z-index:299}
.version-overlay.show{display:block}

/* === PLAN SWITCHER === */
.plan-switcher{position:relative;display:flex;align-items:center;margin-left:.8rem}
.plan-name{background:none;border:1px solid var(--brd);color:var(--p);padding:.35rem .8rem;border-radius:8px;font-size:.82rem;font-weight:600;cursor:pointer;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;transition:var(--trans);display:flex;align-items:center;gap:.4rem}
.plan-name:hover{border-color:var(--pl);color:var(--pl)}
.plan-name::after{content:'\25BC';font-size:.55rem;opacity:.5}
.plan-dropdown{display:none;position:absolute;top:calc(100% + 6px);left:0;min-width:300px;max-height:400px;overflow-y:auto;background:var(--card);border:1px solid var(--brd);border-radius:var(--r);box-shadow:0 8px 32px rgba(0,0,0,.12);z-index:150;padding:.4rem 0}
.plan-dropdown.show{display:block}
.pd-item{display:flex;align-items:center;padding:.6rem 1rem;cursor:pointer;transition:var(--trans);border-left:3px solid transparent;gap:.6rem}
.pd-item:hover{background:#f8fafb}
.pd-item.active{border-left-color:var(--acc);background:rgba(0,184,148,.04)}
.pd-item .pd-info{flex:1;min-width:0}
.pd-item .pd-plan-name{font-size:.82rem;font-weight:600;color:var(--p);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pd-item .pd-date{font-size:.7rem;color:var(--txtL)}
.pd-item .pd-actions{display:flex;gap:.3rem;opacity:0;transition:opacity .2s}
.pd-item:hover .pd-actions{opacity:1}
.pd-item .pd-btn{background:none;border:none;cursor:pointer;font-size:.72rem;color:var(--txtL);padding:.2rem .4rem;border-radius:4px;transition:var(--trans)}
.pd-item .pd-btn:hover{background:rgba(26,74,122,.08);color:var(--pl)}
.pd-item .pd-btn.del:hover{color:var(--danger);background:rgba(214,48,49,.06)}
.pd-footer{padding:.5rem 1rem;border-top:1px solid var(--brd)}
.pd-footer button{width:100%;background:none;border:1px dashed var(--brd);color:var(--pl);padding:.5rem;border-radius:8px;font-size:.8rem;font-weight:500;cursor:pointer;transition:var(--trans)}
.pd-footer button:hover{background:rgba(26,74,122,.04);border-color:var(--pl)}

/* === OVERLAY CONTROL === */
.overlay-control{display:flex;align-items:center;gap:.7rem;padding:.7rem 1.2rem;background:var(--card);border:1px solid var(--brd);border-radius:var(--r);margin-bottom:1.2rem;font-size:.82rem}
.overlay-control label{display:flex;align-items:center;gap:.4rem;font-weight:500;color:var(--p);white-space:nowrap}
.overlay-indicator{width:8px;height:8px;border-radius:50%;background:#ccc;flex-shrink:0;transition:var(--trans)}
.overlay-indicator.active{background:var(--acc);animation:pulse 2s infinite}
.overlay-control select{flex:1;padding:.35rem .6rem;border:1px solid var(--brd);border-radius:8px;font-size:.8rem;background:var(--card);cursor:pointer;max-width:260px}
.overlay-control button{background:none;border:1px solid var(--brd);padding:.3rem .6rem;border-radius:6px;font-size:.72rem;cursor:pointer;color:var(--txtL);transition:var(--trans)}
.overlay-control button:hover{border-color:var(--pl);color:var(--pl)}

/* === COMPARE MODAL === */
.compare-modal{display:none;position:fixed;inset:0;z-index:400;background:var(--bg);overflow-y:auto;padding:2rem}
.compare-modal.open{display:block}
.compare-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem}
.compare-header h2{font-size:1.1rem;font-weight:700;color:var(--p);display:flex;align-items:center;gap:.5rem}
.compare-header .close-btn{background:none;border:1px solid var(--brd);padding:.4rem .8rem;border-radius:8px;cursor:pointer;font-size:.85rem;color:var(--txtL);transition:var(--trans)}
.compare-header .close-btn:hover{border-color:var(--pl);color:var(--pl)}
.compare-selectors{display:flex;align-items:center;gap:.8rem;flex-wrap:wrap;margin-bottom:1.5rem;padding:1rem 1.2rem;background:var(--card);border:1px solid var(--brd);border-radius:var(--r)}
.compare-selectors select{padding:.4rem .7rem;border:1px solid var(--brd);border-radius:8px;font-size:.82rem;background:var(--card);min-width:200px}
.compare-selectors .vs-label{font-size:.85rem;font-weight:700;color:var(--txtL)}
.compare-grid{display:grid;grid-template-columns:1fr repeat(3,auto);gap:0;background:var(--card);border:1px solid var(--brd);border-radius:var(--r);overflow:hidden;margin-bottom:1.5rem}
.compare-grid .cg-head{background:#f8fafb;padding:.6rem 1rem;font-size:.75rem;font-weight:600;color:var(--p);text-transform:uppercase;letter-spacing:.4px;border-bottom:2px solid var(--brd)}
.compare-grid .cg-cell{padding:.55rem 1rem;font-size:.82rem;border-bottom:1px solid #f0f3f5;display:flex;align-items:center}
.compare-grid .cg-cell.label{font-weight:500;color:var(--p)}
.compare-grid .cg-cell.num{justify-content:flex-end;font-variant-numeric:tabular-nums}
.compare-grid .cg-cell .delta-badge{font-size:.7rem;font-weight:600;padding:.1rem .45rem;border-radius:8px;margin-left:.4rem}
.compare-grid .cg-cell .delta-badge.pos{background:rgba(0,184,148,.1);color:#00b894}
.compare-grid .cg-cell .delta-badge.neg{background:rgba(214,48,49,.1);color:var(--danger)}
.compare-grid .cg-cell .delta-badge.zero{background:rgba(99,110,114,.08);color:var(--txtL)}
.compare-charts{display:grid;grid-template-columns:1fr 1fr;gap:1.2rem;margin-bottom:1.5rem}
@media(max-width:900px){.compare-charts{grid-template-columns:1fr}}
.compare-charts .card{margin-bottom:0}
.compare-charts .chart-box{height:250px}
@media print{
  .compare-modal{position:static;padding:1rem;overflow:visible}
  .compare-selectors,.compare-header .close-btn,.compare-header button{display:none!important}
  .compare-charts{grid-template-columns:1fr 1fr}
  .compare-charts .chart-box{height:200px}
}

/* ===== SIMULATOR ===== */
.sim-layout{display:grid;grid-template-columns:340px 1fr;gap:1.5rem}
@media(max-width:900px){.sim-layout{grid-template-columns:1fr}}
.sim-panel{background:var(--card);border-radius:var(--r);border:1px solid var(--brd);box-shadow:var(--sh);padding:1.4rem;position:sticky;top:70px;max-height:calc(100vh - 90px);overflow-y:auto}
.sim-panel h2{font-size:.9rem;color:var(--p);font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.sim-group{margin-bottom:1.3rem;padding-bottom:1rem;border-bottom:1px solid #f0f3f5}
.sim-group:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0}
.sim-group h3{font-size:.72rem;text-transform:uppercase;letter-spacing:.8px;color:var(--txtL);font-weight:600;margin-bottom:.7rem}
.sim-row{margin-bottom:.8rem}
.sim-row label{display:flex;justify-content:space-between;font-size:.8rem;font-weight:500;margin-bottom:.25rem}
.sim-row label span{color:var(--pl);font-weight:700;font-variant-numeric:tabular-nums}
.sim-row input[type=range]{width:100%;height:6px;-webkit-appearance:none;appearance:none;background:#e0e6ed;border-radius:3px;outline:none;cursor:pointer}
.sim-row input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:var(--pl);cursor:pointer;border:3px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.sim-row select{width:100%;padding:.45rem .6rem;border:1px solid var(--brd);border-radius:8px;font-size:.82rem;background:var(--card);cursor:pointer}
.sim-row .toggle{display:flex;gap:.5rem;align-items:center}
.sim-row .toggle-sw{width:40px;height:22px;border-radius:11px;background:#ccc;cursor:pointer;position:relative;transition:var(--trans)}
.sim-row .toggle-sw.on{background:var(--acc)}
.sim-row .toggle-sw::after{content:'';position:absolute;top:2px;left:2px;width:18px;height:18px;border-radius:50%;background:#fff;transition:var(--trans);box-shadow:0 1px 3px rgba(0,0,0,.15)}
.sim-row .toggle-sw.on::after{left:20px}
.sim-results{flex:1}
.sim-delta{display:inline-block;font-size:.7rem;font-weight:600;padding:.1rem .5rem;border-radius:10px;margin-left:.4rem}
.sim-delta.up{background:rgba(0,184,148,.1);color:#00b894}
.sim-delta.down{background:rgba(214,48,49,.1);color:var(--danger)}
.sim-delta.neutral{background:rgba(99,110,114,.1);color:var(--txtL)}

/* === SIMULATOR YEAR TABS === */
.sim-year-tabs{display:flex;gap:0;margin-bottom:1.2rem;border-radius:var(--r);overflow:hidden;border:1px solid var(--brd);background:#f8fafb}
.sim-tab{flex:1;padding:.65rem .5rem;border:none;background:none;font-size:.8rem;font-weight:600;color:var(--txtL);cursor:pointer;transition:var(--trans);border-right:1px solid var(--brd);text-align:center}
.sim-tab:last-child{border-right:none}
.sim-tab:hover{background:rgba(26,74,122,.04);color:var(--p)}
.sim-tab.active{background:var(--card);color:var(--pl);box-shadow:inset 0 -3px 0 var(--pl)}
.sim-tab .tab-sub{display:block;font-size:.68rem;font-weight:400;color:var(--txtL);margin-top:.15rem}
.sim-tab.active .tab-sub{color:var(--pl)}

/* === SIM YEAR OVERVIEW === */
.sim-year-overview{margin-bottom:1.2rem}
.sim-year-overview .profit-yr{cursor:pointer;transition:var(--trans)}
.sim-year-overview .profit-yr:hover{background:rgba(26,74,122,.03)}
.sim-year-overview .profit-yr.highlight{background:rgba(26,74,122,.06);box-shadow:inset 0 -3px 0 var(--pl)}

/* === SIM YEAR DETAIL === */
.sim-year-detail{animation:fadeIn .25s ease}
.sim-year-verdict{margin-bottom:1rem}
.sim-sensitivity{display:flex;flex-wrap:wrap;gap:.5rem;margin:.8rem 0 1.2rem}
.sens-tag{font-size:.72rem;padding:.3rem .7rem;border-radius:16px;font-weight:500;border:1px solid var(--brd);background:#f8fafb;color:var(--txtL)}
.sens-tag.high{border-color:var(--danger);color:var(--danger);background:rgba(214,48,49,.04)}
.sens-tag.medium{border-color:var(--warn);color:#d68910;background:rgba(253,203,110,.08)}
.sens-tag.low{border-color:var(--acc);color:#00755a;background:rgba(0,184,148,.04)}

/* === SIM STRUCTURED SUMMARY === */
.sim-summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:.8rem}
.sim-summary-yr{border-radius:10px;padding:.9rem 1rem;background:#f8fafb;border-left:3px solid var(--brd)}
.sim-summary-yr.y1{border-left-color:var(--pl)}
.sim-summary-yr.y2{border-left-color:var(--acc2)}
.sim-summary-yr.y3{border-left-color:var(--acc)}
.sim-summary-yr h4{font-size:.78rem;font-weight:700;color:var(--p);margin-bottom:.4rem}
.sim-summary-yr ul{list-style:none;font-size:.8rem;line-height:1.7;color:var(--txt)}
.sim-summary-yr ul li::before{content:'\2022';color:var(--txtL);margin-right:.4rem}
.sim-top-kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:.7rem;margin-bottom:1.2rem}
.sim-compare{border-radius:var(--r);padding:.8rem 1rem;margin-bottom:1.2rem;background:rgba(26,74,122,.03);border:1px solid rgba(26,74,122,.1);display:none}
.sim-compare.show{display:block}
.sim-compare h4{font-size:.76rem;font-weight:700;color:var(--p);margin-bottom:.5rem}
.sim-compare-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:.5rem}
.sim-compare-item{text-align:center;padding:.4rem;border-radius:8px;background:var(--card)}
.sim-compare-item .scl{font-size:.68rem;color:var(--txtL);margin-bottom:.15rem}
.sim-compare-item .scv{font-size:.88rem;font-weight:800}
.sim-compare-item .scv.up{color:var(--acc)}
.sim-compare-item .scv.down{color:var(--danger)}
.sim-compare-item .scv.neutral{color:var(--txtL)}
.sim-phase{font-size:.63rem;font-weight:600;padding:.12rem .4rem;border-radius:10px;margin-left:.4rem}
.sim-phase.start{background:rgba(225,112,85,.1);color:#e17055}
.sim-phase.grow{background:rgba(253,203,110,.15);color:#7d5a12}
.sim-phase.cruise{background:rgba(0,184,148,.1);color:var(--acc)}

@media(max-width:768px){
  .sim-year-tabs{flex-wrap:nowrap;overflow-x:auto}
  .sim-tab{min-width:0;padding:.5rem .3rem;font-size:.72rem}
  .sim-summary-grid{grid-template-columns:1fr}
  .sim-top-kpis{grid-template-columns:1fr 1fr}
  .rev-profile-bar{overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch}
  .rev-detail-grid{grid-template-columns:1fr}
}

/* === RESET BUTTON === */
.btn-reset{background:none;border:1px solid var(--brd);color:var(--txtL);padding:.35rem .7rem;border-radius:8px;font-size:.72rem;cursor:pointer;transition:var(--trans)}
.btn-reset:hover{border-color:var(--danger);color:var(--danger)}

/* === SCENARIO SAVE/LOAD === */
.sim-actions{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}
.sim-actions .btn{font-size:.75rem;padding:.35rem .7rem}
.scenario-list{max-height:200px;overflow-y:auto;border:1px solid var(--brd);border-radius:8px;margin-bottom:1rem;display:none}
.scenario-list.show{display:block}
.scenario-item{padding:.5rem .8rem;font-size:.8rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #f0f3f5}
.scenario-item:hover{background:#f8fafb}
.scenario-item:last-child{border-bottom:none}
.scenario-item .del{color:var(--danger);cursor:pointer;font-size:.7rem;padding:.2rem .4rem;border:none;background:none}

/* === ADMIN PANEL === */
.admin-panel{display:none;margin-top:1.2rem}
.admin-panel.show{display:block}
.admin-emails{list-style:none;padding:0}
.admin-emails li{display:flex;justify-content:space-between;align-items:center;padding:.4rem 0;border-bottom:1px solid #f0f3f5;font-size:.82rem}
.admin-add{display:flex;gap:.5rem;margin-top:.8rem}
.admin-add input{flex:1;padding:.4rem .6rem;border:1px solid var(--brd);border-radius:8px;font-size:.82rem}

/* === MOBILE === */
@media(max-width:768px){
  .sidebar{width:64px}.sidebar .nav-label,.sidebar .logo h1,.sidebar .logo-sub,.sidebar .sidebar-footer span{display:none}
  .main-area{margin-left:64px}.content{padding:1rem}.kpi-grid{grid-template-columns:1fr 1fr}
  .toggle-btn{display:none}
  .exec-dash{flex-direction:column;align-items:stretch}
  .exec-kpis{grid-template-columns:repeat(3,1fr)}
  .exec-spark{width:100%;height:40px}
}

/* === PRINT/PDF === */
@media print{
  .sidebar,.topbar,.dropzone,.toggle-btn,.exec-dash{display:none!important}
  .main-area{margin-left:0!important}
  .section{display:block!important;page-break-inside:avoid}
  .card{box-shadow:none;border:1px solid #ddd}
}
/* === AUTH GATE === */
#app-content{display:none}
#login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#0f2b46 0%,#1a4a7a 50%,#00b894 100%);font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
.login-card{background:#fff;border-radius:20px;padding:2.5rem 2.5rem 2rem;max-width:420px;width:90%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.login-card .logo-auth{display:flex;align-items:center;justify-content:center;gap:.6rem;margin-bottom:.5rem}
.login-card .logo-auth .dot{width:12px;height:12px;border-radius:50%;background:#00b894}
.login-card .logo-auth h1{font-size:1.6rem;font-weight:800;color:#0f2b46;letter-spacing:-.5px}
.login-card .subtitle{font-size:.85rem;color:#636e72;margin-bottom:2rem}
.login-card .divider{height:1px;background:#dfe6e9;margin:1.5rem 0}
.login-card .access-info{font-size:.75rem;color:#b2bec3;margin-top:1rem}
.login-card .error-msg{background:#fdeaea;color:#c0392b;padding:.6rem 1rem;border-radius:10px;font-size:.82rem;margin-top:1rem;display:none}
#g_id_onload,#google-btn{display:flex;justify-content:center}
.logout-btn{background:none;border:1px solid rgba(255,255,255,.3);color:rgba(255,255,255,.7);padding:.35rem .8rem;border-radius:8px;font-size:.75rem;cursor:pointer;transition:all .25s ease;margin-left:.5rem}
.logout-btn:hover{background:rgba(255,255,255,.1);color:#fff;border-color:rgba(255,255,255,.6)}
.user-info{display:flex;align-items:center;gap:.5rem;font-size:.8rem;color:rgba(255,255,255,.8)}
.user-info img{width:26px;height:26px;border-radius:50%;border:2px solid rgba(255,255,255,.3)}
</style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div id="login-screen">
  <div class="login-card">
    <div class="logo-auth">
      <div class="dot"></div>
      <h1>GYNEVA</h1>
    </div>
    <p class="subtitle">Business Plan Interactif &mdash; Acc&egrave;s restreint</p>
    <div id="google-btn"></div>
    <div class="divider"></div>
    <p class="access-info">Seuls les comptes autoris&eacute;s peuvent acc&eacute;der &agrave; cette application.</p>
    <div class="error-msg" id="auth-error"></div>
  </div>
</div>

<!-- ===== APP CONTENT (hidden until auth) ===== -->
<div id="app-content">

<!-- ===== SIDEBAR ===== -->
<div class="sidebar" id="sidebar">
  <button class="toggle-btn" onclick="toggleSidebar()" id="toggleBtn">&#9664;</button>
  <div class="logo">
    <div class="dot"></div>
    <div>
      <h1>GYNEVA</h1>
      <div class="logo-sub">Business Plan · Gen&egrave;ve</div>
    </div>
  </div>
  <nav>
    <button class="active" onclick="nav('overview',this)"><span class="nav-icon">&#128200;</span><span class="nav-label">Vue d'ensemble</span><span class="nav-badge none" id="badge-overview"></span></button>
    <button onclick="nav('simulator',this)"><span class="nav-icon">&#9881;&#65039;</span><span class="nav-label">Simulateur</span></button>
    <button onclick="nav('revenue',this)"><span class="nav-icon">&#128176;</span><span class="nav-label">Revenus</span><span class="nav-badge none" id="badge-revenue"></span></button>
    <button onclick="nav('cashflow',this)"><span class="nav-icon">&#128202;</span><span class="nav-label">Tr&eacute;sorerie</span><span class="nav-badge none" id="badge-cashflow"></span></button>
    <button onclick="nav('team',this)"><span class="nav-icon">&#128101;</span><span class="nav-label">&Eacute;quipe</span><span class="nav-badge none" id="badge-team"></span></button>
    <button onclick="nav('risks',this)"><span class="nav-icon">&#9888;&#65039;</span><span class="nav-label">Risques</span><span class="nav-badge none" id="badge-risks"></span></button>
    <button onclick="nav('profit',this)"><span class="nav-icon">&#128181;</span><span class="nav-label">Profit associ&eacute;s</span><span class="nav-badge none" id="badge-profit"></span></button>
    <button onclick="nav('optimize',this)"><span class="nav-icon">&#128161;</span><span class="nav-label">Optimisations</span><span class="nav-badge none" id="badge-optimize"></span></button>
    <button id="navAdmin" style="display:none" onclick="nav('admin',this)"><span class="nav-icon">&#128274;</span><span class="nav-label">Admin</span></button>
  </nav>
  <div class="sidebar-footer"><span>Analyse confidentielle &middot; 2025</span></div>
</div>

<!-- ===== MAIN ===== -->
<div class="main-area">
<div class="topbar">
  <div class="page-title" id="pageTitle">Vue d'ensemble</div>
  <div class="plan-switcher" id="planSwitcher">
    <span class="plan-name" onclick="togglePlanDropdown()" id="planNameDisplay">Plan initial</span>
    <div class="plan-dropdown" id="planDropdown">
      <div id="planListItems"></div>
      <div class="pd-footer"><button onclick="createNewPlan()">+ Nouveau plan</button></div>
    </div>
  </div>
  <div class="spacer"></div>
  <div class="status-pill static" id="statusPill"><div class="status-dot static" id="statusDot"></div><span id="statusLabel">Donn&eacute;es int&eacute;gr&eacute;es</span></div>
  <button class="btn" onclick="document.getElementById('fileInput').click()">&#128196; Importer Excel</button>
  <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none" onchange="handleFile(this.files[0])">
  <button class="btn" onclick="openVersionPanel()">&#128338; Versions</button>
  <button class="btn" onclick="openCompare()">&#128200; Comparer</button>
  <button class="btn primary" onclick="exportPDF()">&#128424; Export PDF</button>
</div>

<div class="exec-dash" id="execDashboard">
  <button class="exec-toggle" onclick="toggleExecDash()" id="execToggle">&#9660;</button>
  <div class="exec-body" id="execBody">
    <div class="exec-gauge-wrap">
      <svg viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(255,255,255,.15)" stroke-width="8"/>
        <circle id="execArc" cx="50" cy="50" r="42" fill="none" stroke="#00b894" stroke-width="8" stroke-linecap="round" stroke-dasharray="0 264" transform="rotate(-90 50 50)"/>
        <text id="execScoreText" x="50" y="50" text-anchor="middle" dominant-baseline="central" fill="#fff" font-size="22" font-weight="800">&mdash;</text>
      </svg>
      <div class="exec-gauge-label" id="execScoreLabel">Score global</div>
    </div>
    <div class="exec-kpis" id="execKpis"></div>
    <div class="exec-spark" id="execSpark">
      <canvas id="cExecSpark"></canvas>
    </div>
  </div>
</div>

<div class="content">

<!-- DROPZONE -->
<div class="dropzone" id="dropzone">
  <div class="dz-icon">&#128196;</div>
  <div class="dz-text" id="dzText">Glissez votre fichier GYNEVA_Business_Plan.xlsx ici</div>
  <div class="dz-sub">ou cliquez pour s&eacute;lectionner &middot; Fichier envoy&eacute; au serveur pour traitement</div>
  <input type="file" accept=".xlsx,.xls" onchange="handleFile(this.files[0])">
</div>

<!-- IMPORT SUMMARY -->
<div class="import-summary" id="importSummary">
  <h3>&#128203; R&eacute;sum&eacute; de l'import</h3>
  <div id="importDiffContent"></div>
</div>

<!-- OVERLAY CONTROL -->
<div class="overlay-control" id="overlayControl" style="display:none">
  <label><span class="overlay-indicator" id="overlayDot"></span> Sc&eacute;nario overlay :</label>
  <select id="overlayScenarioSelect" onchange="applyScenarioOverlay()">
    <option value="">Aucun (d&eacute;sactiv&eacute;)</option>
  </select>
  <button onclick="refreshOverlayScenarios()">&#8635; Rafra&icirc;chir</button>
</div>

<!-- ====== OVERVIEW ====== -->
<div class="section active" id="overview">
  <div class="verdict green" id="ovVerdict">
    <div class="ic">&#9989;</div>
    <div id="ovVerdictText"><strong>Analyse du projet en cours.</strong></div>
  </div>
  <div class="kpi-grid">
    <div class="kpi blue"><div class="lb">Investissement total</div><div class="vl" id="ovCapex">&mdash;</div><div class="sb">CAPEX + &eacute;quipements</div></div>
    <div class="kpi green"><div class="lb">CA Ann&eacute;e 3</div><div class="vl" id="ovCaY3">&mdash;</div><div class="sb" id="ovCaGrowth">Croissance</div></div>
    <div class="kpi green"><div class="lb">R&eacute;sultat net Ann&eacute;e 3</div><div class="vl" id="ovResY3">&mdash;</div><div class="sb" id="ovMargin">Marge</div></div>
    <div class="kpi"><div class="lb">Marge nette Y3</div><div class="vl" id="ovMarginPct">&mdash;</div><div class="sb">R&eacute;sultat / CA</div></div>
    <div class="kpi blue"><div class="lb">Retour sur investissement</div><div class="vl" id="ovPayback">&mdash;</div><div class="sb">Payback period</div></div>
    <div class="kpi"><div class="lb">BFR minimum</div><div class="vl" id="ovBfr">&mdash;</div><div class="sb" id="ovBfrSub">Besoin en fonds de roulement</div></div>
  </div>
  <div class="ov-year-tl" id="ovYearTl"></div>
  <div class="card">
    <h2><span class="ic">&#128200;</span> &Eacute;volution sur 3 ans</h2>
    <div class="chart-box"><canvas id="cOverview"></canvas></div>
  </div>
  <div class="ov-summary-grid" id="ovSummaryGrid"></div>
  <div class="card">
    <h2><span class="ic">&#9881;</span> Hypoth&egrave;ses cl&eacute;s du mod&egrave;le</h2>
    <div class="exp">Le mod&egrave;le repose sur les standards TARMED pour la gyn&eacute;cologie &agrave; Gen&egrave;ve. Chaque hypoth&egrave;se est modifiable via le <strong>Simulateur</strong> ou dans le fichier Excel.</div>
    <div class="pills" id="pillsAssumptions">
      <div class="pill"><b>16</b> consult./jour</div>
      <div class="pill"><b>CHF 225</b> /consultation</div>
      <div class="pill"><b>215</b> jours/an</div>
      <div class="pill"><b>60/40</b> partage associ&eacute;s</div>
    </div>
  </div>
</div>

<!-- ====== SIMULATOR ====== -->
<div class="section" id="simulator">
  <div class="verdict orange" id="simVerdict">
    <div class="ic">&#9881;&#65039;</div>
    <div id="simVerdictText"><strong>Simulateur de sc&eacute;narios.</strong> Modifiez les hypoth&egrave;ses ci-dessous et observez l'impact en temps r&eacute;el sur le chiffre d'affaires, le r&eacute;sultat net et la tr&eacute;sorerie. Les valeurs de base du business plan sont pr&eacute;-remplies.</div>
  </div>
  <!-- Scenario save/load -->
  <div class="sim-actions">
    <button class="btn" onclick="saveScenario()">&#128190; Sauvegarder sc&eacute;nario</button>
    <button class="btn" onclick="toggleScenarioList()">&#128194; Charger sc&eacute;nario</button>
  </div>
  <div class="scenario-list" id="scenarioList"></div>
  <div class="sim-top-kpis" id="simTopKpis">
    <div class="kpi blue"><div class="lb">CA total 3 ans</div><div class="vl" id="simTopCa3">&mdash;</div><div class="sb" id="simTopCa3Sub">Simulation</div></div>
    <div class="kpi blue"><div class="lb">R&eacute;sultat total 3 ans</div><div class="vl" id="simTopRes3">&mdash;</div><div class="sb" id="simTopRes3Sub">Simulation</div></div>
    <div class="kpi blue"><div class="lb">BFR minimum</div><div class="vl" id="simTopBfr">&mdash;</div><div class="sb" id="simTopBfrSub">Tr&eacute;sorerie min</div></div>
    <div class="kpi blue"><div class="lb">Tr&eacute;so finale (M36)</div><div class="vl" id="simTopTreso">&mdash;</div><div class="sb" id="simTopTresoSub">Cumul M36</div></div>
  </div>
  <div class="sim-compare" id="simCompare">
    <h4>&#128200; &Eacute;cart vs. base</h4>
    <div class="sim-compare-grid" id="simCompareGrid"></div>
  </div>
  <div class="sim-layout">
    <!-- CONTROLS PANEL -->
    <div class="sim-panel">
      <h2>&#9881;&#65039; Param&egrave;tres <button class="btn-reset" onclick="resetSim()" style="margin-left:auto">&#8635; R&eacute;initialiser</button></h2>

      <div class="sim-group">
        <h3>&#128137; Activit&eacute; m&eacute;dicale</h3>
        <div class="sim-row">
          <label>Consultations / jour <span id="sConsultVal">16</span></label>
          <input type="range" id="sConsult" min="8" max="24" step="1" value="16" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Honoraires moyens (CHF) <span id="sFeeVal">225</span></label>
          <input type="range" id="sFee" min="120" max="350" step="5" value="225" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Jours travaill&eacute;s / an <span id="sDaysVal">215</span></label>
          <input type="range" id="sDays" min="180" max="250" step="5" value="215" oninput="runSim()">
        </div>
      </div>

      <div class="sim-group">
        <h3>&#128101; &Eacute;quipe m&eacute;dicale</h3>
        <div class="sim-row">
          <label>Associ&eacute;s (sp&eacute;cialistes) <span id="sAssocVal">2</span></label>
          <input type="range" id="sAssoc" min="1" max="4" step="1" value="2" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>M&eacute;decins ind&eacute;pendants <span id="sIndepVal">3</span></label>
          <input type="range" id="sIndep" min="0" max="6" step="1" value="3" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>M&eacute;decins internes <span id="sInterneVal">2</span></label>
          <input type="range" id="sInterne" min="0" max="4" step="1" value="2" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>R&eacute;trocession GynEva <span id="sRetroVal">40%</span></label>
          <input type="range" id="sRetro" min="20" max="60" step="5" value="40" oninput="runSim()">
        </div>
      </div>

      <div class="sim-group">
        <h3>&#128176; Tr&eacute;sorerie &amp; paiements</h3>
        <div class="sim-row">
          <label>D&eacute;lai paiement LAMal</label>
          <select id="sDelay" onchange="runSim()">
            <option value="0">Sans d&eacute;lai (id&eacute;al)</option>
            <option value="1" selected>1 mois (r&eacute;aliste)</option>
            <option value="3">3 mois (prudent)</option>
          </select>
        </div>
        <div class="sim-row">
          <label>Patients OI/ONU (cash) <span id="sCashVal">15%</span></label>
          <input type="range" id="sCash" min="0" max="30" step="1" value="15" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Factoring Caisse M&eacute;decins
            <div class="toggle">
              <div class="toggle-sw on" id="sFactToggle" onclick="this.classList.toggle('on');runSim()"></div>
            </div>
          </label>
        </div>
      </div>

      <div class="sim-group">
        <h3>&#128178; Charges suppl&eacute;mentaires</h3>
        <div class="sim-row">
          <label>Charges non budg&eacute;t&eacute;es / an (CHF) <span id="sExtraVal">200k</span></label>
          <input type="range" id="sExtra" min="0" max="400000" step="10000" value="200000" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Co&ucirc;t RC obst&eacute;trique / an (CHF) <span id="sRCVal">60k</span></label>
          <input type="range" id="sRC" min="0" max="120000" step="5000" value="60000" oninput="runSim()">
        </div>
      </div>

      <div class="sim-group">
        <h3>&#128200; Mont&eacute;e en charge</h3>
        <div class="sim-row">
          <label>Mois d&eacute;but activit&eacute; <span id="sStartVal">4</span></label>
          <input type="range" id="sStart" min="1" max="12" step="1" value="4" oninput="runSim()">
        </div>
        <div class="sim-row">
          <label>Taux occupation Y1 <span id="sOccupVal">60%</span></label>
          <input type="range" id="sOccup" min="30" max="100" step="5" value="60" oninput="runSim()">
        </div>
      </div>
    </div>

    <!-- RESULTS PANEL -->
    <div class="sim-results">
      <!-- YEAR TABS -->
      <div class="sim-year-tabs" id="simYearTabs">
        <button class="sim-tab active" data-year="all" onclick="switchSimYear('all',this)">Vue 3 ans<span class="tab-sub">Synth&egrave;se</span></button>
        <button class="sim-tab" data-year="1" onclick="switchSimYear('1',this)">Ann&eacute;e 1<span class="tab-sub">D&eacute;marrage</span></button>
        <button class="sim-tab" data-year="2" onclick="switchSimYear('2',this)">Ann&eacute;e 2<span class="tab-sub">Croissance</span></button>
        <button class="sim-tab" data-year="3" onclick="switchSimYear('3',this)">Ann&eacute;e 3<span class="tab-sub">Croisi&egrave;re</span></button>
      </div>
      <!-- YEAR OVERVIEW TIMELINE -->
      <div class="sim-year-overview">
        <div class="profit-tl">
          <div class="profit-yr" id="simYrCard1" onclick="switchSimYear('1',document.querySelector('[data-year=&quot;1&quot;]'))">
            <div class="yl">Ann&eacute;e 1</div>
            <div class="am" id="simOvCaY1">&mdash;</div>
            <div class="pa" id="simOvResY1">&mdash;</div>
            <div class="nt" id="simOvDeltaY1"></div>
          </div>
          <div class="profit-yr" id="simYrCard2" onclick="switchSimYear('2',document.querySelector('[data-year=&quot;2&quot;]'))">
            <div class="yl">Ann&eacute;e 2</div>
            <div class="am" id="simOvCaY2">&mdash;</div>
            <div class="pa" id="simOvResY2">&mdash;</div>
            <div class="nt" id="simOvDeltaY2"></div>
          </div>
          <div class="profit-yr" id="simYrCard3" onclick="switchSimYear('3',document.querySelector('[data-year=&quot;3&quot;]'))">
            <div class="yl">Ann&eacute;e 3</div>
            <div class="am" id="simOvCaY3">&mdash;</div>
            <div class="pa" id="simOvResY3">&mdash;</div>
            <div class="nt" id="simOvDeltaY3"></div>
          </div>
        </div>
      </div>
      <!-- YEAR DETAIL: VERDICT + KPIs + SENSITIVITY -->
      <div id="simYearDetail">
        <div id="simYearVerdict" class="verdict green" style="display:none"></div>
        <div class="kpi-grid" id="simYearKpis"></div>
        <div class="sim-sensitivity" id="simSensitivity"></div>
      </div>
      <!-- CHARTS -->
      <div class="card">
        <h2><span class="ic">&#128200;</span> Projection simul&eacute;e &mdash; CA &amp; R&eacute;sultat</h2>
        <div class="chart-box"><canvas id="cSim1"></canvas></div>
      </div>
      <div class="card">
        <h2><span class="ic">&#128202;</span> Tr&eacute;sorerie simul&eacute;e</h2>
        <div class="chart-box"><canvas id="cSim2"></canvas></div>
      </div>
      <!-- STRUCTURED SUMMARY -->
      <div class="card">
        <h2><span class="ic">&#128176;</span> Synth&egrave;se du sc&eacute;nario simul&eacute;</h2>
        <div class="sim-summary-grid" id="simSummary"></div>
      </div>
    </div>
  </div>
</div>

<!-- ====== REVENUE ====== -->
<div class="section" id="revenue">
  <div class="verdict green" id="revVerdict">
    <div class="ic">&#128176;</div>
    <div id="revVerdictText"><strong>Analyse du chiffre d'affaires en cours.</strong></div>
  </div>
  <div class="rev-controls">
    <div class="rev-ctrl">
      <label>P&eacute;riode</label>
      <div class="rev-year-btns">
        <button class="rev-year-btn active" onclick="setRevYear('all',this)">Tous</button>
        <button class="rev-year-btn" onclick="setRevYear('1',this)">Y1</button>
        <button class="rev-year-btn" onclick="setRevYear('2',this)">Y2</button>
        <button class="rev-year-btn" onclick="setRevYear('3',this)">Y3</button>
      </div>
    </div>
    <div class="rev-profile-bar" id="revProfileBar">
      <button class="rev-prof active" data-prof="all" onclick="toggleRevProfile('all',this)">Tous</button>
      <button class="rev-prof active" data-prof="assoc" onclick="toggleRevProfile('assoc',this)"><span class="prof-dot" style="background:#0f2b46"></span> Associ&eacute;s</button>
      <button class="rev-prof active" data-prof="indep" onclick="toggleRevProfile('indep',this)"><span class="prof-dot" style="background:#1a4a7a"></span> Ind&eacute;pendants</button>
      <button class="rev-prof active" data-prof="interne" onclick="toggleRevProfile('interne',this)"><span class="prof-dot" style="background:#5dade2"></span> Internes</button>
      <button class="rev-prof active" data-prof="sage" onclick="toggleRevProfile('sage',this)"><span class="prof-dot" style="background:#aed6f1"></span> Sage-femme</button>
    </div>
  </div>
  <div class="kpi-grid">
    <div class="kpi blue"><div class="lb">Potentiel / sp&eacute;cialiste</div><div class="vl" id="revKpiSpec">&mdash;</div><div class="sb">CHF/an &agrave; 100%</div></div>
    <div class="kpi"><div class="lb">CA p&eacute;riode</div><div class="vl" id="revKpiCa">&mdash;</div><div class="sb" id="revKpiCaSub">Total filtr&eacute;</div></div>
    <div class="kpi"><div class="lb">Croissance</div><div class="vl" id="revKpiGrowth">&mdash;</div><div class="sb" id="revKpiGrowthSub">vs ann&eacute;e pr&eacute;c&eacute;dente</div></div>
    <div class="kpi green"><div class="lb">Diversification</div><div class="vl" id="revKpiDiversif">&mdash;</div><div class="sb" id="revKpiDiversifSub">Sources actives</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#128176;</span> CA mensuel par source</h2>
    <div class="chart-box"><canvas id="cRevenue"></canvas></div>
  </div>
  <div class="rev-detail-grid" id="revDetailGrid"></div>
  <div class="card">
    <h2><span class="ic">&#128178;</span> Mod&egrave;le de partage du chiffre d'affaires</h2>
    <div class="exp"><strong>Associ&eacute;s :</strong> <span id="revRetroDoc">60</span>% de leurs honoraires pour eux, <span id="revRetroGyneva">40</span>% pour GynEva.<br><strong>Ind&eacute;pendants :</strong> <span id="revRetroDoc2">60</span>% pour eux, <span id="revRetroGyneva2">40</span>% pour GynEva.<br><strong>Internes :</strong> Salari&eacute;s &mdash; GynEva garde le CA et paye le salaire.<br><strong>Sage-femme :</strong> Contribution nette via les prestations maternit&eacute;.</div>
  </div>
</div>

<!-- ====== CASHFLOW ====== -->
<div class="section" id="cashflow">
  <div class="verdict orange" id="cfVerdict">
    <div class="ic">&#9888;&#65039;</div>
    <div id="cfVerdictText"><strong>Analyse de la tr&eacute;sorerie en cours.</strong></div>
  </div>
  <div class="cf-controls">
    <div class="cf-ctrl">
      <label>P&eacute;riode</label>
      <div class="cf-year-btns">
        <button class="cf-year-btn active" onclick="setCfYear('all',this)">Tous</button>
        <button class="cf-year-btn" onclick="setCfYear('1',this)">Y1</button>
        <button class="cf-year-btn" onclick="setCfYear('2',this)">Y2</button>
        <button class="cf-year-btn" onclick="setCfYear('3',this)">Y3</button>
      </div>
    </div>
  </div>
  <div class="kpi-grid">
    <div class="kpi"><div class="lb">Tr&eacute;sorerie finale</div><div class="vl" id="cfTresoFin">&mdash;</div><div class="sb" id="cfTresoFinSub">Fin de p&eacute;riode</div></div>
    <div class="kpi red"><div class="lb">BFR minimum</div><div class="vl" id="cfBfrMin">&mdash;</div><div class="sb" id="cfBfrMinSub">Pire mois sur la p&eacute;riode</div></div>
    <div class="kpi"><div class="lb">Mois critique</div><div class="vl" id="cfCritMonth">&mdash;</div><div class="sb" id="cfCritMonthSub">1er mois n&eacute;gatif</div></div>
    <div class="kpi"><div class="lb">Ratio entr&eacute;es / sorties</div><div class="vl" id="cfRatio">&mdash;</div><div class="sb" id="cfRatioSub">Encaissements vs d&eacute;caissements</div></div>
  </div>
  <div class="card">
    <h2><span class="ic">&#128202;</span> Tr&eacute;sorerie cumul&eacute;e &mdash; Sc&eacute;narios compar&eacute;s</h2>
    <div class="chart-box"><canvas id="cCashflow"></canvas></div>
  </div>
  <div class="cf-scenario-grid" id="cfScenarioGrid"></div>
  <div class="card">
    <h2><span class="ic">&#128200;</span> Flux de tr&eacute;sorerie mensuel net</h2>
    <div class="chart-box"><canvas id="cCashWaterfall"></canvas></div>
  </div>
</div>

<!-- ====== TEAM ====== -->
<div class="section" id="team">
  <div class="verdict green" id="teamVerdict">
    <div class="ic">&#128101;</div>
    <div id="teamVerdictText"><strong>Equipe en croissance.</strong></div>
  </div>
  <div class="team-controls">
    <div class="team-ctrl">
      <label>P&eacute;riode</label>
      <div class="team-year-btns">
        <button class="team-year-btn active" onclick="setTeamYear('all',this)">Tous</button>
        <button class="team-year-btn" onclick="setTeamYear('1',this)">Y1</button>
        <button class="team-year-btn" onclick="setTeamYear('2',this)">Y2</button>
        <button class="team-year-btn" onclick="setTeamYear('3',this)">Y3</button>
      </div>
    </div>
    <div class="team-ctrl">
      <label>Productivit&eacute;</label>
      <div class="toggle-sw on" id="teamProdToggle" onclick="this.classList.toggle('on');updateTeam()"></div>
    </div>
  </div>
  <div class="kpi-grid">
    <div class="kpi"><div class="lb">ETP total</div><div class="vl" id="tEtp">&mdash;</div><div class="sb" id="tEtpSub">Fin de p&eacute;riode</div></div>
    <div class="kpi green"><div class="lb">CA / ETP</div><div class="vl" id="tCaEtp">&mdash;</div><div class="sb" id="tCaEtpSub">Productivit&eacute; moyenne</div></div>
    <div class="kpi"><div class="lb">Admin / Praticiens</div><div class="vl" id="tRatio">&mdash;</div><div class="sb" id="tRatioSub">Ratio overhead</div></div>
    <div class="kpi"><div class="lb">Croissance ETP</div><div class="vl" id="tGrowth">&mdash;</div><div class="sb" id="tGrowthSub">Sur la p&eacute;riode</div></div>
  </div>
  <div class="team-profiles" id="teamProfiles"></div>
  <div class="card">
    <h2><span class="ic">&#128101;</span> Mont&eacute;e en charge de l'&eacute;quipe (ETP)</h2>
    <div class="chart-box"><canvas id="cTeam"></canvas></div>
  </div>
  <div class="card" id="teamProdCard">
    <h2><span class="ic">&#128200;</span> Productivit&eacute; &mdash; CA par ETP (36 mois)</h2>
    <div class="chart-box"><canvas id="cTeamProd"></canvas></div>
  </div>
</div>

<!-- ====== RISKS ====== -->
<div class="section" id="risks">
  <!-- Global risk indicator -->
  <div class="risk-gauge low" id="riskGauge">
    <div class="risk-gauge-ring">
      <svg width="80" height="80" viewBox="0 0 80 80">
        <circle cx="40" cy="40" r="34" fill="none" stroke="#eee" stroke-width="6"/>
        <circle cx="40" cy="40" r="34" fill="none" stroke="var(--acc)" stroke-width="6" stroke-dasharray="213.6" stroke-dashoffset="213.6" stroke-linecap="round" id="riskArc"/>
      </svg>
      <div class="risk-gauge-score" id="riskScore">&mdash;</div>
    </div>
    <div class="risk-gauge-info">
      <div class="risk-gauge-label" id="riskLabel">Risque global</div>
      <div class="risk-gauge-sub" id="riskSub">Score composite int&eacute;grant la sensibilit&eacute; du stress test et la matrice des risques.</div>
    </div>
  </div>

  <!-- Interactive stress test -->
  <div class="card">
    <h2><span class="ic">&#127919;</span> Stress test interactif</h2>
    <div class="exp">Ajustez les variables cl&eacute;s pour &eacute;valuer la sensibilit&eacute; du projet. Les sc&eacute;narios pessimiste/optimiste sont recalcul&eacute;s dynamiquement (&plusmn;25%).</div>
    <div class="risk-controls">
      <div class="risk-ctrl"><label>Consult./jour</label><input type="range" id="rConsult" min="8" max="24" step="1" value="16" oninput="updateRisks()"><span class="risk-val" id="rConsultVal">16</span></div>
      <div class="risk-ctrl"><label>Honoraires</label><input type="range" id="rFee" min="120" max="350" step="5" value="225" oninput="updateRisks()"><span class="risk-val" id="rFeeVal">CHF 225</span></div>
      <div class="risk-ctrl"><label>Occup. Y1</label><input type="range" id="rOccup" min="30" max="100" step="5" value="60" oninput="updateRisks()"><span class="risk-val" id="rOccupVal">60%</span></div>
      <div class="risk-ctrl"><label>D&eacute;lai mont&eacute;e</label><input type="range" id="rStart" min="1" max="12" step="1" value="4" oninput="updateRisks()"><span class="risk-val" id="rStartVal">4 mois</span></div>
    </div>
    <div class="kpi-grid">
      <div class="kpi"><div class="lb">CA Ann&eacute;e 3</div><div class="vl" id="rCaY3">&mdash;</div><div class="sb" id="rCaY3Delta"></div></div>
      <div class="kpi"><div class="lb">R&eacute;sultat Ann&eacute;e 3</div><div class="vl" id="rResY3">&mdash;</div><div class="sb" id="rResY3Delta"></div></div>
      <div class="kpi"><div class="lb">BFR minimum</div><div class="vl" id="rBfrMin">&mdash;</div><div class="sb">Tr&eacute;sorerie pire mois</div></div>
      <div class="kpi"><div class="lb">Tr&eacute;so finale (M36)</div><div class="vl" id="rTresoFinal">&mdash;</div><div class="sb">Cumul&eacute; fin de p&eacute;riode</div></div>
    </div>
    <div class="risk-scenario-grid" id="riskScenarioGrid"></div>
    <h3 style="margin:1rem 0 .6rem;font-size:.85rem;color:var(--p)">Sensibilit&eacute; &mdash; Impact relatif sur le r&eacute;sultat Y3</h3>
    <div class="risk-sensitivity" id="riskSensitivity"></div>
    <div class="chart-box"><canvas id="cRiskStress"></canvas></div>
  </div>

  <!-- Interactive risk matrix -->
  <div class="card">
    <h2><span class="ic">&#9888;&#65039;</span> Matrice des risques interactive</h2>
    <div class="exp">Cliquez sur les badges de probabilit&eacute; ou d'impact pour ajuster le scoring (cycle 1&rarr;5). Triez par colonne en cliquant sur les en-t&ecirc;tes.</div>
    <div class="risk-matrix-interactive" id="riskMatrixContainer"></div>
    <div class="risk-exposure"><span class="re-label">Exposition totale :</span><span class="re-value" id="riskExposureVal">&mdash;</span></div>
  </div>

  <!-- Charges non budgetees -->
  <div class="card">
    <h2><span class="ic">&#128680;</span> Charges non budg&eacute;t&eacute;es identifi&eacute;es</h2>
    <div class="charges-summary">
      <div class="charges-chart-box"><canvas id="cCharges"></canvas></div>
      <div class="charges-total"><strong id="chargesTotalLabel">&mdash;</strong>R&eacute;partition par criticit&eacute; et poste. Total int&eacute;gr&eacute; dans le calcul du risque global.</div>
    </div>
    <table class="dt"><thead><tr><th>Poste</th><th>Estimation min</th><th>Estimation max</th><th>Criticit&eacute;</th></tr></thead>
    <tbody id="chargesBody"></tbody></table>
  </div>
</div>

<!-- ====== PROFIT ====== -->
<div class="section" id="profit">
  <!-- Dynamic verdict -->
  <div class="verdict green" id="profitVerdict">
    <div class="ic">&#128176;</div>
    <div id="profitVerdictText"><strong>ROI attractif.</strong></div>
  </div>

  <!-- Controls -->
  <div class="profit-controls">
    <div class="profit-ctrl"><label>Nombre d'associ&eacute;s</label><input type="range" id="pAssoc" min="1" max="4" step="1" value="2" oninput="updateProfit()"><span class="profit-val" id="pAssocVal">2</span></div>
    <div class="profit-ctrl"><label>Charges manquantes / an</label><input type="range" id="pCharges" min="0" max="400000" step="10000" value="200000" oninput="updateProfit()"><span class="profit-val" id="pChargesVal">200k</span></div>
  </div>

  <!-- 4 KPIs -->
  <div class="kpi-grid">
    <div class="kpi green"><div class="lb">ROI cumul&eacute; 3 ans</div><div class="vl" id="pRoi">&mdash;</div><div class="sb" id="pRoiSub">Retour sur investissement</div></div>
    <div class="kpi"><div class="lb">Payback</div><div class="vl" id="pPayback">&mdash;</div><div class="sb">Mois pour r&eacute;cup&eacute;rer l'investissement</div></div>
    <div class="kpi"><div class="lb">R&eacute;sultat / associ&eacute; Y3</div><div class="vl" id="pPerAssocY3">&mdash;</div><div class="sb" id="pPerAssocY3Sub">Apr&egrave;s charges manquantes</div></div>
    <div class="kpi"><div class="lb">Investissement / associ&eacute;</div><div class="vl" id="pInvestAssoc">&mdash;</div><div class="sb">Part du CAPEX</div></div>
  </div>

  <!-- Year timeline -->
  <div class="card">
    <h2><span class="ic">&#128181;</span> R&eacute;sultat net &mdash; Part par associ&eacute;</h2>
    <div class="profit-tl">
      <div class="profit-yr"><div class="yl">Ann&eacute;e 1</div><div class="am" id="pResY1">&mdash;</div><div class="pa" id="pPerY1"></div><div class="nt" id="pAdjY1"></div></div>
      <div class="profit-yr"><div class="yl">Ann&eacute;e 2</div><div class="am" id="pResY2">&mdash;</div><div class="pa" id="pPerY2"></div><div class="nt" id="pAdjY2"></div></div>
      <div class="profit-yr"><div class="yl">Ann&eacute;e 3</div><div class="am" id="pResY3">&mdash;</div><div class="pa" id="pPerY3"></div><div class="nt" id="pAdjY3"></div></div>
    </div>
  </div>

  <!-- Medecin vs Non-medecin breakdown -->
  <div class="profit-breakdown" id="profitBreakdown"></div>

  <!-- Bar chart -->
  <div class="card">
    <h2><span class="ic">&#128200;</span> R&eacute;sultat par associ&eacute; (graphique)</h2>
    <div class="chart-box sm"><canvas id="cProfit"></canvas></div>
  </div>

  <!-- Cumulative profit line chart -->
  <div class="card">
    <h2><span class="ic">&#128200;</span> Profit cumul&eacute; sur 36 mois</h2>
    <div class="chart-box"><canvas id="cProfitCumul"></canvas></div>
  </div>
</div>

<!-- ====== OPTIMIZE ====== -->
<div class="section" id="optimize">
  <!-- Dynamic verdict -->
  <div class="verdict green" id="optVerdict">
    <div class="ic">&#128161;</div>
    <div id="optVerdictText"><strong>Deux leviers puissants</strong> qui r&eacute;duisent le besoin en fonds de roulement et s&eacute;curisent le d&eacute;marrage.</div>
  </div>

  <!-- Inline controls -->
  <div class="opt-controls">
    <div class="opt-ctrl">
      <label>Factoring</label>
      <div class="toggle"><div class="toggle-sw on" id="optFact" onclick="this.classList.toggle('on');updateOptimize()"></div></div>
    </div>
    <div class="opt-ctrl">
      <label>Cash OI/ONU</label>
      <input type="range" id="optCash" min="0" max="30" step="1" value="15" oninput="updateOptimize()">
      <span id="optCashVal">15%</span>
    </div>
    <div class="opt-ctrl">
      <label>D&eacute;lai LAMal</label>
      <select id="optDelay" onchange="updateOptimize()">
        <option value="0">Sans d&eacute;lai</option>
        <option value="1" selected>1 mois</option>
        <option value="3">3 mois</option>
      </select>
    </div>
  </div>

  <!-- 4 KPI cards -->
  <div class="kpi-grid">
    <div class="kpi red"><div class="lb">BFR pire cas (3m, 0% cash)</div><div class="vl" id="optBfrWorst">&mdash;</div><div class="sb">Sans aucune optimisation</div></div>
    <div class="kpi green"><div class="lb">BFR config actuelle</div><div class="vl" id="optBfrCurrent">&mdash;</div><div class="sb" id="optBfrCurrentSub">Avec vos param&egrave;tres</div></div>
    <div class="kpi blue"><div class="lb">&Eacute;conomie BFR</div><div class="vl" id="optBfrSaved">&mdash;</div><div class="sb" id="optBfrSavedPct">R&eacute;duction du besoin</div></div>
    <div class="kpi"><div class="lb">Co&ucirc;t factoring / an</div><div class="vl" id="optFactCost">&mdash;</div><div class="sb" id="optFactCostPct">% du r&eacute;sultat net</div></div>
  </div>

  <!-- Dynamic recommendation -->
  <div class="opt-reco positive" id="optReco">
    <span class="reco-icon">&#128161;</span>
    <div id="optRecoText"></div>
  </div>

  <!-- 4-scenario comparison grid -->
  <div class="opt-compare-grid" id="optCompareGrid"></div>

  <!-- Chart -->
  <div class="card">
    <h2><span class="ic">&#128200;</span> Impact sur la tr&eacute;sorerie (36 mois)</h2>
    <div class="chart-box"><canvas id="cOptimize"></canvas></div>
  </div>
</div>

<!-- ====== ADMIN ====== -->
<div class="section" id="admin">
  <div class="card">
    <h2><span class="ic">&#128274;</span> Gestion des utilisateurs autoris&eacute;s</h2>
    <div class="exp">Ajoutez ou supprimez des adresses email autoris&eacute;es &agrave; acc&eacute;der &agrave; l'application.</div>
    <ul class="admin-emails" id="adminEmailList"></ul>
    <div class="admin-add">
      <input type="email" id="adminNewEmail" placeholder="nouvel.email@example.com">
      <button class="btn primary" onclick="addAllowedEmail()">Ajouter</button>
    </div>
  </div>
</div>

</div><!-- /content -->
</div><!-- /main-area -->

<script>
// ===== API HELPER =====
const API_BASE = '/api';
async function api(path, opts = {}) {
  const res = await fetch(API_BASE + path, {
    credentials: 'include',
    headers: { 'Content-Type': 'application/json', ...opts.headers },
    ...opts,
  });
  const data = await res.json().catch(() => ({}));
  if (!res.ok) throw { status: res.status, ...data };
  return data;
}

// ===== GLOBALS =====
const CASH_SHARE_BASE = 0.15, FACT_COST = 0.015;
let charts = {};
let D = null;
let SIM = null;
let teamActiveYear='all';
let cfActiveYear='all';
let revActiveYear='all';
let currentUser = null;
let currentPlanId = null;
let allPlans = [];
let OVERLAY = null;
let overlayScenarioId = null;
let simActiveYear = 'all';

// ===== NAV =====
const pageTitles = {overview:"Vue d'ensemble",simulator:"Simulateur",revenue:"Revenus",cashflow:"Tr\u00e9sorerie",team:"\u00c9quipe",risks:"Risques",profit:"Profit associ\u00e9s",optimize:"Optimisations",admin:"Administration"};
function nav(id, btn) {
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.sidebar nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('pageTitle').textContent = pageTitles[id]||id;
  if (id === 'admin') loadAdminData();
}

// ===== FORMAT =====
function fmt(n){if(n==null||isNaN(n))return'\u2014';const a=Math.abs(n);if(a>=1e6)return(n/1e6).toFixed(1)+'M';if(a>=1e3)return Math.round(n/1e3)+'k';return Math.round(n).toString()}
function fmtCHF(n){return'CHF '+fmt(n)}
function fmtN(n){if(n==null||isNaN(n))return'\u2014';return n.toLocaleString('fr-CH',{maximumFractionDigits:0})}
function pct(a,b){return b?Math.round((a/b-1)*100)+'%':'\u2014'}

// ===== SIDEBAR TOGGLE =====
function toggleSidebar(){
  const sb=document.getElementById('sidebar');
  sb.classList.toggle('collapsed');
  document.getElementById('toggleBtn').innerHTML=sb.classList.contains('collapsed')?'&#9654;':'&#9664;';
}

// ===== DROPZONE =====
const dz=document.getElementById('dropzone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('over')});
dz.addEventListener('dragleave',()=>dz.classList.remove('over'));
dz.addEventListener('drop',e=>{e.preventDefault();dz.classList.remove('over');if(e.dataTransfer.files.length)handleFile(e.dataTransfer.files[0])});

// ===== EXCEL IMPORT (via API) =====
async function handleFile(file){
  if(!file)return;
  try {
    // Deep copy current data for diff
    const oldData = D ? JSON.parse(JSON.stringify(D)) : null;

    const buffer = await file.arrayBuffer();
    const base64 = btoa(String.fromCharCode(...new Uint8Array(buffer)));
    const result = await api('/import/excel', {
      method: 'POST',
      body: JSON.stringify({ file: base64, filename: file.name }),
    });
    D = result.data;
    computeDerived();
    updateUI();
    // Save imported data to current plan
    if (currentPlanId) {
      await api('/plans/' + currentPlanId, {
        method: 'PUT',
        body: JSON.stringify({
          data: {
            ca:D.ca, caAssoc:D.caAssoc, caIndep:D.caIndep, caInterne:D.caInterne, caSage:D.caSage,
            result:D.result, cashflow:D.cashflow, treso1m:D.treso1m, treso3m:D.treso3m,
            admin:D.admin, opex:D.opex, lab:D.lab,
            fteAssoc:D.fteAssoc, fteIndep:D.fteIndep, fteInterne:D.fteInterne, fteAdmin:D.fteAdmin, fteTotal:D.fteTotal,
          },
          consultDay: D.consultDay, fee: D.fee, daysYear: D.daysYear,
          revSpec: D.revSpec, capex: D.capex,
          versionLabel: 'Import Excel: ' + file.name,
        }),
      });
    }
    dz.classList.add('loaded');
    document.getElementById('dzText').textContent='\u2713 '+file.name+' \u2014 donn\u00e9es synchronis\u00e9es';
    document.getElementById('statusLabel').textContent='Donn\u00e9es en direct \u00b7 '+file.name;
    document.getElementById('statusPill').className='status-pill live';
    document.getElementById('statusDot').className='status-dot live';

    // Show import diff summary
    buildImportDiff(oldData, D, result.warnings || []);
  } catch(err) {
    console.error('Import error:', err);
    const msg = err.error || err.message || 'Erreur inconnue';
    document.getElementById('dzText').textContent='\u2717 Erreur: ' + msg;
    document.getElementById('importSummary').classList.remove('show');
  }
}

// ===== IMPORT DIFF =====
function buildImportDiff(oldData, newData, warnings) {
  const container = document.getElementById('importSummary');
  const content = document.getElementById('importDiffContent');

  const sumArr = (arr, start, end) => arr.slice(start, end).reduce((a,b) => a+b, 0);
  const metrics = [
    { label: 'CA Ann\u00e9e 1', fn: d => sumArr(d.ca, 0, 12) },
    { label: 'CA Ann\u00e9e 2', fn: d => sumArr(d.ca, 12, 24) },
    { label: 'CA Ann\u00e9e 3', fn: d => sumArr(d.ca, 24, 36) },
    { label: 'R\u00e9sultat Ann\u00e9e 1', fn: d => sumArr(d.result, 0, 12) },
    { label: 'R\u00e9sultat Ann\u00e9e 2', fn: d => sumArr(d.result, 12, 24) },
    { label: 'R\u00e9sultat Ann\u00e9e 3', fn: d => sumArr(d.result, 24, 36) },
    { label: 'CAPEX', fn: d => d.capex },
    { label: 'Honoraires / consult.', fn: d => d.fee },
    { label: 'Consult. / jour', fn: d => d.consultDay },
    { label: 'ETP max', fn: d => Math.max(...d.fteTotal) },
  ];

  let diffs = [];
  if (oldData) {
    for (const m of metrics) {
      const ov = m.fn(oldData);
      const nv = m.fn(newData);
      if (ov !== nv) diffs.push({ label: m.label, old: ov, new: nv });
    }
  }

  let html = '';
  if (!oldData) {
    html = '<div class="no-change">Premi\u00e8re importation — donn\u00e9es charg\u00e9es.</div>';
  } else if (diffs.length === 0) {
    html = '<div class="no-change">Aucun changement d\u00e9tect\u00e9 par rapport aux donn\u00e9es pr\u00e9c\u00e9dentes.</div>';
  } else {
    html = '<div class="diff-grid">';
    for (const d of diffs) {
      const pct = d.old !== 0 ? ((d.new - d.old) / Math.abs(d.old) * 100) : 0;
      const pctClass = pct > 0 ? 'up' : pct < 0 ? 'down' : '';
      const pctStr = pct !== 0 ? '<span class="diff-pct ' + pctClass + '">' + (pct > 0 ? '+' : '') + pct.toFixed(1) + '%</span>' : '';
      html += '<div class="diff-item"><span class="diff-label">' + d.label + '</span>'
        + '<span class="diff-values"><span class="diff-old">' + fmt(d.old) + '</span>'
        + '<span class="diff-arrow">\u2192</span>'
        + '<span class="diff-new">' + fmt(d.new) + '</span>'
        + pctStr + '</span></div>';
    }
    html += '</div>';
  }

  // Show warnings from parser
  if (warnings && warnings.length > 0) {
    html += '<ul class="import-warnings">';
    for (const w of warnings) html += '<li>' + w + '</li>';
    html += '</ul>';
  }

  content.innerHTML = html;
  container.classList.add('show');
}

// ===== VERSION PANEL =====
function openVersionPanel() {
  document.getElementById('versionPanel').classList.add('open');
  document.getElementById('versionOverlay').classList.add('show');
  loadVersions();
}

function closeVersionPanel() {
  document.getElementById('versionPanel').classList.remove('open');
  document.getElementById('versionOverlay').classList.remove('show');
}

async function loadVersions() {
  const list = document.getElementById('versionList');
  if (!currentPlanId) {
    list.innerHTML = '<div class="vp-empty">Aucun plan actif. Importez d\'abord des donn\u00e9es.</div>';
    return;
  }
  try {
    const result = await api('/plans/' + currentPlanId + '/versions');
    const versions = result.versions || [];
    if (versions.length === 0) {
      list.innerHTML = '<div class="vp-empty">Aucune version enregistr\u00e9e pour ce plan.</div>';
      return;
    }
    list.innerHTML = versions.map(function(v) {
      const d = new Date(v.createdAt);
      const dateStr = d.toLocaleDateString('fr-CH', { day: '2-digit', month: 'short', year: 'numeric' })
        + ' \u00e0 ' + d.toLocaleTimeString('fr-CH', { hour: '2-digit', minute: '2-digit' });
      return '<div class="version-item">'
        + '<div class="vi-top"><span class="vi-num">v' + v.versionNumber + '</span><span class="vi-date">' + dateStr + '</span></div>'
        + '<div class="vi-label">' + (v.label || 'Version ' + v.versionNumber) + '</div>'
        + '<button class="vi-restore" onclick="restoreVersion(\'' + v.id + '\')">Restaurer cette version</button>'
        + '</div>';
    }).join('');
  } catch(err) {
    list.innerHTML = '<div class="vp-empty">Erreur: ' + (err.error || err.message || 'Impossible de charger les versions') + '</div>';
  }
}

async function restoreVersion(versionId) {
  if (!currentPlanId) return;
  try {
    // Fetch full version data
    const result = await api('/plans/' + currentPlanId + '/versions/' + versionId);
    const vData = result.version;
    if (!vData || !vData.data) throw new Error('Donn\u00e9es de version incompl\u00e8tes');

    const oldData = D ? JSON.parse(JSON.stringify(D)) : null;

    // Save restored version to plan (creates auto-snapshot of current state)
    const restored = vData.data;
    const constants = vData.constants || {};
    await api('/plans/' + currentPlanId, {
      method: 'PUT',
      body: JSON.stringify({
        data: restored,
        consultDay: constants.consultDay, fee: constants.fee, daysYear: constants.daysYear,
        revSpec: constants.revSpec, capex: constants.capex,
        versionLabel: 'Restauration v' + (vData.versionNumber || '?'),
      }),
    });

    // Update local state
    D = restored;
    D.consultDay = constants.consultDay || D.consultDay;
    D.fee = constants.fee || D.fee;
    D.daysYear = constants.daysYear || D.daysYear;
    D.revSpec = constants.revSpec || D.revSpec;
    D.capex = constants.capex || D.capex;
    computeDerived();
    updateUI();

    buildImportDiff(oldData, D, []);
    document.getElementById('statusLabel').textContent = 'Restaur\u00e9 \u00b7 v' + (vData.versionNumber || '?');
    document.getElementById('statusPill').className = 'status-pill live';
    document.getElementById('statusDot').className = 'status-dot live';

    closeVersionPanel();
  } catch(err) {
    console.error('Restore error:', err);
    alert('Erreur lors de la restauration: ' + (err.error || err.message || 'Erreur inconnue'));
  }
}

function computeDerived(){
  D.caY1=D.ca.slice(0,12).reduce((a,b)=>a+b,0);D.caY2=D.ca.slice(12,24).reduce((a,b)=>a+b,0);D.caY3=D.ca.slice(24,36).reduce((a,b)=>a+b,0);
  D.resY1=D.result.slice(0,12).reduce((a,b)=>a+b,0);D.resY2=D.result.slice(12,24).reduce((a,b)=>a+b,0);D.resY3=D.result.slice(24,36).reduce((a,b)=>a+b,0);
  const scenarios = computeScenarios(D.ca, D.admin, D.opex, D.lab, CASH_SHARE_BASE);
  D.tresoFact=scenarios.fact; D.tresoCash3m=scenarios.cash3m; D.tresoCash1m=scenarios.cash1m;
  D.bfrWorst=Math.min(...D.treso3m); D.bfrFact=Math.min(...D.tresoFact);
  D.bfrCash3m=Math.min(...D.tresoCash3m); D.bfrCash1m=Math.min(...D.tresoCash1m);
}

function computeScenarios(ca,admin,opex,lab,cashShare){
  let fact=[],cash3m=[],cash1m=[];
  let c1=0,c2=0,c3=0;
  for(let m=0;m<36;m++){
    c1+=ca[m]*cashShare+ca[m]*(1-cashShare)*(1-FACT_COST)+admin[m]+opex[m]+lab[m]; fact.push(c1);
    c2+=ca[m]*cashShare+(m>=3?ca[m-3]*(1-cashShare):0)+admin[m]+opex[m]+lab[m]; cash3m.push(c2);
    c3+=ca[m]*cashShare+(m>=1?ca[m-1]*(1-cashShare):0)+admin[m]+opex[m]+lab[m]; cash1m.push(c3);
  }
  return {fact,cash3m,cash1m};
}

// ===== UPDATE UI =====
function updateUI(){
  if(!D)return;
  const el=id=>document.getElementById(id);
  if(el('rConsult'))el('rConsult').value=D.consultDay||16; if(el('rFee'))el('rFee').value=D.fee||225;
  const rr=getRetroRate();
  el('pillsAssumptions').innerHTML='<div class="pill"><b>'+D.consultDay+'</b> consult./jour</div><div class="pill"><b>CHF '+D.fee+'</b> /consultation</div><div class="pill"><b>'+D.daysYear+'</b> jours/an</div><div class="pill"><b>'+(100-rr)+'/'+rr+'</b> partage associ\u00e9s</div>';
  updateCharts();
}

// ===== REVENUE PROFILE FILTERS =====
let revActiveProfiles = new Set(['assoc','indep','interne','sage']);

const REV_PROFILES = {
  assoc: {key:'caAssoc',fte:'fteAssoc',color:'#0f2b46',label:'Associ\u00e9s',shareType:'retro',css:'assoc'},
  indep: {key:'caIndep',fte:'fteIndep',color:'#1a4a7a',label:'Ind\u00e9pendants',shareType:'retro',css:'indep'},
  interne:{key:'caInterne',fte:'fteInterne',color:'#5dade2',label:'Internes',shareType:'fixed',share:'100% pour GynEva',css:'interne'},
  sage:  {key:'caSage',fte:null,color:'#aed6f1',label:'Sage-femme',shareType:'fixed',share:'Contribution nette',css:'sage'},
};
function getRetroRate(){const s=document.getElementById('sRetro');return s?+s.value:40;}
function getRetroShare(pr){if(pr.shareType==='retro')return getRetroRate()+'% pour GynEva';return pr.share;}

const revYearPlugin={id:'revYL',beforeDraw(chart){
  if(revActiveYear==='all')return;
  const ctx=chart.ctx,x=chart.scales.x,y=chart.scales.y;
  const yi=parseInt(revActiveYear);
  const s=(yi-1)*12,e=yi*12-1;
  if(s>x.max||e<x.min)return;
  const xS=x.getPixelForValue(Math.max(s,x.min)),xE=x.getPixelForValue(Math.min(e,x.max));
  ctx.save();ctx.fillStyle='rgba(26,74,122,.04)';
  ctx.fillRect(xS,y.top,xE-xS,y.bottom-y.top);
  ctx.fillStyle='rgba(26,74,122,.5)';ctx.font='bold 11px Inter,sans-serif';
  ctx.fillText('Ann\u00e9e '+revActiveYear,xS+4,y.top+14);
  ctx.restore();
}};
function setRevYear(year,btn){
  revActiveYear=year;
  document.querySelectorAll('.rev-year-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  updateRevenue();
}
function updateRevenue(){
  if(!D)return;
  updateRevenueChart();
  updateRevDetail();
  updateRevVerdict();
}
function updateRevVerdict(){
  if(!D)return;
  const el=id=>document.getElementById(id);
  const vd=el('revVerdict'),vt=el('revVerdictText');
  if(!vd||!vt)return;
  const sum12=(arr,s)=>arr.slice(s,s+12).reduce((a,b)=>a+b,0);
  const year=revActiveYear;
  // Compute metrics for scoring
  const caY1=sum12(D.ca,0),caY2=sum12(D.ca,12),caY3=sum12(D.ca,24);
  const caTotal=caY1+caY2+caY3;
  // 1. Growth score (0-3): Y1->Y3 growth rate
  let growthPct=caY1>0?((caY3-caY1)/caY1*100):0;
  let growthScore=growthPct>=80?3:growthPct>=40?2:growthPct>=10?1:0;
  // 2. Diversification score (0-3): how many sources contribute >5%
  const profKeys=['caAssoc','caIndep','caInterne','caSage'];
  let activeSources=0;
  const s=year==='all'?0:(parseInt(year)-1)*12, e=year==='all'?36:parseInt(year)*12;
  const caPeriod=D.ca.slice(s,e).reduce((a,b)=>a+b,0)||1;
  profKeys.forEach(k=>{const pCA=D[k].slice(s,e).reduce((a,b)=>a+b,0);if(pCA/caPeriod>0.05)activeSources++;});
  let divScore=activeSources>=4?3:activeSources>=3?2:activeSources>=2?1:0;
  // 3. Ramp-up health (0-3): progression within period
  const periodCA=D.ca.slice(s,e);
  const firstHalf=periodCA.slice(0,Math.floor(periodCA.length/2)).reduce((a,b)=>a+b,0);
  const secondHalf=periodCA.slice(Math.floor(periodCA.length/2)).reduce((a,b)=>a+b,0);
  let rampScore=secondHalf>firstHalf*1.3?3:secondHalf>firstHalf*1.1?2:secondHalf>=firstHalf?1:0;
  if(year==='3'||year==='all')rampScore=Math.max(rampScore,periodCA[periodCA.length-1]>0?2:0);
  // 4. CA absolute (0-3)
  let absScore=caY3>=4000000?3:caY3>=2500000?2:caY3>=1000000?1:0;
  const score=growthScore+divScore+rampScore+absScore;
  // Verdict
  let cls,msg;
  if(year==='all'){
    if(score>=10){cls='green';msg='<strong>Chiffre d\'affaires excellent.</strong> Croissance solide (+'+Math.round(growthPct)+'%), '+activeSources+' sources diversifi\u00e9es, mont\u00e9e en puissance progressive.';}
    else if(score>=6){cls='orange';msg='<strong>Croissance mod\u00e9r\u00e9e.</strong> '+activeSources+' sources actives, croissance de '+Math.round(growthPct)+'%. Potentiel d\'am\u00e9lioration sur la diversification.';}
    else{cls='red';msg='<strong>Revenus insuffisants.</strong> Croissance limit\u00e9e ('+Math.round(growthPct)+'%), seulement '+activeSources+' source(s) significative(s).';}
  } else {
    const yLabel=year==='1'?'D\u00e9marrage (Y1)':year==='2'?'Croissance (Y2)':'Croisi\u00e8re (Y3)';
    const yCa=fmt(caPeriod);
    if(score>=10){cls='green';msg='<strong>'+yLabel+' \u2014 CA '+yCa+'.</strong> '+activeSources+' sources actives, dynamique positive.';}
    else if(score>=6){cls='orange';msg='<strong>'+yLabel+' \u2014 CA '+yCa+'.</strong> Mont\u00e9e en charge progressive, '+activeSources+' source(s).';}
    else{cls='red';msg='<strong>'+yLabel+' \u2014 CA '+yCa+'.</strong> Revenus limit\u00e9s, diversification faible.';}
  }
  vd.className='verdict '+cls;
  vt.innerHTML=msg;
}

function toggleRevProfile(prof, btn){
  if(prof==='all'){
    revActiveProfiles=new Set(['assoc','indep','interne','sage']);
    document.querySelectorAll('.rev-prof').forEach(b=>b.classList.add('active'));
  } else {
    if(revActiveProfiles.has(prof)) revActiveProfiles.delete(prof); else revActiveProfiles.add(prof);
    btn.classList.toggle('active');
    if(revActiveProfiles.size===0){
      revActiveProfiles=new Set(['assoc','indep','interne','sage']);
      document.querySelectorAll('.rev-prof').forEach(b=>b.classList.add('active'));
    }
    const allBtn=document.querySelector('.rev-prof[data-prof="all"]');
    if(allBtn){if(revActiveProfiles.size===4) allBtn.classList.add('active'); else allBtn.classList.remove('active');}
  }
  updateRevenue();
}

function updateRevenueChart(){
  if(!D)return;
  if(charts.revenue){try{charts.revenue.destroy()}catch(e){}}
  const revDs=[];
  const profOrder=['assoc','indep','interne','sage'];
  const ry=revActiveYear;
  profOrder.forEach(p=>{
    if(revActiveProfiles.has(p)){
      const pr=REV_PROFILES[p];
      let bgArr;
      if(ry==='all'){bgArr=pr.color;}
      else{const yi=parseInt(ry);bgArr=D[pr.key].map((_,i)=>{const inYear=Math.floor(i/12)+1===yi;return inYear?pr.color:pr.color+'40';});}
      revDs.push({label:pr.label,data:D[pr.key],backgroundColor:bgArr,borderRadius:1});
    }
  });
  if(OVERLAY){revDs.push({type:'line',label:'CA sc\u00e9nario',data:OVERLAY.ca,borderColor:'#d63031',borderWidth:2.5,borderDash:[6,3],pointRadius:0,tension:.3,fill:false,stack:false});}
  const single=revActiveProfiles.size===1;
  charts.revenue=new Chart(document.getElementById('cRevenue'),{
    type:'bar',
    data:{labels:labelsQ,datasets:revDs},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},
      scales:{x:{stacked:!single,grid:{display:false}},y:{stacked:!single,grid:gridOpts,ticks:{callback:v=>fmt(v)}}}
    },
    plugins:[yearPlugin,revYearPlugin]
  });
}

function updateRevDetail(){
  if(!D)return;
  const el=document.getElementById('revDetailGrid');
  if(!el)return;
  const elId=id=>document.getElementById(id);
  const sumR=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
  const sum12=(arr,s)=>sumR(arr,s,s+12);
  const profOrder=['assoc','indep','interne','sage'];
  const ry=revActiveYear;
  // Period bounds
  const ps=ry==='all'?0:(parseInt(ry)-1)*12, pe=ry==='all'?36:parseInt(ry)*12;
  let html='';
  profOrder.forEach(p=>{
    if(!revActiveProfiles.has(p))return;
    const pr=REV_PROFILES[p];
    const arr=D[pr.key];
    // Ramp-up info
    let ramp='';
    if(pr.fte&&D[pr.fte]){
      const fteArr=D[pr.fte];
      let startM=0,maxM=0,maxV=Math.max(...fteArr);
      for(let i=0;i<36;i++){if(fteArr[i]>0){startM=i+1;break;}}
      for(let i=0;i<36;i++){if(fteArr[i]>=maxV&&maxV>0){maxM=i+1;break;}}
      if(startM>0) ramp='D\u00e9but mois '+startM+(maxM>startM?' \u2192 capacit\u00e9 max mois '+maxM:'');
    } else {
      let startM=0,stableM=0;
      for(let i=0;i<36;i++){if(arr[i]>0){startM=i+1;break;}}
      const maxV=Math.max(...arr);
      for(let i=0;i<36;i++){if(arr[i]>=maxV&&maxV>0){stableM=i+1;break;}}
      if(startM>0) ramp='D\u00e9but mois '+startM+(stableM>startM?' \u2192 stable mois '+stableM:'');
    }
    html+='<div class="rev-prof-card '+pr.css+'">';
    html+='<h4>'+pr.label+'</h4>';
    html+='<div class="prof-kpis">';
    if(ry==='all'){
      const y1=sum12(arr,0),y2=sum12(arr,12),y3=sum12(arr,24);
      const totY1=D.caY1||1,totY2=D.caY2||1,totY3=D.caY3||1;
      html+='<div class="prof-kpi"><span class="pk-label">CA Ann\u00e9e 1</span><span class="pk-value">'+fmt(y1)+' ('+Math.round(y1/totY1*100)+'%)</span></div>';
      html+='<div class="prof-kpi"><span class="pk-label">CA Ann\u00e9e 2</span><span class="pk-value">'+fmt(y2)+' ('+Math.round(y2/totY2*100)+'%)</span></div>';
      html+='<div class="prof-kpi"><span class="pk-label">CA Ann\u00e9e 3</span><span class="pk-value">'+fmt(y3)+' ('+Math.round(y3/totY3*100)+'%)</span></div>';
    } else {
      const yi=parseInt(ry),base=(yi-1)*12;
      const yearCA=sum12(arr,base);
      const totYear=sum12(D.ca,base)||1;
      html+='<div class="prof-kpi"><span class="pk-label">CA Ann\u00e9e '+yi+'</span><span class="pk-value">'+fmt(yearCA)+' ('+Math.round(yearCA/totYear*100)+'%)</span></div>';
      for(let q=0;q<4;q++){
        const qStart=base+q*3,qEnd=qStart+3;
        const qCA=sumR(arr,qStart,qEnd);
        html+='<div class="prof-kpi"><span class="pk-label">T'+(q+1)+'</span><span class="pk-value">'+fmt(qCA)+'</span></div>';
      }
      const avgMonth=yearCA/12;
      html+='<div class="prof-kpi"><span class="pk-label">Moyenne/mois</span><span class="pk-value">'+fmt(avgMonth)+'</span></div>';
    }
    html+='<div class="prof-kpi"><span class="pk-label">Part GynEva</span><span class="pk-value">'+getRetroShare(pr)+'</span></div>';
    html+='</div>';
    if(ramp) html+='<div class="prof-ramp">\u2191 '+ramp+'</div>';
    html+='</div>';
  });
  el.innerHTML=html;
  // Update KPIs — new IDs, year+profile aware
  let filtCA=0, filtCAPrev=0, filtCATotal=0;
  const profKeys=['caAssoc','caIndep','caInterne','caSage'];
  revActiveProfiles.forEach(p=>{
    const arr=D[REV_PROFILES[p].key];
    filtCA+=sumR(arr,ps,pe);
    filtCATotal+=sumR(arr,0,36);
    if(ry!=='all'&&ry!=='1'){
      const prevS=ps-12,prevE=pe-12;
      filtCAPrev+=sumR(arr,prevS,prevE);
    }
  });
  // KPI 1: Potentiel / specialiste
  elId('revKpiSpec').textContent=fmt(D.revSpec);
  // KPI 2: CA periode
  elId('revKpiCa').textContent=fmt(filtCA);
  const periodLabel=ry==='all'?'3 ans cumul\u00e9s':'Ann\u00e9e '+ry;
  elId('revKpiCaSub').textContent=periodLabel+(revActiveProfiles.size<4?' (filtr\u00e9)':'');
  // KPI 3: Croissance
  if(ry==='all'){
    const caY1f=revActiveProfiles.size===4?D.caY1:0;
    const caY3f=revActiveProfiles.size===4?D.caY3:0;
    let fY1=0,fY3=0;
    if(revActiveProfiles.size<4){revActiveProfiles.forEach(p=>{const a=D[REV_PROFILES[p].key];fY1+=sum12(a,0);fY3+=sum12(a,24);});}
    else{fY1=D.caY1;fY3=D.caY3;}
    const gPct=fY1>0?((fY3-fY1)/fY1*100):0;
    elId('revKpiGrowth').textContent=(gPct>=0?'+':'')+Math.round(gPct)+'%';
    elId('revKpiGrowth').style.color=gPct>=40?'var(--acc)':gPct>=10?'#e17055':'var(--danger)';
    elId('revKpiGrowthSub').textContent='Y1 \u2192 Y3';
  } else if(ry==='1'){
    elId('revKpiGrowth').textContent='\u2014';
    elId('revKpiGrowth').style.color='var(--txtL)';
    elId('revKpiGrowthSub').textContent='Premi\u00e8re ann\u00e9e';
  } else {
    const gPct=filtCAPrev>0?((filtCA-filtCAPrev)/filtCAPrev*100):0;
    elId('revKpiGrowth').textContent=(gPct>=0?'+':'')+Math.round(gPct)+'%';
    elId('revKpiGrowth').style.color=gPct>=20?'var(--acc)':gPct>=0?'#e17055':'var(--danger)';
    elId('revKpiGrowthSub').textContent='vs Y'+(parseInt(ry)-1);
  }
  // KPI 4: Diversification
  let activeCount=0;
  const caPeriodTotal=sumR(D.ca,ps,pe)||1;
  profKeys.forEach(k=>{const pCA=sumR(D[k],ps,pe);if(pCA/caPeriodTotal>0.05)activeCount++;});
  elId('revKpiDiversif').textContent=activeCount+'/4';
  elId('revKpiDiversif').style.color=activeCount>=4?'var(--acc)':activeCount>=3?'#e17055':'var(--danger)';
  elId('revKpiDiversifSub').textContent=activeCount>=4?'Toutes sources actives':activeCount+' source(s) >5%';
  // Retrocession model update
  const r=getRetroRate();
  const rDoc=document.getElementById('revRetroDoc'); if(rDoc) rDoc.textContent=100-r;
  const rGyn=document.getElementById('revRetroGyneva'); if(rGyn) rGyn.textContent=r;
  const rDoc2=document.getElementById('revRetroDoc2'); if(rDoc2) rDoc2.textContent=100-r;
  const rGyn2=document.getElementById('revRetroGyneva2'); if(rGyn2) rGyn2.textContent=r;
}

// ===== OPTIMIZE TAB =====
function computeOptScenario(ca,admin,opex,lab,cashPct,delay,factoring){
  const arr=[];let cum=0;
  for(let m=0;m<36;m++){
    let cashIn=ca[m]*cashPct;
    if(factoring){cashIn+=ca[m]*(1-cashPct)*(1-FACT_COST);}
    else if(m>=delay){cashIn+=ca[m-delay]*(1-cashPct);}
    cum+=cashIn+admin[m]+opex[m]+lab[m];
    arr.push(cum);
  }
  return arr;
}

function updateOptimize(){
  if(!D)return;
  const el=id=>document.getElementById(id);
  // Read controls
  const factOn=el('optFact')&&el('optFact').classList.contains('on');
  const cashPct=(el('optCash')?+el('optCash').value:15)/100;
  const delay=el('optDelay')?+el('optDelay').value:1;
  if(el('optCashVal')) el('optCashVal').textContent=Math.round(cashPct*100)+'%';

  // Compute 4 scenarios
  const ca=D.ca,admin=D.admin,opex=D.opex,lab=D.lab;
  const worst=computeOptScenario(ca,admin,opex,lab,0,3,false);
  const cashOnly=computeOptScenario(ca,admin,opex,lab,cashPct,3,false);
  const cash1m=computeOptScenario(ca,admin,opex,lab,cashPct,1,false);
  const current=factOn
    ?computeOptScenario(ca,admin,opex,lab,cashPct,0,true)
    :computeOptScenario(ca,admin,opex,lab,cashPct,delay,false);

  const bfrWorst=Math.min(...worst);
  const bfrCurrent=Math.min(...current);
  const bfrCashOnly=Math.min(...cashOnly);
  const bfrCash1m=Math.min(...cash1m);
  const bfrFact=Math.min(...computeOptScenario(ca,admin,opex,lab,cashPct,0,true));
  const saved=Math.abs(bfrWorst)-Math.abs(bfrCurrent);
  const caY3=D.ca.slice(24,36).reduce((a,b)=>a+b,0);
  const resY3=D.result.slice(24,36).reduce((a,b)=>a+b,0);
  const factCostAnnual=factOn?caY3*(1-cashPct)*FACT_COST:0;

  // KPIs
  el('optBfrWorst').textContent=fmt(bfrWorst);
  el('optBfrCurrent').textContent=fmt(bfrCurrent);
  el('optBfrCurrent').parentElement.className='kpi '+(bfrCurrent<-150000?'red':bfrCurrent<-50000?'orange':'green');
  el('optBfrCurrentSub').textContent=factOn?'Factoring + '+Math.round(cashPct*100)+'% cash':Math.round(cashPct*100)+'% cash + d\u00e9lai '+delay+'m';
  el('optBfrSaved').textContent=(saved>=0?'+':'')+fmt(saved);
  el('optBfrSavedPct').textContent=bfrWorst!==0?'R\u00e9duction de '+Math.round(saved/Math.abs(bfrWorst)*100)+'%':'';
  el('optFactCost').textContent=factOn?'~'+fmt(factCostAnnual)+'/an':'\u2014';
  el('optFactCostPct').textContent=factOn&&resY3>0?'~'+Math.round(factCostAnnual/resY3*100)+'% du r\u00e9sultat net':'Factoring d\u00e9sactiv\u00e9';

  // Verdict
  const vd=el('optVerdict'),vt=el('optVerdictText');
  if(factOn&&cashPct>=0.1){
    vd.className='verdict green';
    vt.innerHTML='<strong>Configuration optimale.</strong> Le factoring combin\u00e9 \u00e0 '+Math.round(cashPct*100)+'% de cash OI/ONU r\u00e9duit le BFR de <strong>'+fmt(Math.abs(saved))+'</strong>.';
  } else if(factOn){
    vd.className='verdict green';
    vt.innerHTML='<strong>Factoring actif.</strong> M\u00eame sans cash OI/ONU significatif, le factoring s\u00e9curise la tr\u00e9sorerie.';
  } else if(cashPct>=0.1){
    vd.className='verdict orange';
    vt.innerHTML='<strong>Cash OI/ONU seul.</strong> Le '+Math.round(cashPct*100)+'% de cash aide, mais le factoring reste <strong>recommand\u00e9</strong> pour s\u00e9curiser le d\u00e9marrage.';
  } else {
    vd.className='verdict '+(delay>=3?'red':'orange');
    vt.innerHTML='<strong>Risque de tr\u00e9sorerie '+(delay>=3?'\u00e9lev\u00e9':'mod\u00e9r\u00e9')+'.</strong> Sans factoring ni cash significatif, le BFR atteint <strong>'+fmt(bfrCurrent)+'</strong>. Activez le factoring.';
  }

  // Recommendation
  const recoEl=el('optReco'),recoTxt=el('optRecoText');
  if(factOn){
    const roi=factCostAnnual>0?Math.round(saved/factCostAnnual*10)/10:0;
    recoEl.className='opt-reco positive';
    recoTxt.innerHTML='Le factoring co\u00fbte <strong>~'+fmt(factCostAnnual)+' CHF/an</strong> mais r\u00e9duit votre BFR de <strong>'+fmt(Math.abs(saved))+' CHF</strong>.'+(roi>0?' ROI\u00a0: <strong>'+roi+'x</strong>.':'');
  } else {
    recoEl.className='opt-reco warning';
    recoTxt.innerHTML='Sans factoring, votre BFR atteint <strong>'+fmt(bfrCurrent)+'</strong>. Activez le factoring pour le r\u00e9duire \u00e0 <strong>'+fmt(bfrFact)+'</strong>.';
  }

  // Comparison grid — 4 scenarios
  const scenarios=[
    {title:'100% LAMal 3m',sub:'Pire cas',data:worst,bfr:bfrWorst,delay:3,cash:0,fact:false},
    {title:'Cash '+Math.round(cashPct*100)+'% + LAMal 3m',sub:'Cash seul',data:cashOnly,bfr:bfrCashOnly,delay:3,cash:cashPct,fact:false},
    {title:'Cash '+Math.round(cashPct*100)+'% + LAMal 1m',sub:'D\u00e9lai r\u00e9duit',data:cash1m,bfr:bfrCash1m,delay:1,cash:cashPct,fact:false},
    {title:'Cash '+Math.round(cashPct*100)+'% + Factoring',sub:'Factoring actif',data:computeOptScenario(ca,admin,opex,lab,cashPct,0,true),bfr:bfrFact,delay:0,cash:cashPct,fact:true},
  ];
  const bfrAll=scenarios.map(s=>s.bfr);
  const bestBfr=Math.max(...bfrAll),worstBfr=Math.min(...bfrAll);
  // Detect which scenario matches current config
  const matchIdx=factOn?3:(delay===3?(cashPct>0?1:0):(delay===1?2:-1));
  let gridHtml='';
  scenarios.forEach((sc,i)=>{
    const isBest=sc.bfr===bestBfr,isWorst=sc.bfr===worstBfr,isActive=i===matchIdx;
    let cls='opt-scenario'+(isActive?' active':'')+(isWorst?' worst':'')+(isBest?' best':'');
    const critM=sc.data.indexOf(sc.bfr)+1;
    let tag='';
    if(sc.bfr<-150000) tag='<span class="sc-tag red">Risque \u00e9lev\u00e9</span>';
    else if(sc.bfr<-50000) tag='<span class="sc-tag orange">Mod\u00e9r\u00e9</span>';
    else tag='<span class="sc-tag green">S\u00e9curis\u00e9</span>';
    gridHtml+='<div class="'+cls+'">';
    gridHtml+='<h4>'+sc.title+'</h4>';
    gridHtml+='<div class="sc-val '+(sc.bfr<0?'neg':'pos')+'">'+fmt(sc.bfr)+'</div>';
    gridHtml+='<div class="sc-detail">BFR min &mdash; mois '+critM+'</div>';
    gridHtml+=tag;
    if(isActive) gridHtml+='<div class="sc-detail" style="margin-top:.3rem;font-weight:600;color:var(--p)">Config actuelle</div>';
    gridHtml+='</div>';
  });
  el('optCompareGrid').innerHTML=gridHtml;

  // Chart — rebuild with emphasis on current config line
  if(charts.optimize){try{charts.optimize.destroy()}catch(e){}}
  const colors=['#d63031','#e17055','#fdcb6e','#00b894'];
  const ds=scenarios.map((sc,i)=>({
    label:sc.title,data:sc.data,
    borderColor:colors[i],tension:.3,pointRadius:0,
    borderWidth:i===matchIdx?3.5:1.5,
    borderDash:i===matchIdx?[]:[5,4],
    backgroundColor:i===matchIdx?colors[i]+'18':'transparent',
    fill:i===matchIdx
  }));
  charts.optimize=new Chart(document.getElementById('cOptimize'),{type:'line',data:{labels:labelsQ,datasets:ds},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}},plugins:[yearPlugin]});
}

// ===== RISKS TAB =====
const RISK_MATRIX=[
  {id:'r1',name:'Retard autorisation cantonale',prob:3,impact:4,mitigation:'Anticiper d\u00e9p\u00f4t 6 mois avant'},
  {id:'r2',name:'D\u00e9lais paiement LAMal > 3 mois',prob:3,impact:4,mitigation:'Factoring Caisse des M\u00e9decins'},
  {id:'r3',name:'Sous-occupation prolong\u00e9e Y1',prob:3,impact:3,mitigation:'Plan marketing, r\u00e9seau r\u00e9f\u00e9rents'},
  {id:'r4',name:'D\u00e9part m\u00e9decin ind\u00e9pendant',prob:3,impact:4,mitigation:'Clause non-concurrence, conditions attractives'},
  {id:'r5',name:'\u00c9volution tarifaire TARMED/TARDOC',prob:3,impact:4,mitigation:'Diversification anti-\u00e2ge, actes priv\u00e9s'},
  {id:'r6',name:'Litige obst\u00e9trique (RC pro)',prob:1,impact:5,mitigation:'RC pro adapt\u00e9e, protocoles stricts'},
  {id:'r7',name:'Sous-estimation CAPEX',prob:3,impact:2,mitigation:'R\u00e9serve CHF 20k, leasing possible'},
];
const CHARGES_DATA=[
  {name:'RC professionnelle (obst\u00e9trique)',min:40000,max:80000,criticite:'critique'},
  {name:'Provision litiges',min:20000,max:50000,criticite:'critique'},
  {name:'Entretien \u00e9quipements',min:15000,max:25000,criticite:'important'},
  {name:'Logiciels / licences',min:10000,max:20000,criticite:'important'},
  {name:'D\u00e9chets m\u00e9dicaux',min:8000,max:15000,criticite:'important'},
  {name:'Formation continue',min:5000,max:10000,criticite:'moyen'},
  {name:'Cotisations FMH',min:5000,max:8000,criticite:'moyen'},
  {name:'Autorisations cantonales',min:3000,max:5000,criticite:'moyen'},
];
let riskSortField='score',riskSortAsc=false;

function cycleRiskValue(riskId,field){
  const r=RISK_MATRIX.find(x=>x.id===riskId);
  if(!r)return;
  r[field]=r[field]>=5?1:r[field]+1;
  updateRisks();
}
function sortRisksBy(field){
  if(riskSortField===field) riskSortAsc=!riskSortAsc; else {riskSortField=field;riskSortAsc=false;}
  updateRisks();
}

function updateRisks(){
  if(!D)return;
  const el=id=>document.getElementById(id);

  // 1. Read sliders
  const consult=+(el('rConsult')?el('rConsult').value:16);
  const fee=+(el('rFee')?el('rFee').value:225);
  const occup=+(el('rOccup')?el('rOccup').value:60);
  const start=+(el('rStart')?el('rStart').value:4);
  if(el('rConsultVal')) el('rConsultVal').textContent=consult;
  if(el('rFeeVal')) el('rFeeVal').textContent='CHF '+fee;
  if(el('rOccupVal')) el('rOccupVal').textContent=occup+'%';
  if(el('rStartVal')) el('rStartVal').textContent=start+' mois';

  // 2. Compute 3 scenarios
  const bp={consult:consult,fee:fee,days:BASE.days,assoc:BASE.assoc,indep:BASE.indep,interne:BASE.interne,start:start,occup:occup,cashPct:BASE.cashPct,delay:BASE.delay,factoring:BASE.factoring,extra:BASE.extra,rc:BASE.rc,retro:BASE.retro};
  const simBase=computeSimulation(bp);
  const simPess=computeSimulation({...bp,consult:Math.max(8,Math.round(consult*0.75)),fee:Math.round(fee*0.75),occup:Math.max(30,Math.round(occup*0.75)),start:Math.min(12,start+2)});
  const simOpt=computeSimulation({...bp,consult:Math.min(24,Math.round(consult*1.25)),fee:Math.min(350,Math.round(fee*1.25)),occup:Math.min(100,Math.round(occup*1.25)),start:Math.max(1,start-1)});

  // 3. KPIs
  el('rCaY3').textContent=fmt(simBase.caY3);
  el('rResY3').textContent=fmt(simBase.resY3);
  el('rBfrMin').textContent=fmt(simBase.bfrMin);
  el('rTresoFinal').textContent=fmt(simBase.tresoFinal);
  if(D.caY3) el('rCaY3Delta').textContent='vs plan: '+(simBase.caY3/D.caY3*100-100>=0?'+':'')+Math.round(simBase.caY3/D.caY3*100-100)+'%';
  if(D.resY3) el('rResY3Delta').textContent='vs plan: '+(simBase.resY3/D.resY3*100-100>=0?'+':'')+Math.round(simBase.resY3/D.resY3*100-100)+'%';
  el('rBfrMin').parentElement.className='kpi '+(simBase.bfrMin<-150000?'red':simBase.bfrMin<-50000?'orange':'green');
  el('rTresoFinal').parentElement.className='kpi '+(simBase.tresoFinal<0?'red':simBase.tresoFinal<500000?'orange':'green');

  // 4. Scenario grid
  const scenarios=[
    {label:'Pessimiste (-25%)',sim:simPess,css:'pessimiste'},
    {label:'Base (actuel)',sim:simBase,css:'base'},
    {label:'Optimiste (+25%)',sim:simOpt,css:'optimiste'},
  ];
  let sgH='';
  scenarios.forEach(sc=>{
    sgH+='<div class="risk-scenario '+sc.css+'">';
    sgH+='<h4>'+sc.label+'</h4>';
    sgH+='<div class="rs-val '+(sc.sim.resY3<0?'neg':'pos')+'">'+fmtCHF(sc.sim.resY3)+'</div>';
    sgH+='<div class="rs-detail">CA Y3: '+fmt(sc.sim.caY3)+'</div>';
    sgH+='<div class="rs-detail">BFR min: '+fmt(sc.sim.bfrMin)+'</div>';
    sgH+='<div class="rs-detail">Tr\u00e9so M36: '+fmt(sc.sim.tresoFinal)+'</div>';
    sgH+='</div>';
  });
  el('riskScenarioGrid').innerHTML=sgH;

  // 5. Sensitivity analysis
  const sensVars=[
    {label:'Consultations/jour',key:'consult',pess:Math.max(8,Math.round(consult*0.75))},
    {label:'Honoraires moyens',key:'fee',pess:Math.round(fee*0.75)},
    {label:'Taux occupation Y1',key:'occup',pess:Math.max(30,Math.round(occup*0.75))},
    {label:'D\u00e9lai mont\u00e9e charge',key:'start',pess:Math.min(12,start+3)},
  ];
  const impacts=sensVars.map(v=>{
    const p={...bp,[v.key]:v.pess};
    const r=computeSimulation(p);
    return {label:v.label,delta:Math.abs(simBase.resY3-r.resY3)};
  });
  const maxImp=Math.max(...impacts.map(i=>i.delta),1);
  let sensH='';
  impacts.forEach(imp=>{
    const pct=Math.round(imp.delta/maxImp*100);
    const lv=pct>70?'high':pct>40?'medium':'low';
    sensH+='<div class="risk-sens-row">';
    sensH+='<div class="risk-sens-label">'+imp.label+'</div>';
    sensH+='<div class="risk-sens-bar-ct"><div class="risk-sens-bar '+lv+'" style="width:'+pct+'%"></div></div>';
    sensH+='<div class="risk-sens-pct">'+fmt(imp.delta)+'</div>';
    sensH+='</div>';
  });
  el('riskSensitivity').innerHTML=sensH;

  // 6. Stress chart (horizontal bar)
  if(charts.riskStress){try{charts.riskStress.destroy()}catch(e){}}
  charts.riskStress=new Chart(el('cRiskStress'),{type:'bar',data:{labels:impacts.map(i=>i.label),datasets:[{label:'Impact sur R\u00e9sultat Y3',data:impacts.map(i=>i.delta),backgroundColor:impacts.map(i=>{const p=i.delta/maxImp;return p>0.7?'rgba(214,48,49,.7)':p>0.4?'rgba(253,203,110,.7)':'rgba(0,184,148,.7)';}),borderRadius:8,barPercentage:.6}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},y:{grid:{display:false}}}}});

  // 7. Risk matrix
  const lvlLabel=v=>[,'Tr\u00e8s faible','Faible','Moyen','\u00c9lev\u00e9','Tr\u00e8s \u00e9lev\u00e9'][v]||'';
  const lvlClass=v=>[,'faible','faible','moyen','eleve','tres-eleve'][v]||'';
  const scoreColor=s=>s>=16?'var(--danger)':s>=9?'#e17055':s>=4?'var(--pl)':'var(--acc)';
  const sorted=[...RISK_MATRIX].sort((a,b)=>{
    const as=a.prob*a.impact,bs=b.prob*b.impact;
    if(riskSortField==='score')return riskSortAsc?as-bs:bs-as;
    if(riskSortField==='prob')return riskSortAsc?a.prob-b.prob:b.prob-a.prob;
    if(riskSortField==='impact')return riskSortAsc?a.impact-b.impact:b.impact-a.impact;
    return 0;
  });
  let totalExposure=0;
  let mH='<table class="dt"><thead><tr><th>Risque</th>';
  mH+='<th class="sortable'+(riskSortField==='prob'?' sorted-'+(riskSortAsc?'asc':'desc'):'')+'" onclick="sortRisksBy(\'prob\')">Probabilit\u00e9</th>';
  mH+='<th class="sortable'+(riskSortField==='impact'?' sorted-'+(riskSortAsc?'asc':'desc'):'')+'" onclick="sortRisksBy(\'impact\')">Impact</th>';
  mH+='<th class="sortable'+(riskSortField==='score'?' sorted-'+(riskSortAsc?'asc':'desc'):'')+'" onclick="sortRisksBy(\'score\')">Score</th>';
  mH+='<th>Mitigation</th></tr></thead><tbody>';
  sorted.forEach(r=>{
    const sc=r.prob*r.impact;totalExposure+=sc;
    mH+='<tr><td>'+r.name+'</td>';
    mH+='<td><span class="badge clickable '+lvlClass(r.prob)+'" onclick="cycleRiskValue(\''+r.id+'\',\'prob\')">'+lvlLabel(r.prob)+'</span></td>';
    mH+='<td><span class="badge clickable '+lvlClass(r.impact)+'" onclick="cycleRiskValue(\''+r.id+'\',\'impact\')">'+lvlLabel(r.impact)+'</span></td>';
    mH+='<td class="risk-score-cell" style="color:'+scoreColor(sc)+'">'+sc+'</td>';
    mH+='<td>'+r.mitigation+'</td></tr>';
  });
  mH+='</tbody></table>';
  el('riskMatrixContainer').innerHTML=mH;
  el('riskExposureVal').textContent=totalExposure+' / '+(RISK_MATRIX.length*25)+' (max)';

  // 8. Charges table + donut
  let totalMin=0,totalMax=0;
  let cH='';
  CHARGES_DATA.forEach(c=>{
    totalMin+=c.min;totalMax+=c.max;
    cH+='<tr><td>'+c.name+'</td><td class="num">'+fmtCHF(c.min)+'</td><td class="num">'+fmtCHF(c.max)+'</td><td><span class="badge '+c.criticite+'">'+c.criticite+'</span></td></tr>';
  });
  cH+='<tr style="font-weight:700;border-top:2px solid var(--brd)"><td>TOTAL</td><td class="num">'+fmtCHF(totalMin)+'</td><td class="num">'+fmtCHF(totalMax)+'</td><td></td></tr>';
  el('chargesBody').innerHTML=cH;
  el('chargesTotalLabel').textContent='~CHF '+fmt(totalMin)+'\u2013'+fmt(totalMax)+'/an';
  if(charts.charges){try{charts.charges.destroy()}catch(e){}}
  const crit={critique:0,important:0,moyen:0};
  CHARGES_DATA.forEach(c=>{crit[c.criticite]=(crit[c.criticite]||0)+(c.min+c.max)/2;});
  charts.charges=new Chart(el('cCharges'),{type:'doughnut',data:{labels:['Critique','Important','Moyen'],datasets:[{data:[crit.critique,crit.important,crit.moyen],backgroundColor:['#d63031','#fdcb6e','#74b9ff'],borderWidth:0}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{position:'bottom',labels:{font:{size:10},usePointStyle:true,padding:8}}},cutout:'65%'}});

  // 9. Global risk indicator
  const stressSens=impacts.reduce((s,i)=>s+i.delta,0);
  const maxSens=maxImp*sensVars.length;
  const stressScore=maxSens>0?(stressSens/maxSens)*50:25;
  const matrixScore=(totalExposure/(RISK_MATRIX.length*25))*50;
  const composite=Math.round(stressScore+matrixScore);
  const circ=2*Math.PI*34;
  const offset=circ*(1-composite/100);
  el('riskScore').textContent=composite;
  const arc=el('riskArc');
  arc.setAttribute('stroke-dasharray',circ);
  arc.setAttribute('stroke-dashoffset',offset);
  const gauge=el('riskGauge');
  if(composite<=33){
    gauge.className='risk-gauge low';arc.setAttribute('stroke','var(--acc)');
    el('riskLabel').textContent='Risque global : Faible';
    el('riskSub').textContent='Le projet pr\u00e9sente une bonne r\u00e9silience aux variations de param\u00e8tres et un profil de risque ma\u00eetris\u00e9.';
  } else if(composite<=60){
    gauge.className='risk-gauge medium';arc.setAttribute('stroke','#e17055');
    el('riskLabel').textContent='Risque global : Mod\u00e9r\u00e9';
    el('riskSub').textContent='Certaines variables pr\u00e9sentent une sensibilit\u00e9 significative. Renforcez les mesures de mitigation.';
  } else {
    gauge.className='risk-gauge high';arc.setAttribute('stroke','var(--danger)');
    el('riskLabel').textContent='Risque global : \u00c9lev\u00e9';
    el('riskSub').textContent='Le projet est tr\u00e8s sensible aux variations. R\u00e9visez les hypoth\u00e8ses cl\u00e9s et renforcez le plan de contingence.';
  }
}

// ===== PROFIT TAB =====
function updateProfit(){
  if(!D)return;
  const el=id=>document.getElementById(id);

  // 1. Read controls
  const nbAssoc=+(el('pAssoc')?el('pAssoc').value:2);
  const charges=+(el('pCharges')?el('pCharges').value:200000);
  if(el('pAssocVal')) el('pAssocVal').textContent=nbAssoc;
  if(el('pChargesVal')) el('pChargesVal').textContent=fmt(charges);

  // 2. Calculate metrics
  const investPerAssoc=D.capex/nbAssoc;
  const chargesPerAssoc=charges/nbAssoc;
  const perY1=D.resY1/nbAssoc, perY2=D.resY2/nbAssoc, perY3=D.resY3/nbAssoc;
  const adjY1=Math.max(0,perY1-chargesPerAssoc);
  const adjY2=perY2-chargesPerAssoc;
  const adjY3=perY3-chargesPerAssoc;
  const cumAdj=adjY1+adjY2+adjY3;
  const roiCumul=investPerAssoc>0?cumAdj/investPerAssoc:0;

  // Payback: cumulative monthly result per associate minus monthly charges
  const monthlyCharges=charges/(12*nbAssoc);
  let payback=36;
  let cumProfit=0;
  for(let m=0;m<36;m++){
    cumProfit+=D.result[m]/nbAssoc-monthlyCharges;
    if(cumProfit>0){payback=m+1;break;}
  }

  // 3. KPIs
  el('pRoi').textContent=roiCumul.toFixed(1)+'x';
  el('pRoi').parentElement.className='kpi '+(roiCumul>=3?'green':roiCumul>=1?'orange':'red');
  el('pRoiSub').textContent='Invest. '+fmtCHF(investPerAssoc)+' \u2192 retour '+fmtCHF(cumAdj);
  el('pPayback').textContent=payback+' mois';
  el('pPayback').parentElement.className='kpi '+(payback<=12?'green':payback<=24?'orange':'red');
  el('pPerAssocY3').textContent=fmtCHF(adjY3);
  el('pPerAssocY3Sub').textContent='Apr\u00e8s '+fmt(chargesPerAssoc)+' charges/an';
  el('pInvestAssoc').textContent=fmtCHF(investPerAssoc);

  // 4. Year cards
  el('pResY1').textContent=fmtCHF(D.resY1);
  el('pResY2').textContent=fmtCHF(D.resY2);
  el('pResY3').textContent=fmtCHF(D.resY3);
  el('pPerY1').textContent='~'+fmt(perY1)+' / associ\u00e9';
  el('pPerY2').textContent='~'+fmt(perY2)+' / associ\u00e9';
  el('pPerY3').textContent='~'+fmt(perY3)+' / associ\u00e9';
  el('pAdjY1').textContent='Apr\u00e8s charges: ~'+fmt(adjY1);
  el('pAdjY2').textContent='Apr\u00e8s charges: ~'+fmt(adjY2);
  el('pAdjY3').textContent='Apr\u00e8s charges: ~'+fmt(adjY3);

  // 5. Verdict
  const vd=el('profitVerdict'),vt=el('profitVerdictText');
  if(roiCumul>=5){
    vd.className='verdict green';
    vt.innerHTML='<strong>ROI excellent ('+roiCumul.toFixed(1)+'x).</strong> Pour ~'+fmtCHF(investPerAssoc)+' par associ\u00e9, le retour cumul\u00e9 sur 3 ans atteint <strong>'+fmtCHF(cumAdj)+'</strong> apr\u00e8s charges manquantes.';
  } else if(roiCumul>=2){
    vd.className='verdict green';
    vt.innerHTML='<strong>ROI attractif ('+roiCumul.toFixed(1)+'x).</strong> Retour cumul\u00e9 de <strong>'+fmtCHF(cumAdj)+'</strong> par associ\u00e9 sur 3 ans. Payback en <strong>'+payback+' mois</strong>.';
  } else if(roiCumul>=1){
    vd.className='verdict orange';
    vt.innerHTML='<strong>ROI mod\u00e9r\u00e9 ('+roiCumul.toFixed(1)+'x).</strong> L\'investissement est r\u00e9cup\u00e9r\u00e9 mais les marges restent limit\u00e9es.';
  } else {
    vd.className='verdict red';
    vt.innerHTML='<strong>ROI insuffisant ('+roiCumul.toFixed(1)+'x).</strong> Le retour sur 3 ans ne couvre pas l\'investissement. R\u00e9duisez les charges ou augmentez le CA.';
  }

  // 6. Breakdown medecin vs non-medecin
  const retroRate=getRetroRate()/100;
  const revSpecAnnual=D.revSpec||923432;
  const retroAnnual=revSpecAnnual*retroRate;
  let bkH='';
  // Medecin card
  bkH+='<div class="profit-type"><h4>&#129657; Associ\u00e9 m\u00e9decin</h4>';
  bkH+='<div class="pt-row"><span class="pt-label">R\u00e9trocession propre CA ('+Math.round(retroRate*100)+'%)</span><span class="pt-value">'+fmtCHF(retroAnnual)+'/an</span></div>';
  bkH+='<div class="pt-row"><span class="pt-label">Part r\u00e9sultat Y1</span><span class="pt-value">'+fmtCHF(adjY1)+'</span></div>';
  bkH+='<div class="pt-row"><span class="pt-label">Part r\u00e9sultat Y2</span><span class="pt-value">'+fmtCHF(adjY2)+'</span></div>';
  bkH+='<div class="pt-row"><span class="pt-label">Part r\u00e9sultat Y3</span><span class="pt-value">'+fmtCHF(adjY3)+'</span></div>';
  const medTotal=cumAdj+retroAnnual*3;
  bkH+='<div class="pt-total"><span class="pt-label">Total 3 ans (retro + r\u00e9sultat)</span><span class="pt-value">'+fmtCHF(medTotal)+'</span></div>';
  bkH+='</div>';
  // Non-medecin card
  bkH+='<div class="profit-type"><h4>&#128188; Associ\u00e9 non-m\u00e9decin</h4>';
  bkH+='<div class="pt-row"><span class="pt-label">R\u00e9trocession propre CA</span><span class="pt-value">\u2014</span></div>';
  bkH+='<div class="pt-row"><span class="pt-label">Part r\u00e9sultat Y1</span><span class="pt-value">'+fmtCHF(adjY1)+'</span></div>';
  bkH+='<div class="pt-row"><span class="pt-label">Part r\u00e9sultat Y2</span><span class="pt-value">'+fmtCHF(adjY2)+'</span></div>';
  bkH+='<div class="pt-row"><span class="pt-label">Part r\u00e9sultat Y3</span><span class="pt-value">'+fmtCHF(adjY3)+'</span></div>';
  bkH+='<div class="pt-total"><span class="pt-label">Total 3 ans (r\u00e9sultat seul)</span><span class="pt-value">'+fmtCHF(cumAdj)+'</span></div>';
  bkH+='</div>';
  el('profitBreakdown').innerHTML=bkH;

  // 7. Bar chart (3 datasets)
  if(charts.profit){try{charts.profit.destroy()}catch(e){}}
  charts.profit=new Chart(el('cProfit'),{type:'bar',data:{labels:['Ann\u00e9e 1','Ann\u00e9e 2','Ann\u00e9e 3'],datasets:[
    {label:'R\u00e9sultat brut / associ\u00e9',data:[perY1,perY2,perY3],backgroundColor:'rgba(26,74,122,.8)',borderRadius:8,barPercentage:.5},
    {label:'Apr\u00e8s charges manquantes',data:[adjY1,adjY2,adjY3],backgroundColor:'rgba(0,184,148,.8)',borderRadius:8,barPercentage:.5},
    {label:'Revenu m\u00e9decin total',data:[adjY1+retroAnnual,adjY2+retroAnnual,adjY3+retroAnnual],backgroundColor:'rgba(253,203,110,.8)',borderRadius:8,barPercentage:.5}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:16}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)+' CHF'}},x:{grid:{display:false}}}}});

  // 8. Cumulative profit line chart
  if(charts.profitCumul){try{charts.profitCumul.destroy()}catch(e){}}
  const cumData=[];let cum=0;
  for(let m=0;m<36;m++){cum+=D.result[m]/nbAssoc-monthlyCharges;cumData.push(cum);}
  const investLine=Array(36).fill(investPerAssoc);
  charts.profitCumul=new Chart(el('cProfitCumul'),{type:'line',data:{labels:labelsQ,datasets:[
    {label:'Profit cumul\u00e9 / associ\u00e9',data:cumData,borderColor:'#00b894',backgroundColor:'rgba(0,184,148,.08)',fill:true,tension:.3,pointRadius:0,borderWidth:2.5},
    {label:'Investissement (CAPEX / associ\u00e9)',data:investLine,borderColor:'#d63031',borderWidth:1.5,borderDash:[6,4],pointRadius:0,fill:false}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)+' CHF'}},x:{grid:{display:false}}}},plugins:[yearPlugin]});
}

// ===== CASHFLOW TAB =====
const cfYearPlugin={id:'cfYL',beforeDraw(chart){
  if(cfActiveYear==='all')return;
  const ctx=chart.ctx,x=chart.scales.x,y=chart.scales.y;
  const yi=parseInt(cfActiveYear);
  const s=(yi-1)*12,e=yi*12-1;
  if(s>x.max||e<x.min)return;
  const xS=x.getPixelForValue(Math.max(s,x.min)),xE=x.getPixelForValue(Math.min(e,x.max));
  ctx.save();ctx.fillStyle='rgba(26,74,122,.04)';
  ctx.fillRect(xS,y.top,xE-xS,y.bottom-y.top);
  ctx.fillStyle='rgba(26,74,122,.5)';ctx.font='bold 11px Inter,sans-serif';
  ctx.fillText('Ann\u00e9e '+cfActiveYear,xS+4,y.top+14);
  ctx.restore();
}};
function setCfYear(year,btn){
  cfActiveYear=year;
  document.querySelectorAll('.cf-year-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  updateCashflow();
}
function updateCashflow(){
  if(!D)return;
  const el=id=>document.getElementById(id);
  // 1. Read controls
  const year=cfActiveYear;
  // 2. Period bounds
  const periods={'all':{s:0,e:36,label:'36 mois'},'1':{s:0,e:12,label:'Ann\u00e9e 1'},'2':{s:12,e:24,label:'Ann\u00e9e 2'},'3':{s:24,e:36,label:'Ann\u00e9e 3'}};
  const p=periods[year];
  const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
  // 3. Compute metrics
  const tresoFin=D.cashflow[p.e-1];
  const periodTreso3m=D.treso3m.slice(p.s,p.e);
  const bfrMinPeriod=Math.min(...periodTreso3m);
  const bfrMinIdx=periodTreso3m.indexOf(bfrMinPeriod);
  const bfrMinMonth=p.s+bfrMinIdx+1;
  // Critical month: first negative in treso3m within period
  let critMonth='\u2014';
  let critMonthSub='Aucun mois n\u00e9gatif';
  for(let m=p.s;m<p.e;m++){if(D.treso3m[m]<0){critMonth='M'+(m+1);critMonthSub='Sc\u00e9nario LAMal 3m';break;}}
  // Inflows vs outflows
  const inflows=sum(D.ca,p.s,p.e);
  const outflows=Math.abs(sum(D.admin,p.s,p.e))+Math.abs(sum(D.opex,p.s,p.e))+Math.abs(sum(D.lab,p.s,p.e));
  const ratio=outflows>0?(inflows/outflows):0;
  // 4. KPIs
  el('cfTresoFin').textContent=fmtCHF(Math.round(tresoFin));
  el('cfTresoFinSub').textContent='Fin '+p.label+' (sans d\u00e9lai)';
  el('cfTresoFin').parentElement.className='kpi '+(tresoFin>0?'green':'red');
  el('cfBfrMin').textContent=fmt(bfrMinPeriod);
  el('cfBfrMinSub').textContent='M'+bfrMinMonth+' \u2014 sc\u00e9nario LAMal 3m';
  el('cfBfrMin').parentElement.className='kpi '+(bfrMinPeriod<-150000?'red':bfrMinPeriod<-50000?'orange':'green');
  el('cfCritMonth').textContent=critMonth;
  el('cfCritMonthSub').textContent=critMonthSub;
  el('cfCritMonth').parentElement.className='kpi '+(critMonth==='\u2014'?'green':'orange');
  el('cfRatio').textContent=ratio.toFixed(2)+'x';
  el('cfRatioSub').textContent=fmt(inflows)+' entr\u00e9es / '+fmt(outflows)+' sorties';
  el('cfRatio').parentElement.className='kpi '+(ratio>=1.3?'green':ratio>=1?'orange':'red');
  // 5. Verdict
  const vd=el('cfVerdict'),vt=el('cfVerdictText');
  if(bfrMinPeriod>=-50000){
    vd.className='verdict green';
    vt.innerHTML='<strong>Tr\u00e9sorerie ma\u00eetris\u00e9e.</strong> Sur '+p.label+', le BFR minimum ('+fmt(bfrMinPeriod)+') reste g\u00e9rable. Ratio entr\u00e9es/sorties de '+ratio.toFixed(2)+'x.';
  } else if(bfrMinPeriod>=-150000){
    vd.className='verdict orange';
    vt.innerHTML='<strong>Attention \u00e0 la tr\u00e9sorerie.</strong> Sur '+p.label+', le BFR atteint <strong>'+fmt(bfrMinPeriod)+'</strong> au mois M'+bfrMinMonth+'. Le factoring est recommand\u00e9 pour s\u00e9curiser le d\u00e9marrage.';
  } else {
    vd.className='verdict red';
    vt.innerHTML='<strong>Risque de tr\u00e9sorerie \u00e9lev\u00e9.</strong> Sur '+p.label+', le BFR plonge \u00e0 <strong>'+fmt(bfrMinPeriod)+'</strong> au mois M'+bfrMinMonth+'. Sans optimisation, un financement relais est indispensable.';
  }
  // 6. Scenario cards
  const scenarios=[
    {title:'\ud83d\udd34 100% LAMal 3m',data:D.treso3m},
    {title:'\ud83d\udfe0 15% cash + LAMal 3m',data:D.tresoCash3m},
    {title:'\ud83d\udfe1 15% cash + LAMal 1m',data:D.tresoCash1m},
    {title:'\u2705 15% cash + Factoring',data:D.tresoFact}
  ];
  const bfrAll=scenarios.map(s=>Math.min(...s.data.slice(p.s,p.e)));
  const bestBfr=Math.max(...bfrAll),worstBfr=Math.min(...bfrAll);
  let gridH='';
  scenarios.forEach((sc,i)=>{
    const pd=sc.data.slice(p.s,p.e);
    const periodBfr=Math.min(...pd);
    const periodBfrIdx=pd.indexOf(periodBfr);
    const critM=p.s+periodBfrIdx+1;
    let negMonth='\u2014';
    for(let m=0;m<pd.length;m++){if(pd[m]<0){negMonth='M'+(p.s+m+1);break;}}
    const isBest=periodBfr===bestBfr,isWorst=periodBfr===worstBfr;
    let cls='cf-scenario'+(isWorst?' worst':'')+(isBest?' best':'');
    let tag='';
    if(periodBfr<-150000) tag='<span class="cf-tag red">Risque \u00e9lev\u00e9</span>';
    else if(periodBfr<-50000) tag='<span class="cf-tag orange">Mod\u00e9r\u00e9</span>';
    else tag='<span class="cf-tag green">S\u00e9curis\u00e9</span>';
    gridH+='<div class="'+cls+'">';
    gridH+='<h4>'+sc.title+'</h4>';
    gridH+='<div class="cf-val '+(periodBfr<0?'neg':'pos')+'">'+fmt(periodBfr)+'</div>';
    gridH+='<div class="cf-detail">BFR min \u2014 mois M'+critM+'</div>';
    gridH+='<div class="cf-detail">1er mois n\u00e9gatif : '+negMonth+'</div>';
    gridH+=tag;
    gridH+='</div>';
  });
  el('cfScenarioGrid').innerHTML=gridH;
  // 7. Line chart
  if(charts.cashflow){try{charts.cashflow.destroy()}catch(e){}}
  const cfDs=[
    {label:'Sans d\u00e9lai',data:D.cashflow,borderColor:'#00b894',backgroundColor:'rgba(0,184,148,.05)',fill:true,tension:.3,pointRadius:0,borderWidth:2},
    {label:'100% LAMal 3m',data:D.treso3m,borderColor:'#d63031',backgroundColor:'rgba(214,48,49,.03)',fill:true,tension:.3,pointRadius:0,borderWidth:2,borderDash:[6,3]},
    {label:'15% cash + Factoring',data:D.tresoFact,borderColor:'#1a4a7a',backgroundColor:'rgba(26,74,122,.05)',fill:true,tension:.3,pointRadius:0,borderWidth:2.5}
  ];
  if(OVERLAY){cfDs.push({label:'Cashflow sc\u00e9nario',data:OVERLAY.cashflow,borderColor:'#e17055',borderWidth:2.5,borderDash:[6,3],pointRadius:0,tension:.3,fill:false});}
  charts.cashflow=new Chart(document.getElementById('cCashflow'),{type:'line',data:{labels:labelsQ,datasets:cfDs},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}},plugins:[yearPlugin,cfYearPlugin]});
  // 8. Waterfall chart
  if(charts.cashWaterfall){try{charts.cashWaterfall.destroy()}catch(e){}}
  const monthlyNet=D.ca.map((c,m)=>c+D.admin[m]+D.opex[m]+D.lab[m]);
  const wfColors=monthlyNet.map((v,m)=>{
    const inYear=year==='all'||(m>=(+year-1)*12&&m<+year*12);
    if(!inYear) return v>=0?'rgba(0,184,148,.15)':'rgba(214,48,49,.15)';
    return v>=0?'rgba(0,184,148,.8)':'rgba(214,48,49,.8)';
  });
  const wfBorders=monthlyNet.map((v,m)=>{
    const inYear=year==='all'||(m>=(+year-1)*12&&m<+year*12);
    if(!inYear) return v>=0?'rgba(0,184,148,.3)':'rgba(214,48,49,.3)';
    return v>=0?'#00b894':'#d63031';
  });
  charts.cashWaterfall=new Chart(document.getElementById('cCashWaterfall'),{type:'bar',data:{labels:labelsQ,datasets:[{
    label:'Flux mensuel net',data:monthlyNet,backgroundColor:wfColors,borderColor:wfBorders,borderWidth:1,borderRadius:2
  }]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>fmt(ctx.raw)+' CHF'}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}},plugins:[yearPlugin]});
}

// ===== TEAM TAB =====
function setTeamYear(year,btn){
  teamActiveYear=year;
  document.querySelectorAll('.team-year-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  updateTeam();
}
function updateTeam(){
  if(!D)return;
  const el=id=>document.getElementById(id);
  // 1. Read controls
  const year=teamActiveYear;
  const showProd=el('teamProdToggle')&&el('teamProdToggle').classList.contains('on');
  // 2. Period bounds
  const periods={'all':{s:0,e:36,label:'36 mois'},'1':{s:0,e:12,label:'Ann\u00e9e 1'},'2':{s:12,e:24,label:'Ann\u00e9e 2'},'3':{s:24,e:36,label:'Ann\u00e9e 3'}};
  const p=periods[year];
  const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
  const avg=(arr,s,e)=>{const sl=arr.slice(s,e);return sl.length?sl.reduce((a,b)=>a+b,0)/sl.length:0;};
  // 3. Compute metrics
  const fteEnd=D.fteTotal[p.e-1]||0;
  const fteStart=p.s>0?(D.fteTotal[p.s-1]||0):(D.fteTotal[0]||0);
  const totalCaPeriod=sum(D.ca,p.s,p.e);
  const avgFte=avg(D.fteTotal,p.s,p.e);
  const caPerFte=avgFte>0?totalCaPeriod/avgFte:0;
  const avgAdmin=avg(D.fteAdmin,p.s,p.e);
  const avgPrat=avg(D.fteAssoc,p.s,p.e)+avg(D.fteIndep,p.s,p.e)+avg(D.fteInterne,p.s,p.e);
  const ratioAdmin=avgPrat>0?avgAdmin/avgPrat:0;
  const growth=fteStart>0?((fteEnd-fteStart)/fteStart*100):fteEnd>0?100:0;
  // 4. KPIs
  el('tEtp').textContent=fteEnd;
  el('tEtpSub').textContent='Fin '+p.label;
  el('tCaEtp').textContent=fmtCHF(Math.round(caPerFte));
  el('tCaEtpSub').textContent='Moyenne sur '+p.label;
  el('tRatio').textContent=ratioAdmin.toFixed(2);
  el('tRatioSub').textContent=Math.round(avgAdmin)+' admin / '+Math.round(avgPrat)+' praticiens';
  el('tGrowth').textContent=(growth>=0?'+':'')+Math.round(growth)+'%';
  el('tGrowthSub').textContent=fteStart+' \u2192 '+fteEnd+' ETP';
  el('tGrowth').parentElement.className='kpi '+(growth>50?'green':growth>0?'orange':'red');
  // 5. Profile cards
  const profiles=[
    {key:'assoc',label:'Associ\u00e9s',icon:'\ud83e\ude7a',data:D.fteAssoc,ca:D.caAssoc,css:'assoc'},
    {key:'indep',label:'Ind\u00e9pendants',icon:'\ud83d\udc68\u200d\u2695\ufe0f',data:D.fteIndep,ca:D.caIndep,css:'indep'},
    {key:'interne',label:'Internes',icon:'\ud83d\udcbc',data:D.fteInterne,ca:D.caInterne,css:'interne'},
    {key:'admin',label:'Personnel admin',icon:'\ud83d\udcdd',data:D.fteAdmin,ca:null,css:'admin'}
  ];
  const maxFte=Math.max(D.fteTotal[35],1);
  let profH='';
  profiles.forEach(pr=>{
    const fteY1=pr.data[11]||0,fteY2=pr.data[23]||0,fteY3=pr.data[35]||0;
    const ftePeriod=pr.data[p.e-1]||0;
    let startMonth='\u2014';
    for(let m=0;m<36;m++){if(pr.data[m]>0){startMonth='M'+(m+1);break;}}
    const caPeriod=pr.ca?sum(pr.ca,p.s,p.e):0;
    const barPct=Math.round(fteY3/maxFte*100);
    profH+='<div class="team-profile '+pr.css+'">';
    profH+='<h4>'+pr.icon+' '+pr.label+'</h4>';
    profH+='<div class="tp-fte">'+ftePeriod+' ETP</div>';
    profH+='<div class="tp-row"><span class="tp-label">D\u00e9but</span><span class="tp-value">'+startMonth+'</span></div>';
    profH+='<div class="tp-row"><span class="tp-label">Y1 / Y2 / Y3</span><span class="tp-value">'+fteY1+' / '+fteY2+' / '+fteY3+'</span></div>';
    if(pr.ca){profH+='<div class="tp-row"><span class="tp-label">CA '+p.label+'</span><span class="tp-value">'+fmt(caPeriod)+'</span></div>';}
    else{profH+='<div class="tp-row"><span class="tp-label">CA</span><span class="tp-value">\u2014 (co\u00fbt)</span></div>';}
    profH+='<div class="tp-bar"><div class="tp-bar-fill" style="width:'+barPct+'%"></div></div>';
    profH+='</div>';
  });
  el('teamProfiles').innerHTML=profH;
  // 6. Verdict
  const vd=el('teamVerdict'),vt=el('teamVerdictText');
  if(year==='1'){vd.className='verdict orange';vt.innerHTML='<strong>Ann\u00e9e 1 \u2014 D\u00e9marrage.</strong> Recrutements initiaux, '+fteEnd+' ETP fin de p\u00e9riode. Productivit\u00e9 en mont\u00e9e.';}
  else if(year==='2'){vd.className='verdict green';vt.innerHTML='<strong>Ann\u00e9e 2 \u2014 Croissance.</strong> \u00c9quipe \u00e0 '+fteEnd+' ETP. CA/ETP en progression \u00e0 '+fmtCHF(Math.round(caPerFte))+'.';}
  else if(year==='3'){vd.className='verdict green';vt.innerHTML='<strong>Ann\u00e9e 3 \u2014 Croisi\u00e8re.</strong> \u00c9quipe compl\u00e8te \u00e0 '+fteEnd+' ETP. Productivit\u00e9 stabilis\u00e9e \u00e0 '+fmtCHF(Math.round(caPerFte))+'/ETP.';}
  else{vd.className='verdict '+(fteEnd>=14?'green':fteEnd>=8?'orange':'red');vt.innerHTML='<strong>L\'\u00e9quipe passe de '+fteStart+' \u00e0 '+fteEnd+' ETP sur 36 mois.</strong> Productivit\u00e9 moyenne : '+fmtCHF(Math.round(caPerFte))+'/ETP.';}
  // 7. Stacked bar chart with year highlighting
  if(charts.team){try{charts.team.destroy()}catch(e){}}
  const tColors=['#0f2b46','#1a4a7a','#5dade2','#aed6f1'];
  const tLabels=['Associ\u00e9s','Ind\u00e9pendants','Internes','Personnel admin'];
  const tData=[D.fteAssoc,D.fteIndep,D.fteInterne,D.fteAdmin];
  const tDs=tData.map((d,i)=>({label:tLabels[i],data:d,backgroundColor:d.map((_,m)=>{
    if(year==='all')return tColors[i];
    const yIdx=+year;return(m>=(yIdx-1)*12&&m<yIdx*12)?tColors[i]:tColors[i]+'40';
  }),borderRadius:1}));
  charts.team=new Chart(document.getElementById('cTeam'),{type:'bar',data:{labels:labelsQ,datasets:tDs},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{x:{stacked:true,grid:{display:false}},y:{stacked:true,grid:gridOpts,title:{display:true,text:'ETP'}}}},plugins:[yearPlugin]});
  // 8. Productivity line chart
  const prodCard=el('teamProdCard');
  if(prodCard)prodCard.style.display=showProd?'':'none';
  if(showProd){
    if(charts.teamProd){try{charts.teamProd.destroy()}catch(e){}}
    const prodData=D.ca.map((c,m)=>D.fteTotal[m]>0?c/D.fteTotal[m]:0);
    const prodSmooth=prodData.map((v,i)=>i<2?v:(prodData[i-2]+prodData[i-1]+v)/3);
    charts.teamProd=new Chart(document.getElementById('cTeamProd'),{type:'line',data:{labels:labelsQ,datasets:[
      {label:'CA/ETP (mensuel)',data:prodData,borderColor:'rgba(26,74,122,.3)',backgroundColor:'transparent',tension:.3,pointRadius:0,borderWidth:1,borderDash:[3,3],fill:false},
      {label:'CA/ETP (moy. 3m)',data:prodSmooth,borderColor:'#1a4a7a',backgroundColor:'rgba(26,74,122,.05)',tension:.3,pointRadius:0,borderWidth:2.5,fill:true}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)+' CHF'},title:{display:true,text:'CHF / ETP / mois'}},x:{grid:{display:false}}}},plugins:[yearPlugin]});
  }
}

// ===== OVERVIEW TAB =====
function updateOverview(){
  if(!D)return;
  const el=id=>document.getElementById(id);
  const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
  // 1. Compute metrics
  const margin3=D.caY3>0?Math.round(D.resY3/D.caY3*100):0;
  const caGrowth=D.caY1>0?Math.round(((D.caY3-D.caY1)/D.caY1)*100):0;
  let payback=36,cumR=0;
  for(let m=0;m<36;m++){cumR+=D.result[m];if(cumR>0&&D.result[m]>0){payback=m+1;break;}}
  const bfrWorst=D.bfrWorst;
  // 2. KPIs
  el('ovCapex').textContent=fmt(D.capex);
  el('ovCaY3').textContent=fmt(D.caY3);
  el('ovCaGrowth').textContent=caGrowth>0?'+'+caGrowth+'% vs Y1':'Croissance';
  el('ovResY3').textContent=fmt(D.resY3);
  el('ovMargin').textContent='Marge ~'+margin3+'%';
  el('ovResY3').parentElement.className='kpi '+(margin3>=20?'green':margin3>=10?'orange':'red');
  el('ovMarginPct').textContent=margin3+'%';
  el('ovMarginPct').parentElement.className='kpi '+(margin3>=20?'green':margin3>=10?'orange':'red');
  el('ovPayback').textContent=payback+' mois';
  el('ovPayback').parentElement.className='kpi '+(payback<=12?'green':payback<=18?'blue':'orange');
  el('ovBfr').textContent=fmt(bfrWorst)+' CHF';
  el('ovBfr').parentElement.className='kpi '+(bfrWorst>=-50000?'green':bfrWorst>=-150000?'orange':'red');
  el('ovBfrSub').textContent=bfrWorst>=0?'Aucun besoin':'Trou de tr\u00e9sorerie max';
  // 3. Year timeline cards
  const years=[
    {n:1,s:0,e:12,phase:'D\u00e9marrage',phaseCSS:'start',cls:'y1'},
    {n:2,s:12,e:24,phase:'Croissance',phaseCSS:'grow',cls:'y2'},
    {n:3,s:24,e:36,phase:'Croisi\u00e8re',phaseCSS:'cruise',cls:'y3'}
  ];
  let tlH='';
  years.forEach(y=>{
    const ca=sum(D.ca,y.s,y.e),res=sum(D.result,y.s,y.e);
    const m=ca>0?Math.round(res/ca*100):0;
    const fte=D.fteTotal[y.e-1]||0;
    tlH+='<div class="ov-year '+y.cls+'">';
    tlH+='<h4>Ann\u00e9e '+y.n+' <span class="ov-phase '+y.phaseCSS+'">'+y.phase+'</span></h4>';
    tlH+='<div class="ov-metric"><span class="ov-ml">Chiffre d\'affaires</span><span class="ov-mv">'+fmt(ca)+'</span></div>';
    tlH+='<div class="ov-metric"><span class="ov-ml">R\u00e9sultat net</span><span class="ov-mv">'+(res>=0?'+':'')+fmt(res)+'</span></div>';
    tlH+='<div class="ov-metric"><span class="ov-ml">Marge nette</span><span class="ov-mv">'+m+'%</span></div>';
    tlH+='<div class="ov-metric"><span class="ov-ml">\u00c9quipe (ETP)</span><span class="ov-mv">'+fte+'</span></div>';
    tlH+='</div>';
  });
  el('ovYearTl').innerHTML=tlH;
  // 4. Section summary grid
  const bfrTag=bfrWorst>=-50000?{t:'Ma\u00eetris\u00e9e',c:'green'}:bfrWorst>=-150000?{t:'Attention',c:'orange'}:{t:'Risque',c:'red'};
  const fteEnd=D.fteTotal[35]||0;
  const fteStart=D.fteTotal[0]||0;
  const fteGrowth=fteStart>0?Math.round((fteEnd-fteStart)/fteStart*100):fteEnd>0?100:0;
  const riskScoreEl=el('riskScore');
  const riskScore=riskScoreEl?parseInt(riskScoreEl.textContent)||0:0;
  const riskTag=riskScore<=33?{t:'Faible',c:'green'}:riskScore<=60?{t:'Mod\u00e9r\u00e9',c:'orange'}:{t:'\u00c9lev\u00e9',c:'red'};
  const cumRes3=D.resY1+D.resY2+D.resY3;
  const roi=D.capex>0?(cumRes3/D.capex).toFixed(1)+'x':'N/A';
  const roiVal=D.capex>0?cumRes3/D.capex:0;
  const roiTag=roiVal>=3?{t:'Excellent',c:'green'}:roiVal>=1?{t:'Correct',c:'orange'}:{t:'Insuffisant',c:'red'};
  let sH='';
  sH+='<div class="ov-summary"><div class="ov-sic">&#128176;</div><h4>Tr\u00e9sorerie</h4><div class="ov-sv '+bfrTag.c+'">'+fmt(bfrWorst)+' CHF</div><div class="ov-sd">BFR minimum (pire cas)</div><span class="ov-tag '+bfrTag.c+'">'+bfrTag.t+'</span></div>';
  sH+='<div class="ov-summary"><div class="ov-sic">&#128101;</div><h4>\u00c9quipe</h4><div class="ov-sv">'+fteEnd+' ETP</div><div class="ov-sd">'+(fteGrowth>0?'+':'')+fteGrowth+'% croissance</div><span class="ov-tag '+(fteEnd>=14?'green':fteEnd>=8?'orange':'red')+'">'+fteEnd+' collaborateurs</span></div>';
  sH+='<div class="ov-summary"><div class="ov-sic">&#9888;&#65039;</div><h4>Risques</h4><div class="ov-sv '+riskTag.c+'">'+riskScore+'/100</div><div class="ov-sd">Score composite</div><span class="ov-tag '+riskTag.c+'">'+riskTag.t+'</span></div>';
  sH+='<div class="ov-summary"><div class="ov-sic">&#128200;</div><h4>Profit</h4><div class="ov-sv '+(roiVal>=2?'green':roiVal>=1?'orange':'red')+'">'+roi+'</div><div class="ov-sd">ROI cumul\u00e9 3 ans</div><span class="ov-tag '+roiTag.c+'">'+roiTag.t+'</span></div>';
  el('ovSummaryGrid').innerHTML=sH;
  // 5. Verdict dynamique (composite multi-facteurs)
  let score=0;
  score+=margin3>=20?3:margin3>=10?2:margin3>=5?1:0;
  score+=payback<=12?3:payback<=18?2:payback<=24?1:0;
  score+=bfrWorst>=-50000?3:bfrWorst>=-150000?2:1;
  score+=roiVal>=3?3:roiVal>=1.5?2:roiVal>=1?1:0;
  const vd=el('ovVerdict'),vt=el('ovVerdictText');
  if(score>=10){
    vd.className='verdict green';
    vt.innerHTML='<strong>Projet \u00e9conomiquement viable.</strong> Marge Y3 de '+margin3+'%, payback en '+payback+' mois, tr\u00e9sorerie cumul\u00e9e de '+fmtCHF(D.cashflow[35])+' \u00e0 M36. Les indicateurs sont au vert.';
  } else if(score>=6){
    vd.className='verdict orange';
    vt.innerHTML='<strong>Projet viable sous conditions.</strong> Marge de '+margin3+'%, payback '+payback+' mois. Attention au BFR ('+fmt(bfrWorst)+' CHF). Optimisations recommand\u00e9es.';
  } else {
    vd.className='verdict red';
    vt.innerHTML='<strong>Projet \u00e0 risque \u00e9lev\u00e9.</strong> Marge de '+margin3+'%, BFR de '+fmt(bfrWorst)+' CHF. R\u00e9visez les hypoth\u00e8ses et renforcez le plan de financement.';
  }
  // 6. Chart: grouped bar (CA + R\u00e9sultat) + cashflow cumulative line
  if(charts.overview){try{charts.overview.destroy()}catch(e){}}
  const ovDs=[
    {type:'bar',label:"Chiffre d'affaires",data:[D.caY1,D.caY2,D.caY3],backgroundColor:'rgba(26,74,122,.8)',borderRadius:8,barPercentage:.6,yAxisID:'y'},
    {type:'bar',label:'R\u00e9sultat net',data:[D.resY1,D.resY2,D.resY3],backgroundColor:'rgba(0,184,148,.8)',borderRadius:8,barPercentage:.6,yAxisID:'y'},
    {type:'line',label:'Tr\u00e9sorerie cumul\u00e9e',data:[D.cashflow[11],D.cashflow[23],D.cashflow[35]],borderColor:'#e17055',backgroundColor:'rgba(225,112,85,.08)',borderWidth:2.5,pointRadius:5,pointBackgroundColor:'#e17055',tension:.3,fill:true,yAxisID:'y'}
  ];
  if(OVERLAY){
    ovDs.push({type:'bar',label:'CA sc\u00e9nario',data:[OVERLAY.caY1,OVERLAY.caY2,OVERLAY.caY3],backgroundColor:'rgba(26,74,122,.25)',borderRadius:8,barPercentage:.6,borderWidth:2,borderColor:'rgba(26,74,122,.6)',borderDash:[4,4],yAxisID:'y'});
    ovDs.push({type:'bar',label:'R\u00e9sultat sc\u00e9nario',data:[OVERLAY.resY1,OVERLAY.resY2,OVERLAY.resY3],backgroundColor:'rgba(0,184,148,.25)',borderRadius:8,barPercentage:.6,borderWidth:2,borderColor:'rgba(0,184,148,.6)',borderDash:[4,4],yAxisID:'y'});
  }
  charts.overview=new Chart(document.getElementById('cOverview'),{type:'bar',data:{labels:['Ann\u00e9e 1','Ann\u00e9e 2','Ann\u00e9e 3'],datasets:ovDs},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:16}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}}});
}

// ===== CHARTS =====
const labels=Array.from({length:36},(_,i)=>'M'+(i+1));
const labelsQ=['','','M3','','','M6','','','M9','','','M12','','','M15','','','M18','','','M21','','','M24','','','M27','','','M30','','','M33','','','M36'];
const gridOpts={color:'rgba(0,0,0,.04)',drawBorder:false};
Chart.defaults.font.family="Inter,-apple-system,sans-serif";Chart.defaults.font.size=11;Chart.defaults.color='#636e72';
const yearPlugin={id:'yl',beforeDraw(c){const ctx=c.ctx,x=c.scales.x,y=c.scales.y;ctx.save();[11,23].forEach(i=>{if(i>=x.min&&i<=x.max){const px=x.getPixelForValue(i);ctx.strokeStyle='rgba(0,0,0,.08)';ctx.lineWidth=1;ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(px,y.top);ctx.lineTo(px,y.bottom);ctx.stroke()}});ctx.restore()}};

function updateCharts(){
  if(!D)return;
  Object.entries(charts).forEach(([k,c])=>{if(k!=='sim1'&&k!=='sim2'&&k!=='optimize'&&k!=='riskStress'&&k!=='charges'&&k!=='profit'&&k!=='profitCumul'&&k!=='team'&&k!=='teamProd'&&k!=='cashflow'&&k!=='cashWaterfall'&&k!=='overview'&&k!=='revenue'&&k!=='execSpark'){try{c.destroy()}catch(e){}}});
  updateRevenue();
  updateCashflow();
  updateTeam();
  updateOptimize();
  updateRisks();
  updateProfit();
  updateOverview();
  updateExecDashboard();
}

// ===== SIMULATOR ENGINE =====
const BASE = {consult:16, fee:225, days:215, assoc:2, indep:3, interne:2, start:4, occup:60, cashPct:15, delay:1, factoring:true, extra:200000, rc:60000, retro:40};

// Pure simulation function (no DOM side effects)
function computeSimulation(params){
  const V={
    consult:params.consult, fee:params.fee, days:params.days,
    assoc:params.assoc, indep:params.indep, interne:params.interne,
    start:params.start, occup:params.occup/100, cashPct:params.cashPct/100,
    delay:params.delay, factoring:params.factoring,
    extra:params.extra, rc:params.rc, retro:(params.retro||40)/100
  };
  const annualCA_per_spec = V.consult * V.fee * V.days;
  const monthlyCA_per_spec = annualCA_per_spec/12;
  const simCA=[], simResult=[], simCashflow=[];
  let cumCash=0;
  for(let m=0;m<36;m++){
    const year=m<12?1:m<24?2:3;
    let occ=0;
    if(m >= V.start-1){
      const monthsSinceStart = m - (V.start-1);
      if(year===1) occ = Math.min(V.occup, V.occup * Math.min(1, (monthsSinceStart+1)/8));
      else if(year===2) occ = Math.min(1, V.occup + (1-V.occup)*0.6);
      else occ = 1;
    }
    const caAssoc = monthlyCA_per_spec * V.assoc * occ * V.retro;
    const caIndep = monthlyCA_per_spec * V.indep * occ * V.retro;
    const caInterne = monthlyCA_per_spec * V.interne * occ;
    const caSage = occ > 0 ? 13333 : 0;
    const totalCA = caAssoc + caIndep + caInterne + caSage;
    const baseMonthlyAdmin = 52650 * (1 + (V.assoc+V.indep+V.interne-7)*0.08);
    const baseMonthlyOpex = 45584 * (1 + (V.assoc+V.indep+V.interne-7)*0.05);
    const totalCosts = -(Math.abs(baseMonthlyAdmin) + Math.abs(baseMonthlyOpex)) * occ - (V.extra+V.rc)/12;
    const salInterne = monthlyCA_per_spec * V.interne * occ * 0.55;
    const netResult = totalCA + totalCosts - salInterne*(occ>0?1:0);
    simCA.push(totalCA);
    simResult.push(netResult);
    let cashIn = 0;
    if(V.factoring){
      cashIn = totalCA * V.cashPct + totalCA * (1-V.cashPct) * (1-FACT_COST);
    } else {
      cashIn = totalCA * V.cashPct;
      if(m >= V.delay) cashIn += simCA[m-V.delay] * (1-V.cashPct);
    }
    cumCash += cashIn + totalCosts - salInterne*(occ>0?1:0);
    simCashflow.push(cumCash);
  }
  const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
  return {
    ca:simCA, result:simResult, cashflow:simCashflow,
    caY1:sum(simCA,0,12), caY2:sum(simCA,12,24), caY3:sum(simCA,24,36),
    resY1:sum(simResult,0,12), resY2:sum(simResult,12,24), resY3:sum(simResult,24,36),
    resAdj:sum(simResult,24,36) - params.extra - params.rc,
    perAssoc:(sum(simResult,24,36) - params.extra - params.rc)/params.assoc,
    bfrMin:Math.min(...simCashflow), tresoFinal:simCashflow[35]
  };
}

function resetSim(){
  document.getElementById('sConsult').value=BASE.consult;
  document.getElementById('sFee').value=BASE.fee;
  document.getElementById('sDays').value=BASE.days;
  document.getElementById('sAssoc').value=BASE.assoc;
  document.getElementById('sIndep').value=BASE.indep;
  document.getElementById('sInterne').value=BASE.interne;
  document.getElementById('sStart').value=BASE.start;
  document.getElementById('sOccup').value=BASE.occup;
  document.getElementById('sCash').value=BASE.cashPct;
  document.getElementById('sDelay').value=BASE.delay;
  document.getElementById('sExtra').value=BASE.extra;
  document.getElementById('sRC').value=BASE.rc;
  const ft=document.getElementById('sFactToggle');if(!ft.classList.contains('on'))ft.classList.add('on');
  runSim();
}

function getSimParams() {
  const el=id=>document.getElementById(id);
  return {
    consult:+el('sConsult').value, fee:+el('sFee').value, days:+el('sDays').value,
    assoc:+el('sAssoc').value, indep:+el('sIndep').value, interne:+el('sInterne').value,
    start:+el('sStart').value, occup:+el('sOccup').value, cashPct:+el('sCash').value,
    delay:+el('sDelay').value, factoring:el('sFactToggle').classList.contains('on'),
    extra:+el('sExtra').value, rc:+el('sRC').value,
    retro:+el('sRetro').value
  };
}

function setSimParams(p) {
  const el=id=>document.getElementById(id);
  el('sConsult').value=p.consult; el('sFee').value=p.fee; el('sDays').value=p.days;
  el('sAssoc').value=p.assoc; el('sIndep').value=p.indep; el('sInterne').value=p.interne;
  el('sStart').value=p.start; el('sOccup').value=p.occup;
  el('sCash').value=p.cashPct; el('sDelay').value=p.delay;
  el('sExtra').value=p.extra; el('sRC').value=p.rc;
  el('sRetro').value=p.retro||40;
  const ft=el('sFactToggle');
  if(p.factoring && !ft.classList.contains('on')) ft.classList.add('on');
  if(!p.factoring && ft.classList.contains('on')) ft.classList.remove('on');
  runSim();
}

// Shared delta helper (sim vs base comparison badge)
function simDelta(simVal, baseVal){
  if(!baseVal||!D)return '';
  const d=((simVal/baseVal-1)*100);
  if(Math.abs(d)<1) return '<span class="sim-delta neutral">= base</span>';
  return '<span class="sim-delta '+(d>0?'up':'down')+'">'+(d>0?'+':'')+d.toFixed(0)+'%</span>';
}

function updateSimVerdict(){
  if(!SIM||!D)return;
  const el=id=>document.getElementById(id);
  const vd=el('simVerdict'),vt=el('simVerdictText');
  if(!vd||!vt)return;
  const margin3=SIM.caY3>0?Math.round(SIM.resY3/SIM.caY3*100):0;
  const bfrMin=SIM.bfrMin;
  const growth=SIM.caY1>0?((SIM.caY3/SIM.caY1-1)*100):0;
  let payback=36,cumR=0;
  for(let m=0;m<36;m++){cumR+=SIM.result[m];if(cumR>0&&SIM.result[m]>0){payback=m+1;break;}}
  let score=0;
  score+=margin3>=20?3:margin3>=10?2:margin3>=5?1:0;
  score+=bfrMin>=0?3:bfrMin>=-100000?2:bfrMin>=-250000?1:0;
  score+=growth>=100?3:growth>=50?2:growth>0?1:0;
  score+=payback<=12?3:payback<=18?2:payback<=24?1:0;
  if(score>=9){
    vd.className='verdict green';
    vt.innerHTML='<strong>Sc\u00e9nario viable.</strong> Marge Y3 de '+margin3+'%, payback en '+payback+' mois, tr\u00e9sorerie finale de '+fmtCHF(SIM.tresoFinal)+'. Les indicateurs sont au vert.';
  } else if(score>=5){
    vd.className='verdict orange';
    vt.innerHTML='<strong>Sc\u00e9nario sous conditions.</strong> Marge de '+margin3+'%, BFR min '+fmtCHF(bfrMin)+'. '+(bfrMin<-100000?'Attention au besoin de financement relais. ':'')+(payback>18?'Le payback \u00e0 '+payback+' mois est \u00e9lev\u00e9. ':'')+'Explorez les leviers d\'optimisation.';
  } else {
    vd.className='verdict red';
    vt.innerHTML='<strong>Sc\u00e9nario \u00e0 risque.</strong> Marge de '+margin3+'%, BFR de '+fmtCHF(bfrMin)+', payback '+payback+' mois. R\u00e9visez les hypoth\u00e8ses (volume, \u00e9quipe, charges).';
  }
}

function updateSimTopKpis(){
  if(!SIM||!D)return;
  const el=id=>document.getElementById(id);
  const caTotal=SIM.caY1+SIM.caY2+SIM.caY3;
  const resTotal=SIM.resY1+SIM.resY2+SIM.resY3;
  const baseCaTotal=D.caY1+D.caY2+D.caY3;
  const baseResTotal=D.resY1+D.resY2+D.resY3;
  el('simTopCa3').textContent=fmt(caTotal);
  el('simTopCa3Sub').innerHTML='Base '+fmt(baseCaTotal)+' '+simDelta(caTotal,baseCaTotal);
  el('simTopCa3').parentElement.className='kpi '+(caTotal>=baseCaTotal*0.9?'green':'orange');
  el('simTopRes3').textContent=fmt(resTotal);
  el('simTopRes3Sub').innerHTML='Base '+fmt(baseResTotal)+' '+simDelta(resTotal,baseResTotal);
  el('simTopRes3').parentElement.className='kpi '+(resTotal>0?'green':resTotal>-100000?'orange':'red');
  el('simTopBfr').textContent=fmtCHF(Math.round(SIM.bfrMin));
  el('simTopBfrSub').textContent='Pire cas sur 36 mois';
  el('simTopBfr').parentElement.className='kpi '+(SIM.bfrMin>=0?'green':SIM.bfrMin>=-150000?'orange':'red');
  el('simTopTreso').textContent=fmtCHF(Math.round(SIM.tresoFinal));
  el('simTopTresoSub').textContent='Cumul fin M36';
  el('simTopTreso').parentElement.className='kpi '+(SIM.tresoFinal>0?'green':'red');
}

function updateSimCompare(){
  if(!SIM||!D)return;
  const el=id=>document.getElementById(id);
  const panel=el('simCompare'),grid=el('simCompareGrid');
  if(!panel||!grid)return;
  const params=getSimParams();
  const isBase=params.consult===BASE.consult&&params.fee===BASE.fee&&params.days===BASE.days&&params.assoc===BASE.assoc&&params.indep===BASE.indep&&params.interne===BASE.interne&&params.start===BASE.start&&params.occup===BASE.occup&&params.cashPct===BASE.cashPct&&params.delay===BASE.delay&&params.factoring===BASE.factoring&&params.extra===BASE.extra&&params.rc===BASE.rc&&(params.retro||40)===BASE.retro;
  if(isBase){panel.classList.remove('show');return;}
  panel.classList.add('show');
  const items=[
    {label:'CA total 3 ans',sim:SIM.caY1+SIM.caY2+SIM.caY3,base:D.caY1+D.caY2+D.caY3},
    {label:'R\u00e9sultat total',sim:SIM.resY1+SIM.resY2+SIM.resY3,base:D.resY1+D.resY2+D.resY3},
    {label:'BFR min',sim:SIM.bfrMin,base:D.bfrWorst},
    {label:'Tr\u00e9so M36',sim:SIM.tresoFinal,base:D.cashflow[35]},
    {label:'CA Y1',sim:SIM.caY1,base:D.caY1},
    {label:'CA Y3',sim:SIM.caY3,base:D.caY3}
  ];
  grid.innerHTML=items.map(item=>{
    const diff=item.sim-item.base;
    const pctDiff=item.base?Math.round((diff/Math.abs(item.base))*100):0;
    const cls=Math.abs(pctDiff)<1?'neutral':diff>0?'up':'down';
    return '<div class="sim-compare-item"><div class="scl">'+item.label+'</div><div class="scv '+cls+'">'+(diff>=0?'+':'')+fmt(diff)+' ('+(pctDiff>=0?'+':'')+pctDiff+'%)</div></div>';
  }).join('');
}

function runSim(){
  const el=id=>document.getElementById(id);
  const params = getSimParams();

  el('sConsultVal').textContent=params.consult; el('sFeeVal').textContent=params.fee; el('sDaysVal').textContent=params.days;
  el('sAssocVal').textContent=params.assoc; el('sIndepVal').textContent=params.indep; el('sInterneVal').textContent=params.interne;
  el('sStartVal').textContent=params.start; el('sOccupVal').textContent=params.occup+'%';
  el('sCashVal').textContent=params.cashPct+'%';
  el('sRetroVal').textContent=params.retro+'%';
  el('sExtraVal').textContent=fmt(params.extra); el('sRCVal').textContent=fmt(params.rc);

  const sim = computeSimulation(params);
  const simCA=sim.ca, simResult=sim.result, simCashflow=sim.cashflow;
  const simCaY1=sim.caY1, simCaY2=sim.caY2, simCaY3=sim.caY3;
  const simResY1=sim.resY1, simResY2=sim.resY2, simResY3=sim.resY3;
  const simResAdj=sim.resAdj, simPerAssoc=sim.perAssoc;

  SIM={ca:simCA,result:simResult,cashflow:simCashflow,caY1:simCaY1,caY2:simCaY2,caY3:simCaY3,resY1:simResY1,resY2:simResY2,resY3:simResY3,bfrMin:Math.min(...simCashflow),tresoFinal:simCashflow[35]};

  // Populate year overview timeline
  el('simOvCaY1').textContent='CA '+fmt(simCaY1);
  el('simOvResY1').innerHTML='R\u00e9s. '+fmt(simResY1);
  el('simOvDeltaY1').innerHTML=simDelta(simCaY1,D?D.caY1:1);
  el('simOvCaY2').textContent='CA '+fmt(simCaY2);
  el('simOvResY2').innerHTML='R\u00e9s. '+fmt(simResY2);
  el('simOvDeltaY2').innerHTML=simDelta(simCaY2,D?D.caY2:1);
  el('simOvCaY3').textContent='CA '+fmt(simCaY3);
  el('simOvResY3').innerHTML='R\u00e9s. '+fmt(simResY3);
  el('simOvDeltaY3').innerHTML=simDelta(simCaY3,D?D.caY3:1);

  // Structured per-year summary
  const summaryData = [
    {year:'1',cls:'y1',ca:simCaY1,res:simResY1,notes:[
      'D\u00e9but activit\u00e9 mois '+params.start+', occupation '+params.occup+'%',
      params.delay>=3?'<strong style="color:var(--danger)">\u26a0 D\u00e9lai '+params.delay+'m impacte la tr\u00e9so Y1</strong>':'D\u00e9lai paiement '+params.delay+' mois',
      params.factoring?'Factoring actif \u2014 BFR s\u00e9curis\u00e9':'Sans factoring',
      'Tr\u00e9so min : '+fmtCHF(Math.min(...simCashflow.slice(0,12)))]},
    {year:'2',cls:'y2',ca:simCaY2,res:simResY2,notes:[
      'Mont\u00e9e en puissance \u2014 occupation ~'+Math.round(Math.min(100,params.occup+(100-params.occup)*0.6))+'%',
      'CA : '+fmtCHF(simCaY2)+(simCaY1>0?' (+'+Math.round((simCaY2/simCaY1-1)*100)+'% vs Y1)':''),
      'R\u00e9sultat : '+fmtCHF(simResY2)]},
    {year:'3',cls:'y3',ca:simCaY3,res:simResY3,notes:[
      'Vitesse de croisi\u00e8re \u2014 pleine capacit\u00e9',
      'CA : '+fmtCHF(simCaY3),
      'R\u00e9sultat ajust\u00e9 : '+fmtCHF(simResAdj)+' (apr\u00e8s '+fmt(params.extra)+' charges + '+fmt(params.rc)+' RC)',
      'Par associ\u00e9 : '+fmtCHF(simPerAssoc),
      'Tr\u00e9so finale : '+fmtCHF(simCashflow[35])]}
  ];
  const simPhases=['<span class="sim-phase start">D\u00e9marrage</span>','<span class="sim-phase grow">Croissance</span>','<span class="sim-phase cruise">Croisi\u00e8re</span>'];
  el('simSummary').innerHTML=summaryData.map((s,i)=>
    '<div class="sim-summary-yr '+s.cls+'"><h4>Ann\u00e9e '+s.year+simPhases[i]+' \u2014 CA '+fmt(s.ca)+' | R\u00e9s. '+fmt(s.res)+'</h4><ul>'+
    s.notes.map(n=>'<li>'+n+'</li>').join('')+'</ul></div>'
  ).join('');

  updateSimVerdict();
  updateSimTopKpis();
  updateSimCompare();
  updateSimYearDetail();
  updateSimCharts();
}

// ===== YEAR TAB SWITCHING =====
function switchSimYear(year, btn) {
  simActiveYear = year;
  document.querySelectorAll('.sim-tab').forEach(t=>t.classList.remove('active'));
  if(btn) btn.classList.add('active');
  document.querySelectorAll('.sim-year-overview .profit-yr').forEach(c=>c.classList.remove('highlight'));
  if(year!=='all'){
    const card=document.getElementById('simYrCard'+year);
    if(card) card.classList.add('highlight');
  }
  updateSimYearDetail();
  updateSimCharts();
}

function updateSimYearDetail() {
  if(!SIM) return;
  const el=id=>document.getElementById(id);
  const params=getSimParams();
  const year=simActiveYear;
  const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);

  const perYear={
    '1':{ca:SIM.caY1,res:SIM.resY1,s:0,e:12},
    '2':{ca:SIM.caY2,res:SIM.resY2,s:12,e:24},
    '3':{ca:SIM.caY3,res:SIM.resY3,s:24,e:36}
  };
  for(const k of['1','2','3']){
    const y=perYear[k];
    y.resAdj=y.res-(params.extra+params.rc)/3;
    y.perAssoc=y.resAdj/params.assoc;
    y.tresoMin=Math.min(...SIM.cashflow.slice(y.s,y.e));
    y.tresoEnd=SIM.cashflow[y.e-1];
    y.baseCa=D?(k==='1'?D.caY1:k==='2'?D.caY2:D.caY3):0;
    y.baseRes=D?(k==='1'?D.resY1:k==='2'?D.resY2:D.resY3):0;
  }

  // Verdict
  const verdictEl=el('simYearVerdict');
  if(year==='all'){
    verdictEl.style.display='none';
  } else {
    verdictEl.style.display='';
    const y=perYear[year];
    let cls,icon,text;
    if(year==='1'){
      const isBfrRisk=y.tresoMin<-100000;
      cls=isBfrRisk?'red':y.res<0?'orange':'green';
      icon=isBfrRisk?'\u26a0\ufe0f':'\u2699\ufe0f';
      text='<strong>Ann\u00e9e 1 \u2014 D\u00e9marrage.</strong> Phase de mont\u00e9e en charge'
        +(params.start>1?' (d\u00e9but mois '+params.start+')':'')+', occupation \u00e0 '+params.occup+'%.'
        +(params.delay>=3?' <strong>Le d\u00e9lai de paiement de '+params.delay+' mois impacte fortement la tr\u00e9sorerie Y1.</strong>':'')
        +(isBfrRisk?' <span style="color:var(--danger)">Risque BFR : tr\u00e9sorerie min '+fmtCHF(y.tresoMin)+'</span>':'')
        +' R\u00e9sultat attendu : '+fmtCHF(y.res)+'.';
    } else if(year==='2'){
      cls=y.res>0?'green':'orange';
      icon='\ud83d\udcc8';
      text='<strong>Ann\u00e9e 2 \u2014 Croissance.</strong> Occupation en hausse vers ~'
        +Math.round(Math.min(100,params.occup+(100-params.occup)*0.6))+'%. '
        +'Le d\u00e9lai de paiement n\'impacte plus la tr\u00e9sorerie. '
        +'R\u00e9sultat attendu : '+fmtCHF(y.res)+'.';
    } else {
      cls=y.resAdj>0?'green':y.res>0?'orange':'red';
      icon='\u2705';
      text='<strong>Ann\u00e9e 3 \u2014 Vitesse de croisi\u00e8re.</strong> Pleine capacit\u00e9, '
        +params.assoc+' associ\u00e9'+(params.assoc>1?'s':'')+'. R\u00e9sultat ajust\u00e9 : '+fmtCHF(y.resAdj)
        +', soit '+fmtCHF(y.perAssoc)+' par associ\u00e9.';
    }
    verdictEl.className='verdict '+cls;
    verdictEl.innerHTML='<div class="ic">'+icon+'</div><div>'+text+'</div>';
  }

  // KPIs
  const kpiC=el('simYearKpis');
  if(year==='all'){
    let html='';
    for(const k of['1','2','3']){
      const y=perYear[k];
      const caC=y.ca>y.baseCa*0.9?'green':'orange';
      const resC=y.res>0?'green':y.res>-50000?'orange':'red';
      html+='<div class="kpi '+caC+'"><div class="lb">CA Ann\u00e9e '+k+'</div><div class="vl">'+fmt(y.ca)+'</div><div class="sb">vs base '+fmt(y.baseCa)+' '+simDelta(y.ca,y.baseCa)+'</div></div>';
      html+='<div class="kpi '+resC+'"><div class="lb">R\u00e9sultat Y'+k+'</div><div class="vl">'+fmt(y.res)+'</div><div class="sb">vs base '+fmt(y.baseRes)+' '+simDelta(y.res,y.baseRes)+'</div></div>';
    }
    kpiC.innerHTML=html;
  } else {
    const y=perYear[year];
    const caC=y.ca>y.baseCa*0.9?'green':'orange';
    const resC=y.res>0?'green':y.res>-50000?'orange':'red';
    const adjC=y.resAdj>0?'green':'orange';
    const tresoC=y.tresoMin>=0?'green':y.tresoMin>-250000?'orange':'red';
    kpiC.innerHTML=
      '<div class="kpi '+caC+'"><div class="lb">CA Ann\u00e9e '+year+'</div><div class="vl">'+fmt(y.ca)+'</div><div class="sb">vs base '+fmt(y.baseCa)+' '+simDelta(y.ca,y.baseCa)+'</div></div>'+
      '<div class="kpi '+resC+'"><div class="lb">R\u00e9sultat brut Y'+year+'</div><div class="vl">'+fmt(y.res)+'</div><div class="sb">vs base '+fmt(y.baseRes)+' '+simDelta(y.res,y.baseRes)+'</div></div>'+
      '<div class="kpi '+adjC+'"><div class="lb">R\u00e9sultat ajust\u00e9 Y'+year+'</div><div class="vl">'+fmt(y.resAdj)+'</div><div class="sb">Apr\u00e8s charges + RC (prorata)</div></div>'+
      '<div class="kpi blue"><div class="lb">Par associ\u00e9 Y'+year+'</div><div class="vl">'+fmt(y.perAssoc)+'</div><div class="sb">'+params.assoc+' associ\u00e9'+(params.assoc>1?'s':'')+'</div></div>'+
      '<div class="kpi '+tresoC+'"><div class="lb">Tr\u00e9so min Y'+year+'</div><div class="vl">'+fmt(y.tresoMin)+'</div><div class="sb">Point le plus bas</div></div>'+
      '<div class="kpi blue"><div class="lb">Tr\u00e9so fin Y'+year+'</div><div class="vl">'+fmt(y.tresoEnd)+'</div><div class="sb">Cumul fin de p\u00e9riode</div></div>';
  }

  // Sensitivity tags
  const sensEl=el('simSensitivity');
  if(year==='all'){sensEl.innerHTML='';return;}
  sensEl.innerHTML=getYearSensitivity(year,params).map(t=>
    '<span class="sens-tag '+t.level+'">'+t.label+'</span>'
  ).join('');
}

function getYearSensitivity(year, params) {
  const tags=[];
  if(year==='1'){
    tags.push({label:'\u26a0 D\u00e9lai paiement : impact '+(params.delay>=3?'FORT':'mod\u00e9r\u00e9'),level:params.delay>=3?'high':params.delay>=1?'medium':'low'});
    tags.push({label:'\ud83d\ude80 Mois d\u00e9but ('+params.start+') : impact '+(params.start>6?'FORT':params.start>3?'mod\u00e9r\u00e9':'faible'),level:params.start>6?'high':params.start>3?'medium':'low'});
    tags.push({label:'\ud83d\udcca Occupation '+params.occup+'% : impact FORT',level:params.occup<50?'high':params.occup<70?'medium':'low'});
    tags.push(params.factoring?{label:'\u2705 Factoring actif : s\u00e9curise BFR',level:'low'}:{label:'\u26a0 Sans factoring : risque BFR',level:'high'});
    tags.push({label:'\ud83c\udfe5 Cash OI '+params.cashPct+'% : impact moyen',level:params.cashPct>20?'low':'medium'});
  } else if(year==='2'){
    tags.push({label:'\ud83d\udcc8 Volume (consult/honor.) : levier principal',level:'medium'});
    tags.push({label:'\ud83d\udc65 \u00c9quipe ('+(params.assoc+params.indep+params.interne)+' m\u00e9d.) : impact croissant',level:'medium'});
    tags.push({label:'\u23f0 D\u00e9lai paiement : faible impact',level:'low'});
    tags.push({label:'\ud83d\udcb0 Charges extra : impact '+(params.extra>200000?'mod\u00e9r\u00e9':'faible'),level:params.extra>200000?'medium':'low'});
  } else {
    tags.push({label:'\ud83d\udcc8 Volume (consult/honor.) : levier principal',level:'medium'});
    tags.push({label:'\ud83d\udc65 \u00c9quipe ('+(params.assoc+params.indep+params.interne)+' m\u00e9d.) : levier principal',level:'medium'});
    tags.push({label:'\ud83d\udcb0 Charges extra '+fmt(params.extra)+' : impact direct',level:params.extra>300000?'high':'medium'});
    tags.push({label:'\u23f0 D\u00e9lai paiement : aucun impact',level:'low'});
  }
  return tags;
}

// ===== SIM CHARTS =====
const yearHighlightPlugin={id:'yearHL',beforeDraw(chart){
  if(simActiveYear==='all')return;
  const ctx=chart.ctx,x=chart.scales.x,y=chart.scales.y;
  const yi=parseInt(simActiveYear);
  const s=(yi-1)*12, e=yi*12-1;
  if(s>x.max||e<x.min)return;
  const xS=x.getPixelForValue(Math.max(s,x.min)), xE=x.getPixelForValue(Math.min(e,x.max));
  ctx.save();
  ctx.fillStyle='rgba(26,74,122,.04)';
  ctx.fillRect(xS,y.top,xE-xS,y.bottom-y.top);
  ctx.fillStyle='rgba(26,74,122,.5)';
  ctx.font='bold 11px Inter,sans-serif';
  ctx.fillText('Ann\u00e9e '+simActiveYear,xS+4,y.top+14);
  ctx.restore();
}};

function updateSimCharts(){
  if(!SIM)return;
  try{charts.sim1?.destroy()}catch(e){}
  try{charts.sim2?.destroy()}catch(e){}

  const bA=simActiveYear==='all'?[.7,.7,.7]:['1','2','3'].map(y=>y===simActiveYear?.9:.15);
  const bB=simActiveYear==='all'?[.2,.2,.2]:['1','2','3'].map(y=>y===simActiveYear?.3:.06);

  charts.sim1=new Chart(document.getElementById('cSim1'),{type:'bar',data:{labels:['Ann\u00e9e 1','Ann\u00e9e 2','Ann\u00e9e 3'],datasets:[
    {label:"CA simul\u00e9",data:[SIM.caY1,SIM.caY2,SIM.caY3],backgroundColor:bA.map(a=>'rgba(26,74,122,'+a+')'),borderRadius:8,barPercentage:.5},
    {label:'CA base',data:[D.caY1,D.caY2,D.caY3],backgroundColor:bB.map(a=>'rgba(26,74,122,'+a+')'),borderRadius:8,barPercentage:.5,borderWidth:1,borderColor:'rgba(26,74,122,.4)',borderDash:[4,4]},
    {label:'R\u00e9sultat simul\u00e9',data:[SIM.resY1,SIM.resY2,SIM.resY3],backgroundColor:bA.map(a=>'rgba(0,184,148,'+a+')'),borderRadius:8,barPercentage:.5},
    {label:'R\u00e9sultat base',data:[D.resY1,D.resY2,D.resY3],backgroundColor:bB.map(a=>'rgba(0,184,148,'+a+')'),borderRadius:8,barPercentage:.5,borderWidth:1,borderColor:'rgba(0,184,148,.4)'}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}}});

  charts.sim2=new Chart(document.getElementById('cSim2'),{type:'line',data:{labels:labelsQ,datasets:[
    {label:'Tr\u00e9sorerie simul\u00e9e',data:SIM.cashflow,borderColor:'#1a4a7a',backgroundColor:'rgba(26,74,122,.06)',fill:true,tension:.3,pointRadius:0,borderWidth:2.5},
    {label:'Tr\u00e9sorerie base',data:D.cashflow,borderColor:'#b2bec3',tension:.3,pointRadius:0,borderWidth:1.5,borderDash:[4,4]},
    {label:'Seuil 0',data:Array(36).fill(0),borderColor:'rgba(214,48,49,.3)',borderWidth:1,pointRadius:0,borderDash:[2,2]}
  ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:12}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}},plugins:[yearPlugin,yearHighlightPlugin]});
}

// ===== SCENARIO SAVE/LOAD =====
async function saveScenario() {
  const name = prompt('Nom du sc\u00e9nario :');
  if (!name) return;
  try {
    await api('/scenarios', {
      method: 'POST',
      body: JSON.stringify({
        name,
        params: getSimParams(),
        businessPlanId: currentPlanId || undefined,
      }),
    });
    refreshOverlayScenarios();
  } catch(err) {
    console.error('Save scenario error:', err);
  }
}

async function toggleScenarioList() {
  const list = document.getElementById('scenarioList');
  if (list.classList.contains('show')) {
    list.classList.remove('show');
    return;
  }
  try {
    const result = await api('/scenarios');
    list.innerHTML = result.scenarios.map(s =>
      '<div class="scenario-item" onclick="loadScenario(\''+s.id+'\')">'+
        '<span>'+s.name+'</span>'+
        '<button class="del" onclick="event.stopPropagation();deleteScenario(\''+s.id+'\')">\u2717</button>'+
      '</div>'
    ).join('') || '<div class="scenario-item">Aucun sc\u00e9nario sauvegard\u00e9</div>';
    list.classList.add('show');
  } catch(err) {
    console.error('Load scenarios error:', err);
  }
}

async function loadScenario(id) {
  try {
    const result = await api('/scenarios/' + id);
    setSimParams(result.scenario.params);
    document.getElementById('scenarioList').classList.remove('show');
  } catch(err) {
    console.error('Load scenario error:', err);
  }
}

async function deleteScenario(id) {
  try {
    await api('/scenarios/' + id, { method: 'DELETE' });
    toggleScenarioList(); // refresh
    toggleScenarioList();
  } catch(err) {
    console.error('Delete scenario error:', err);
  }
}

// ===== ADMIN =====
async function loadAdminData() {
  try {
    const result = await api('/admin/users');
    const list = document.getElementById('adminEmailList');
    list.innerHTML = result.allowedEmails.map(e =>
      '<li><span>'+e.email+'</span>' +
      (e.email !== currentUser?.email ?
        '<button class="btn-reset" onclick="removeAllowedEmail(\''+e.email+'\')">\u2717 Retirer</button>' :
        '<span style="font-size:.7rem;color:var(--txtL)">(vous)</span>') +
      '</li>'
    ).join('');
  } catch(err) {
    console.error('Admin load error:', err);
  }
}

async function addAllowedEmail() {
  const input = document.getElementById('adminNewEmail');
  const email = input.value.trim();
  if (!email) return;
  try {
    await api('/admin/users', {
      method: 'POST',
      body: JSON.stringify({ email }),
    });
    input.value = '';
    loadAdminData();
  } catch(err) {
    console.error('Add email error:', err);
  }
}

async function removeAllowedEmail(email) {
  try {
    await api('/admin/users?email=' + encodeURIComponent(email), { method: 'DELETE' });
    loadAdminData();
  } catch(err) {
    console.error('Remove email error:', err);
  }
}

// ===== SCENARIO OVERLAY =====
async function refreshOverlayScenarios() {
  try {
    const result = await api('/scenarios');
    const select = document.getElementById('overlayScenarioSelect');
    const current = select.value;
    select.innerHTML = '<option value="">Aucun (d\u00e9sactiv\u00e9)</option>';
    (result.scenarios || []).forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.name;
      select.appendChild(opt);
    });
    if (current) select.value = current;
    document.getElementById('overlayControl').style.display = (result.scenarios && result.scenarios.length > 0) ? 'flex' : 'none';
  } catch(err) {
    console.error('Load overlay scenarios error:', err);
  }
}

async function applyScenarioOverlay() {
  const scenarioId = document.getElementById('overlayScenarioSelect').value;
  const dot = document.getElementById('overlayDot');
  if (!scenarioId) {
    OVERLAY = null;
    overlayScenarioId = null;
    dot.classList.remove('active');
    updateCharts();
    return;
  }
  try {
    const result = await api('/scenarios/' + scenarioId);
    const sim = computeSimulation(result.scenario.params);
    OVERLAY = sim;
    overlayScenarioId = scenarioId;
    dot.classList.add('active');
    updateCharts();
  } catch(err) {
    console.error('Apply overlay error:', err);
  }
}

// ===== VERSION COMPARISON =====
let compareCharts = {};

async function openCompare() {
  const modal = document.getElementById('compareModal');
  modal.classList.add('open');
  document.getElementById('compareContent').innerHTML = '';
  // Destroy old compare charts
  Object.values(compareCharts).forEach(c => { try{c.destroy()}catch(e){} });
  compareCharts = {};
  // Populate selects
  try {
    const result = await api('/plans/' + currentPlanId + '/versions');
    const versions = result.versions || [];
    const leftSel = document.getElementById('compareLeft');
    const rightSel = document.getElementById('compareRight');
    const currentOpt = '<option value="current">Donn\u00e9es actuelles</option>';
    const versionOpts = versions.map(v => {
      const d = new Date(v.createdAt).toLocaleDateString('fr-CH',{day:'numeric',month:'short'});
      return '<option value="'+v.id+'">v'+v.versionNumber+' \u2014 '+escHTML(v.label||'Sans label')+' ('+d+')</option>';
    }).join('');
    leftSel.innerHTML = currentOpt + versionOpts;
    rightSel.innerHTML = currentOpt + versionOpts;
    if (versions.length > 0) rightSel.value = versions[0].id;
  } catch(err) {
    console.error('Open compare error:', err);
  }
}

function closeCompare() {
  document.getElementById('compareModal').classList.remove('open');
  Object.values(compareCharts).forEach(c => { try{c.destroy()}catch(e){} });
  compareCharts = {};
}

async function fetchVersionData(val) {
  if (val === 'current') {
    const d = JSON.parse(JSON.stringify(D));
    const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
    d.caY1=sum(d.ca,0,12);d.caY2=sum(d.ca,12,24);d.caY3=sum(d.ca,24,36);
    d.resY1=sum(d.result,0,12);d.resY2=sum(d.result,12,24);d.resY3=sum(d.result,24,36);
    return d;
  }
  const result = await api('/plans/' + currentPlanId + '/versions/' + val);
  const v = result.version;
  const d = { ...v.data, ...(v.constants || {}) };
  const sum=(arr,s,e)=>arr.slice(s,e).reduce((a,b)=>a+b,0);
  d.caY1=sum(d.ca,0,12);d.caY2=sum(d.ca,12,24);d.caY3=sum(d.ca,24,36);
  d.resY1=sum(d.result,0,12);d.resY2=sum(d.result,12,24);d.resY3=sum(d.result,24,36);
  return d;
}

async function runCompare() {
  try {
    const leftVal = document.getElementById('compareLeft').value;
    const rightVal = document.getElementById('compareRight').value;
    const left = await fetchVersionData(leftVal);
    const right = await fetchVersionData(rightVal);

    // Build comparison grid
    const metrics = [
      {label:'CA Ann\u00e9e 1',l:left.caY1,r:right.caY1},
      {label:'CA Ann\u00e9e 2',l:left.caY2,r:right.caY2},
      {label:'CA Ann\u00e9e 3',l:left.caY3,r:right.caY3},
      {label:'R\u00e9sultat Ann\u00e9e 1',l:left.resY1,r:right.resY1},
      {label:'R\u00e9sultat Ann\u00e9e 2',l:left.resY2,r:right.resY2},
      {label:'R\u00e9sultat Ann\u00e9e 3',l:left.resY3,r:right.resY3},
      {label:'CAPEX',l:left.capex||0,r:right.capex||0},
      {label:'Honoraires (CHF)',l:left.fee||0,r:right.fee||0},
      {label:'Consult./jour',l:left.consultDay||0,r:right.consultDay||0},
      {label:'ETP max',l:Math.max(...(left.fteTotal||[0])),r:Math.max(...(right.fteTotal||[0]))},
    ];

    function deltaHTML(l,r) {
      if (!l && !r) return '<span class="delta-badge zero">=</span>';
      const d = l ? ((r/l-1)*100) : (r ? 100 : 0);
      if (Math.abs(d) < 0.5) return '<span class="delta-badge zero">=</span>';
      return '<span class="delta-badge '+(d>0?'pos':'neg')+'">'+(d>0?'+':'')+d.toFixed(0)+'%</span>';
    }

    let html = '<div class="compare-grid">';
    html += '<div class="cg-head">M\u00e9trique</div><div class="cg-head">Gauche</div><div class="cg-head">Droite</div><div class="cg-head">Delta</div>';
    metrics.forEach(m => {
      html += '<div class="cg-cell label">'+m.label+'</div>';
      html += '<div class="cg-cell num">'+fmtCHF(m.l)+'</div>';
      html += '<div class="cg-cell num">'+fmtCHF(m.r)+'</div>';
      html += '<div class="cg-cell num">'+deltaHTML(m.l,m.r)+'</div>';
    });
    html += '</div>';
    document.getElementById('compareContent').innerHTML = html;

    // Charts
    Object.values(compareCharts).forEach(c => { try{c.destroy()}catch(e){} });

    compareCharts.overview = new Chart(document.getElementById('cCompareOverview'),{type:'bar',data:{labels:['Ann\u00e9e 1','Ann\u00e9e 2','Ann\u00e9e 3'],datasets:[
      {label:'CA gauche',data:[left.caY1,left.caY2,left.caY3],backgroundColor:'rgba(26,74,122,.8)',borderRadius:6,barPercentage:.5},
      {label:'CA droite',data:[right.caY1,right.caY2,right.caY3],backgroundColor:'rgba(26,74,122,.3)',borderRadius:6,barPercentage:.5,borderWidth:2,borderColor:'rgba(26,74,122,.6)',borderDash:[4,4]},
      {label:'R\u00e9s. gauche',data:[left.resY1,left.resY2,left.resY3],backgroundColor:'rgba(0,184,148,.8)',borderRadius:6,barPercentage:.5},
      {label:'R\u00e9s. droite',data:[right.resY1,right.resY2,right.resY3],backgroundColor:'rgba(0,184,148,.3)',borderRadius:6,barPercentage:.5,borderWidth:2,borderColor:'rgba(0,184,148,.6)',borderDash:[4,4]}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:10,font:{size:11}}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}}});

    compareCharts.cashflow = new Chart(document.getElementById('cCompareCashflow'),{type:'line',data:{labels:labelsQ,datasets:[
      {label:'Cashflow gauche',data:left.cashflow,borderColor:'#1a4a7a',tension:.3,pointRadius:0,borderWidth:2.5,fill:false},
      {label:'Cashflow droite',data:right.cashflow,borderColor:'#d63031',tension:.3,pointRadius:0,borderWidth:2.5,borderDash:[6,3],fill:false},
      {label:'Seuil 0',data:Array(36).fill(0),borderColor:'rgba(99,110,114,.2)',borderWidth:1,pointRadius:0,borderDash:[2,2]}
    ]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top',labels:{usePointStyle:true,padding:10,font:{size:11}}}},scales:{y:{grid:gridOpts,ticks:{callback:v=>fmt(v)}},x:{grid:{display:false}}}},plugins:[yearPlugin]});

  } catch(err) {
    console.error('Run compare error:', err);
    document.getElementById('compareContent').innerHTML = '<div style="color:var(--danger);padding:1rem">Erreur lors de la comparaison : '+escHTML(err.message || 'Erreur inconnue')+'</div>';
  }
}

function printCompare() {
  const app = document.getElementById('app-content');
  const modal = document.getElementById('compareModal');
  const sidebar = document.getElementById('sidebar');
  // Hide everything except compare modal
  app.style.display = 'none';
  sidebar.style.display = 'none';
  modal.style.position = 'static';
  document.body.appendChild(modal);
  window.print();
  // Restore
  document.getElementById('app-content').insertBefore(modal, document.querySelector('#app-content > :last-child'));
  app.style.display = '';
  sidebar.style.display = '';
  modal.style.position = '';
}

// ===== PLAN SWITCHER =====
async function loadPlanList() {
  try {
    const result = await api('/plans');
    allPlans = result.plans || [];
    renderPlanDropdown();
    updatePlanNameDisplay();
  } catch(err) {
    console.error('Load plan list error:', err);
  }
}

function renderPlanDropdown() {
  const container = document.getElementById('planListItems');
  if (!container) return;
  container.innerHTML = allPlans.map(p => {
    const isActive = p.id === currentPlanId;
    const date = new Date(p.updatedAt || p.createdAt).toLocaleDateString('fr-CH', {day:'numeric',month:'short',year:'numeric'});
    return '<div class="pd-item'+(isActive?' active':'')+'" onclick="switchPlan(\''+p.id+'\')">'+
      '<div class="pd-info">'+
        '<div class="pd-plan-name">'+escHTML(p.name)+'</div>'+
        '<div class="pd-date">Modifi\u00e9 le '+date+'</div>'+
      '</div>'+
      '<div class="pd-actions">'+
        '<button class="pd-btn" onclick="event.stopPropagation();renamePlan(\''+p.id+'\',\''+escHTML(p.name)+'\')" title="Renommer">\u270F</button>'+
        (allPlans.length > 1 ? '<button class="pd-btn del" onclick="event.stopPropagation();deletePlan(\''+p.id+'\')" title="Supprimer">\u2717</button>' : '')+
      '</div>'+
    '</div>';
  }).join('');
}

function escHTML(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function updatePlanNameDisplay() {
  const el = document.getElementById('planNameDisplay');
  if (!el) return;
  const plan = allPlans.find(p => p.id === currentPlanId);
  el.textContent = plan ? plan.name : 'Plan';
}

function togglePlanDropdown() {
  const dd = document.getElementById('planDropdown');
  dd.classList.toggle('show');
  if (dd.classList.contains('show')) {
    loadPlanList();
    const close = function(e) {
      if (!document.getElementById('planSwitcher').contains(e.target)) {
        dd.classList.remove('show');
        document.removeEventListener('click', close);
      }
    };
    setTimeout(() => document.addEventListener('click', close), 0);
  }
}

async function switchPlan(planId) {
  if (planId === currentPlanId) {
    document.getElementById('planDropdown').classList.remove('show');
    return;
  }
  try {
    const fullPlan = await api('/plans/' + planId);
    currentPlanId = planId;
    D = { ...fullPlan.plan.data, consultDay: fullPlan.plan.consultDay, fee: fullPlan.plan.fee, daysYear: fullPlan.plan.daysYear, revSpec: fullPlan.plan.revSpec, capex: fullPlan.plan.capex };
    computeDerived();
    updateUI();
    runSim();
    updatePlanNameDisplay();
    renderPlanDropdown();
    // Reset import summary and overlay
    document.getElementById('importSummary').classList.remove('show');
    document.getElementById('planDropdown').classList.remove('show');
    OVERLAY = null;
    overlayScenarioId = null;
    const ovSelect = document.getElementById('overlayScenarioSelect');
    if (ovSelect) ovSelect.value = '';
    document.getElementById('overlayDot').classList.remove('active');
    refreshOverlayScenarios();
    // Update status bar
    const plan = allPlans.find(p => p.id === planId);
    document.getElementById('statusLabel').textContent = 'Plan : ' + (plan ? plan.name : 'Charg\u00e9');
  } catch(err) {
    console.error('Switch plan error:', err);
  }
}

async function createNewPlan() {
  const name = prompt('Nom du nouveau plan :');
  if (!name || !name.trim()) return;
  try {
    const result = await api('/plans', {
      method: 'POST',
      body: JSON.stringify({ name: name.trim() }),
    });
    await loadPlanList();
    await switchPlan(result.plan.id);
  } catch(err) {
    console.error('Create plan error:', err);
  }
}

async function renamePlan(planId, currentName) {
  const name = prompt('Nouveau nom :', currentName);
  if (!name || !name.trim() || name.trim() === currentName) return;
  try {
    await api('/plans/' + planId, {
      method: 'PUT',
      body: JSON.stringify({ name: name.trim() }),
    });
    await loadPlanList();
  } catch(err) {
    console.error('Rename plan error:', err);
  }
}

async function deletePlan(planId) {
  if (allPlans.length <= 1) return;
  if (!confirm('Supprimer ce plan ? Cette action est irr\u00e9versible.')) return;
  try {
    await api('/plans/' + planId, { method: 'DELETE' });
    if (planId === currentPlanId) {
      await loadPlanList();
      if (allPlans.length > 0) {
        await switchPlan(allPlans[0].id);
      }
    } else {
      await loadPlanList();
    }
  } catch(err) {
    console.error('Delete plan error:', err);
  }
}

// ===== EXPORT PDF =====
function exportPDF(){
  // Show all sections temporarily so Chart.js can render
  const sects=document.querySelectorAll('.section');
  const activeId=document.querySelector('.section.active')?.id||'overview';
  sects.forEach(s=>s.classList.add('active'));
  Object.values(charts).forEach(c=>{try{c.resize()}catch(e){}});
  setTimeout(()=>{
    try{_buildPDF();}catch(e){console.error('PDF error',e);alert('Erreur lors de la g\u00e9n\u00e9ration du PDF.');}
    // Restore original section
    sects.forEach(s=>s.classList.remove('active'));
    const el=document.getElementById(activeId);if(el)el.classList.add('active');
  },400);
}
function _buildPDF(){
  const{jsPDF}=window.jspdf;
  const doc=new jsPDF({unit:'mm',format:'a4'});
  const W=210,H=297,M=15,CW=W-2*M;
  const C={p:[15,43,70],pl:[26,74,122],acc:[0,184,148],warn:[253,203,110],dng:[214,48,49],txt:[45,52,54],txtL:[99,110,114]};
  const planName=(document.getElementById('planNameDisplay')?.textContent||'Business Plan').trim();
  const userName=currentUser?.name||'Utilisateur';
  const dateStr=new Date().toLocaleDateString('fr-CH',{day:'2-digit',month:'long',year:'numeric'});
  // --- helpers ---
  function rdV(id){const el=document.getElementById(id),t=document.getElementById(id+'Text');if(!el||!t)return{text:'',color:'green'};const cl=el.className;return{text:t.textContent.trim(),color:cl.includes('red')?'red':cl.includes('orange')?'orange':'green'};}
  function rdK(id){const el=document.getElementById(id);return el?el.textContent.trim():'\u2014';}
  function gImg(k){if(charts[k]){try{return charts[k].toBase64Image()}catch(e){}}return null;}
  const vBg={green:[230,248,243],orange:[254,245,231],red:[253,234,234]};
  const vCl={green:C.acc,orange:C.warn,red:C.dng};
  function footer(pg){doc.setDrawColor(...C.pl);doc.setLineWidth(0.3);doc.line(M,H-12,W-M,H-12);doc.setFontSize(7);doc.setTextColor(...C.txtL);doc.text(planName,M,H-8);doc.text(dateStr,W/2,H-8,{align:'center'});doc.text('Page '+pg+'',W-M,H-8,{align:'right'});}
  function title(y,t){doc.setFontSize(14);doc.setFont('helvetica','bold');doc.setTextColor(...C.p);doc.text(t,M,y);doc.setDrawColor(...C.acc);doc.setLineWidth(0.8);doc.line(M,y+2,M+40,y+2);doc.setFont('helvetica','normal');return y+8;}
  function verdict(y,v){const bg=vBg[v.color]||vBg.green,cl=vCl[v.color]||C.acc;doc.setFillColor(...bg);doc.roundedRect(M,y,CW,14,2,2,'F');doc.setFillColor(...cl);doc.rect(M,y,3,14,'F');doc.setFontSize(9);doc.setTextColor(...C.txt);const lines=doc.splitTextToSize(v.text,CW-10);doc.text(lines,M+6,y+5);return y+16;}
  function kpis(y,arr){const cw=(CW-9)/4;arr.forEach((k,i)=>{if(!k.label)return;const x=M+i*(cw+3);doc.setFillColor(248,250,252);doc.roundedRect(x,y,cw,18,1.5,1.5,'F');doc.setDrawColor(...C.pl);doc.setLineWidth(0.15);doc.roundedRect(x,y,cw,18,1.5,1.5,'S');doc.setFillColor(...C.pl);doc.rect(x,y,cw,1,'F');doc.setFontSize(6);doc.setTextColor(...C.txtL);doc.text(k.label,x+2,y+5);doc.setFontSize(11);doc.setFont('helvetica','bold');doc.setTextColor(...C.p);doc.text(k.value||'\u2014',x+2,y+12);doc.setFont('helvetica','normal');});return y+22;}
  function chart(y,key,h){h=h||70;const img=gImg(key);if(img){doc.addImage(img,'PNG',M,y,CW,h);}else{doc.setFontSize(8);doc.setTextColor(180,180,180);doc.text('[Graphique non disponible]',W/2,y+h/2,{align:'center'});}return y+h+4;}
  // --- page 1: cover ---
  doc.setFillColor(...C.p);doc.rect(0,0,W,H,'F');
  doc.setFillColor(...C.acc);doc.rect(0,0,W,4,'F');doc.rect(0,H-4,W,4,'F');
  doc.setFillColor(...C.acc);doc.circle(W/2,80,12,'F');
  doc.setFontSize(16);doc.setFont('helvetica','bold');doc.setTextColor(255,255,255);doc.text('G',W/2,85,{align:'center'});
  doc.setFontSize(28);doc.text('GYNEVA',W/2,110,{align:'center'});
  doc.setFontSize(14);doc.setFont('helvetica','normal');doc.setTextColor(...C.acc);doc.text('Business Plan',W/2,120,{align:'center'});
  doc.setFontSize(16);doc.setTextColor(255,255,255);doc.text(planName,W/2,145,{align:'center'});
  doc.setDrawColor(...C.acc);doc.setLineWidth(0.5);doc.line(W/2-30,155,W/2+30,155);
  doc.setFontSize(11);doc.setTextColor(200,210,220);doc.text(dateStr,W/2,170,{align:'center'});
  doc.text('Pr\u00e9par\u00e9 par : '+userName,W/2,180,{align:'center'});
  doc.setFontSize(7);doc.setTextColor(150,170,190);doc.text('Document confidentiel',W/2,H-10,{align:'center'});
  // --- page 2: overview ---
  doc.addPage();footer(2);
  let y=20;
  y=title(y,'Vue d\'ensemble');
  // Global score badge
  const gScore=document.getElementById('execScoreText')?.textContent||'?';
  doc.setFillColor(240,243,248);doc.roundedRect(M+45,y-7,35,8,2,2,'F');
  doc.setFontSize(8);doc.setFont('helvetica','bold');doc.setTextColor(...C.acc);doc.text('Score : '+gScore+'/100',M+47,y-2);doc.setFont('helvetica','normal');
  y+=4;
  y=verdict(y,rdV('ovVerdict'));
  y=kpis(y,[{label:'Investissement total',value:rdK('ovCapex')},{label:'CA Ann\u00e9e 3',value:rdK('ovCaY3')},{label:'R\u00e9sultat net Y3',value:rdK('ovResY3')},{label:'Marge nette Y3',value:rdK('ovMarginPct')}]);
  y=kpis(y,[{label:'Payback',value:rdK('ovPayback')},{label:'BFR minimum',value:rdK('ovBfr')},{label:'',value:''},{label:'',value:''}]);
  y=chart(y,'overview',65);
  // --- page 3: revenue ---
  doc.addPage();footer(3);y=20;
  y=title(y,'Chiffre d\'Affaires');
  y=verdict(y,rdV('revVerdict'));
  y=kpis(y,[{label:'Potentiel / sp\u00e9cialiste',value:rdK('revKpiSpec')},{label:'CA p\u00e9riode',value:rdK('revKpiCa')},{label:'Croissance',value:rdK('revKpiGrowth')},{label:'Diversification',value:rdK('revKpiDiversif')}]);
  y=chart(y,'revenue',70);
  // --- page 4: cashflow ---
  doc.addPage();footer(4);y=20;
  y=title(y,'Tr\u00e9sorerie');
  y=verdict(y,rdV('cfVerdict'));
  y=kpis(y,[{label:'Tr\u00e9so finale',value:rdK('cfTresoFin')},{label:'BFR minimum',value:rdK('cfBfrMin')},{label:'Mois critique',value:rdK('cfCritMonth')},{label:'Ratio E/S',value:rdK('cfRatio')}]);
  y=chart(y,'cashflow',55);
  y+=2;
  y=chart(y,'cashWaterfall',55);
  // --- page 5: team ---
  doc.addPage();footer(5);y=20;
  y=title(y,'\u00c9quipe');
  y=verdict(y,rdV('teamVerdict'));
  y=kpis(y,[{label:'ETP total',value:rdK('tEtp')},{label:'CA / ETP',value:rdK('tCaEtp')},{label:'Ratio admin',value:rdK('tRatio')},{label:'Croissance ETP',value:rdK('tGrowth')}]);
  y=chart(y,'team',70);
  // --- page 6: risks ---
  doc.addPage();footer(6);y=20;
  y=title(y,'Risques');
  // Risk gauge
  const rScore=parseInt(document.getElementById('riskScore')?.textContent)||0;
  const rGauge=document.getElementById('riskGauge');
  const rLevel=rGauge?.className.includes('high')?'red':rGauge?.className.includes('medium')?'orange':'green';
  const rSub=document.getElementById('riskSub')?.textContent||'';
  const rCol=vCl[rLevel]||C.acc;
  doc.setFillColor(245,247,250);doc.circle(M+15,y+12,10,'F');
  doc.setDrawColor(...rCol);doc.setLineWidth(2);doc.circle(M+15,y+12,10,'S');
  doc.setFontSize(14);doc.setFont('helvetica','bold');doc.setTextColor(...rCol);doc.text(rScore.toString(),M+15,y+14,{align:'center'});
  doc.setFontSize(9);doc.setTextColor(...C.txt);doc.text('Score risque : '+rScore+'/100',M+30,y+10);
  doc.setFontSize(7);doc.setFont('helvetica','normal');doc.setTextColor(...C.txtL);
  const rLines=doc.splitTextToSize(rSub,CW-35);doc.text(rLines,M+30,y+15);
  y+=30;
  y=kpis(y,[{label:'CA Y3 stress',value:rdK('rCaY3')},{label:'R\u00e9sultat Y3',value:rdK('rResY3')},{label:'BFR min',value:rdK('rBfrMin')},{label:'Tr\u00e9so finale',value:rdK('rTresoFinal')}]);
  y=chart(y,'riskStress',50);
  y+=2;
  y=chart(y,'charges',50);
  // --- page 7: profit ---
  doc.addPage();footer(7);y=20;
  y=title(y,'Profit Associ\u00e9s');
  y=verdict(y,rdV('profitVerdict'));
  y=kpis(y,[{label:'ROI cumul\u00e9 3 ans',value:rdK('pRoi')},{label:'Payback',value:rdK('pPayback')},{label:'R\u00e9sultat/associ\u00e9 Y3',value:rdK('pPerAssocY3')},{label:'Investissement/associ\u00e9',value:rdK('pInvestAssoc')}]);
  y=chart(y,'profit',55);
  y+=2;
  y=chart(y,'profitCumul',55);
  // --- page 8: optimize ---
  doc.addPage();footer(8);y=20;
  y=title(y,'Optimisations');
  y=verdict(y,rdV('optVerdict'));
  y=kpis(y,[{label:'BFR pire cas',value:rdK('optBfrWorst')},{label:'BFR actuel',value:rdK('optBfrCurrent')},{label:'BFR \u00e9conomis\u00e9',value:rdK('optBfrSaved')},{label:'Co\u00fbt factoring',value:rdK('optFactCost')}]);
  y=chart(y,'optimize',70);
  // --- save ---
  const safeName=planName.replace(/[^a-zA-Z0-9\u00e0-\u00fc]/g,'_');
  doc.save('GynEva_'+safeName+'_'+new Date().toISOString().slice(0,10)+'.pdf');
}

// ===== EXEC DASHBOARD =====
function toggleExecDash(){
  const d=document.getElementById('execDashboard');
  d.classList.toggle('collapsed');
  document.getElementById('execToggle').innerHTML=d.classList.contains('collapsed')?'&#9650;':'&#9660;';
  localStorage.setItem('execCollapsed',d.classList.contains('collapsed')?'1':'0');
}
function updateExecDashboard(){
  if(!D)return;
  const el=id=>document.getElementById(id);
  // 1. Score global — read verdict colors from DOM
  const verdictMap={ovVerdict:1,revVerdict:1,cfVerdict:1,teamVerdict:1,profitVerdict:1,optVerdict:1};
  let totalPts=0,maxPts=0;
  Object.keys(verdictMap).forEach(id=>{
    const v=el(id);if(!v)return;
    maxPts+=3;
    const cl=v.className;
    totalPts+=cl.includes('green')?3:cl.includes('orange')?2:1;
  });
  // Risk gauge: map low=3,medium=2,high=1
  const rg=el('riskGauge');
  if(rg){maxPts+=3;totalPts+=rg.className.includes('low')?3:rg.className.includes('medium')?2:1;}
  const score=maxPts>0?Math.round(totalPts/maxPts*100):0;
  // 2. SVG arc
  const arc=el('execArc');
  if(arc){
    const dash=Math.round(score/100*264);
    arc.setAttribute('stroke-dasharray',dash+' 264');
    arc.setAttribute('stroke',score>=70?'#00b894':score>=40?'#fdcb6e':'#d63031');
  }
  el('execScoreText').textContent=score;
  el('execScoreLabel').textContent=score>=70?'Viable':score>=40?'Sous conditions':'Risque \u00e9lev\u00e9';
  // 3. 10 KPIs
  const kpiData=[
    {l:'Investissement',v:el('ovCapex')?.textContent||'\u2014'},
    {l:'CA Y3',v:el('ovCaY3')?.textContent||'\u2014'},
    {l:'R\u00e9sultat Y3',v:el('ovResY3')?.textContent||'\u2014'},
    {l:'Marge nette',v:el('ovMarginPct')?.textContent||'\u2014'},
    {l:'Payback',v:el('ovPayback')?.textContent||'\u2014'},
    {l:'BFR min',v:el('ovBfr')?.textContent||'\u2014'},
    {l:'Tr\u00e9so M36',v:el('cfTresoFin')?.textContent||'\u2014'},
    {l:'ETP Y3',v:el('tEtp')?.textContent||'\u2014'},
    {l:'ROI 3 ans',v:el('pRoi')?.textContent||'\u2014'},
    {l:'Risque',v:(el('riskScore')?.textContent||'?')+'/100'},
  ];
  const kpiBox=el('execKpis');
  if(kpiBox){
    kpiBox.innerHTML=kpiData.map(k=>'<div class="exec-kpi"><div class="ek-label">'+k.l+'</div><div class="ek-value">'+k.v+'</div></div>').join('');
  }
  // 4. Sparkline
  if(charts.execSpark){try{charts.execSpark.destroy()}catch(e){}}
  const canvas=el('cExecSpark');
  if(canvas&&D.cashflow){
    charts.execSpark=new Chart(canvas,{
      type:'line',
      data:{labels:D.cashflow.map((_,i)=>i+1),datasets:[{data:D.cashflow,borderColor:'rgba(255,255,255,.8)',borderWidth:1.5,pointRadius:0,tension:.3,fill:{target:'origin',above:'rgba(255,255,255,.08)',below:'rgba(214,48,49,.15)'}}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}},animation:false}
    });
  }
  // 5. Sidebar badges
  const badgeMap={overview:'ovVerdict',revenue:'revVerdict',cashflow:'cfVerdict',team:'teamVerdict',profit:'profitVerdict',optimize:'optVerdict'};
  Object.entries(badgeMap).forEach(([sec,vid])=>{
    const badge=el('badge-'+sec);
    const v=el(vid);
    if(!badge||!v)return;
    const cl=v.className;
    const color=cl.includes('green')?'green':cl.includes('orange')?'orange':'red';
    badge.className='nav-badge '+color;
  });
  // Risk badge
  const rBadge=el('badge-risks');
  if(rBadge&&rg){
    const rc=rg.className;
    rBadge.className='nav-badge '+(rc.includes('low')?'green':rc.includes('medium')?'orange':'red');
  }
}

// ===== AUTH LOGIC (server-side sessions) =====
async function checkSession() {
  try {
    const result = await api('/auth/me');
    if (result.user) {
      grantAccess(result.user);
      return true;
    }
  } catch(e) {}
  return false;
}

async function grantAccess(user) {
  currentUser = user;
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app-content').style.display = 'block';

  // Restore exec dashboard collapsed state
  if(localStorage.getItem('execCollapsed')==='1'){const ed=document.getElementById('execDashboard');if(ed){ed.classList.add('collapsed');document.getElementById('execToggle').innerHTML='&#9650;';}}

  // Show admin nav if admin
  if (user.role === 'ADMIN') {
    document.getElementById('navAdmin').style.display = '';
  }

  // Add user badge in topbar
  const topbar = document.querySelector('.topbar .spacer');
  if (topbar && !document.getElementById('user-badge')) {
    const badge = document.createElement('div');
    badge.id = 'user-badge';
    badge.className = 'user-info';
    badge.innerHTML = (user.picture ? '<img src="'+user.picture+'" alt="">' : '') +
      '<span>'+user.name+'</span>' +
      '<button class="logout-btn" onclick="logout()">D\u00e9connexion</button>';
    topbar.parentNode.insertBefore(badge, topbar.nextSibling);
  }

  // Load plans from API
  try {
    const result = await api('/plans');
    if (result.plans && result.plans.length > 0) {
      const plan = result.plans[0];
      currentPlanId = plan.id;
      // Load full plan data
      const fullPlan = await api('/plans/' + plan.id);
      D = { ...fullPlan.plan.data, consultDay: fullPlan.plan.consultDay, fee: fullPlan.plan.fee, daysYear: fullPlan.plan.daysYear, revSpec: fullPlan.plan.revSpec, capex: fullPlan.plan.capex };
    } else {
      // Create default plan
      const newPlan = await api('/plans', {
        method: 'POST',
        body: JSON.stringify({ name: 'GYNEVA \u2014 Business Plan Initial' }),
      });
      currentPlanId = newPlan.plan.id;
      const fullPlan = await api('/plans/' + newPlan.plan.id);
      D = { ...fullPlan.plan.data, consultDay: fullPlan.plan.consultDay, fee: fullPlan.plan.fee, daysYear: fullPlan.plan.daysYear, revSpec: fullPlan.plan.revSpec, capex: fullPlan.plan.capex };
    }
  } catch(e) {
    console.error('Failed to load plans, using defaults:', e);
    // Fallback to inline defaults if API fails
    D = getDefaultData();
  }

  computeDerived();
  updateUI();
  runSim();
  loadPlanList();
  refreshOverlayScenarios();
}

function getDefaultData() {
  return {
    ca:[0,0,0,38313,108554,200617,249316,255982,255982,255982,267157,278332,289506,300681,300681,300681,300681,300681,300681,300681,300681,300681,311855,323030,359747,396463,396463,396463,396463,396463,396463,396463,396463,396463,396463,396463],
    caAssoc:[0,0,0,25542,63855,102168,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710,127710],
    caIndep:[0,0,0,12771,44699,95783,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,114939,140481,166023,166023,166023,166023,166023,166023,166023,166023,166023,166023,166023],
    caInterne:[0,0,0,0,0,0,0,0,0,0,11175,22349,33524,44699,44699,44699,44699,44699,44699,44699,44699,44699,55873,67048,78222,89397,89397,89397,89397,89397,89397,89397,89397,89397,89397,89397],
    caSage:[0,0,0,0,0,2667,6667,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333,13333],
    result:[0,-17000,-28942,-13755,11069,30233,50341,55758,58758,58758,66724,74691,64057,72023,71023,71023,71023,71023,70857,70440,70440,70440,78406,-13627,87675,106127,106127,106127,106127,106127,105794,105794,105794,105794,105794,5794],
    cashflow:[0,-17000,-45942,-59697,-48627,-18395,31947,87705,146463,205221,271945,346636,410692,482716,553739,624762,695785,766808,837666,908106,978546,1048986,1127393,1113765,1201440,1307568,1413695,1519822,1625949,1732077,1837871,1943665,2049460,2155254,2261048,2266842],
    treso1m:[0,0,0,0,0,-15098,10335,63676,122434,181192,239950,306675,1199115,1263172,1334195,1405218,1476242,1547265,1618122,1688562,1759002,1829442,1899883,1878289,3727941,3815616,3921743,4027870,4133998,4240125,4345919,4451714,4557508,4663302,4769096,4774891],
    treso3m:[0,-17000,-45942,-80534,-126801,-199235,-255632,-272529,-241097,-184755,-125997,-67239,-19115,36976,928416,991473,1062496,1133519,1204376,1274817,1345257,1415697,1486137,1456577,1517834,1587057,3436708,3524383,3630511,3736638,3842432,3948227,4054021,4159815,4265609,4271404],
    admin:[0,0,-8775,-22425,-35100,-44850,-52650,-52650,-52650,-52650,-52650,-52650,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-68250,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900,-81900],
    opex:[0,-17000,-20167,-24167,-26167,-45584,-45584,-45584,-45584,-45584,-45584,-45584,-48584,-48584,-49584,-49584,-49584,-49584,-49750,-50167,-50167,-50167,-50167,-150167,-53667,-53667,-53667,-53667,-53667,-53667,-54000,-54000,-54000,-54000,-54000,-154000],
    lab:[0,0,0,12000,15000,18000,21000,24000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000,27000],
    fteAssoc:[0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2],
    fteIndep:[0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3,3,3,3,3,3],
    fteInterne:[0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2],
    fteAdmin:[0,0,2,3,4,5,6,6,6,6,6,6,8,8,8,8,8,8,8,8,8,8,8,8,9,9,9,9,9,9,9,9,9,9,9,9],
    fteTotal:[0,0,1,3,6,8,10,11,11,11,11,11,13,13,13,13,13,13,13,13,13,13,14,14,16,17,17,17,17,17,17,17,17,17,17,17],
    consultDay:16,fee:225,daysYear:215,revSpec:923432,capex:523000
  };
}

async function logout() {
  try { await api('/auth/logout', { method: 'POST' }); } catch(e) {}
  currentUser = null;
  currentPlanId = null;
  allPlans = [];
  OVERLAY = null;
  overlayScenarioId = null;
  const badge = document.getElementById('user-badge');
  if (badge) badge.remove();
  document.getElementById('app-content').style.display = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  if (window.google && google.accounts) {
    google.accounts.id.renderButton(document.getElementById('google-btn'), {
      theme:'outline', size:'large', text:'signin_with', width:300, locale:'fr'
    });
  }
}

async function handleGoogleResponse(response) {
  try {
    const result = await api('/auth/google', {
      method: 'POST',
      body: JSON.stringify({ credential: response.credential }),
    });
    grantAccess(result.user);
  } catch(e) {
    console.error('Auth error:', e);
    const errEl = document.getElementById('auth-error');
    errEl.textContent = e.error || 'Erreur d\'authentification. Veuillez r\u00e9essayer.';
    errEl.style.display = 'block';
  }
}

// Init auth on page load
window.addEventListener('load', async function() {
  // Try existing session first
  if (await checkSession()) return;

  // Wait for Google Identity Services to load
  const initGoogle = setInterval(function() {
    if (window.google && google.accounts && google.accounts.id) {
      clearInterval(initGoogle);
      google.accounts.id.initialize({
        client_id: '219370646588-44317duqpi9ot2faf89vcc0k8lgs58f2.apps.googleusercontent.com',
        callback: handleGoogleResponse
      });
      google.accounts.id.renderButton(document.getElementById('google-btn'), {
        theme: 'outline',
        size: 'large',
        text: 'signin_with',
        width: 300,
        locale: 'fr'
      });
    }
  }, 100);
});
</script>

<!-- VERSION PANEL -->
<div class="version-overlay" id="versionOverlay" onclick="closeVersionPanel()"></div>
<div class="version-panel" id="versionPanel">
  <div class="vp-header">
    <h3>&#128338; Historique des versions</h3>
    <button class="vp-close" onclick="closeVersionPanel()">&times;</button>
  </div>
  <div class="vp-list" id="versionList">
    <div class="vp-empty">Chargement...</div>
  </div>
</div>

<!-- COMPARE MODAL -->
<div class="compare-modal" id="compareModal">
  <div class="compare-header">
    <h2>&#128200; Comparaison de versions</h2>
    <div style="display:flex;gap:.5rem">
      <button class="btn primary" onclick="printCompare()">&#128424; Exporter PDF</button>
      <button class="close-btn" onclick="closeCompare()">&times; Fermer</button>
    </div>
  </div>
  <div class="compare-selectors">
    <select id="compareLeft"></select>
    <span class="vs-label">vs.</span>
    <select id="compareRight"></select>
    <button class="btn primary" onclick="runCompare()">Comparer</button>
  </div>
  <div id="compareContent"></div>
  <div class="compare-charts">
    <div class="card"><h3>CA &amp; R&eacute;sultat par ann&eacute;e</h3><div class="chart-box"><canvas id="cCompareOverview"></canvas></div></div>
    <div class="card"><h3>Tr&eacute;sorerie 36 mois</h3><div class="chart-box"><canvas id="cCompareCashflow"></canvas></div></div>
  </div>
</div>

</div><!-- end #app-content -->

</body>
</html>
